---
title: "02_IMDP_FinalReport_Figures"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
fig_width: 8
---

```{r setup, include=FALSE}

  source("02_IMDP_Figure_Generator/utils/initialise_plots.R")

#What is the sheet name of the destination regions for the mussel fouled tracking sheet?
if(my.year != 2024){
  MF_tracker_sheet = "DestRegions"
}
if(my.year == 2024){
  MF_tracker_sheet = "Final List"
}

```




```{r load in data}

source(here::here("02_IMDP_Figure_Generator", "utils", "load_figure_data.R"))

```

```{r optional_pulling_out_boat_launches_from_comments}


source(here::here("02_IMDP_Figure_Generator", "utils", "getting_boat_launch_data.R"))
```



```{r change_station_names_and_establish_list_of_rovers}


source(here::here("02_IMDP_Figure_Generator", "utils", "station_manipulation.R"))
```


```{r numbers_for_exec_summary}

# this may not be needed- but run the script in isolation to get the tables and the associated values. Chris has relied on Metabase for these numbers so maybe just look there.


source(here::here("02_IMDP_Figure_Generator", "utils", "get_exec_summary.R"))
```

### Map 1. Inspection Stations by Type




```{r map1_plotting, fig.width=800}


source(here::here("02_IMDP_Figure_Generator", "utils", "get_basemaps.R"))

p1<-ggplot()+
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour)+
  geom_sf(data = st_buffer(stations_for_maps,20000), aes(fill = as.factor(station_type)))+
    geom_sf_label(data = station_labels, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(name = "2024 Watercraft \n Inspection Stations", 
                    values = c(
                      "Permanent Inspection Station" = "lightblue", 
                      "Roving Inspection Crew" = "purple",
                      "Part-time Inspection Station" = '#E8DE51'))+
  ggspatial::annotation_scale()+
  ggthemes::theme_map()+
  theme(legend.position = c(0.68,0.72),
        legend.background = element_rect(colour = 'black')
        )
  
p1

if(!interactive()) {
  # tmap_save(tm = map_1_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), p1, width = 7.6, height = 6.4, dpi = 300)
}
```


```{r optional_map_of_inspection_stations_for_current_year_of_operations}
# Usually, we are drafting the IMDP report for the previous year's season while the current year's season is active. We might need a map of the current year's stations.
if((my_opts$year+1) %in% unique(dat_all$Year)){
  
  p2<-ggplot()+
    tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour)+
    geom_sf(data = st_buffer(stations_for_maps_this_year,20000), aes(fill = as.factor(station_type)))+
        geom_sf_label(data = station_labels_this_year, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
    scale_fill_manual(name = "2025 Watercraft \n Inspection Stations", values = c("Permanent Inspection Station" = "lightblue", "Roving Inspection Crew" = "purple", "Part-time Inspection Station" = "yellow"))+
    ggspatial::annotation_scale()+
    ggthemes::theme_map()+
    theme(legend.position = c(0.68,0.75),
    )
  
  p2
  next.years.external.output.folder = str_remove(my.external.output.folder,"[0-9]+$")
  
  if(!dir.exists(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/'))){
    dir.create(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/'), recursive = T)
  }
    
  # tmap_save(tm = station_map_this_year_tmap, filename = paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), p2, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2. Total Inspections by Station

```{r map2_total_inspections_by_station}

source(here::here("02_IMDP_Figure_Generator", "utils", "dat_to_stations.R"))
p3 <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(data = stations_sf, 
          aes(color = station_type, 
              size = num_insp_b)) +
  geom_sf_label(data = station_labels, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_color_brewer(palette = "Dark2", name = "Station Type") +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(1, 5),
    breaks = unique(stations_sf$num_insp_b),
    labels = unique(stations_sf$bin_label)
  ) +
  ggspatial::annotation_scale() +
  ggthemes::theme_map() +
  guides(
    color = guide_legend(order = 1),
    size = guide_legend(order = 2)
  ) +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )
p3



if(!interactive()) {
# tmap_save(tm = map_2_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2_Total_Inspections_by_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
    ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2_Total_Inspections_by_Station.jpg'), p3, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2.b Total Inspections by Permanent Station

```{r map2b_total_inspections_by_permanent_station}

#data for this plot is found in utils/dat_to_stations.R


my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

p4 = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_ps_sf,
    aes(fill = factor(num_insp_b), size = log(num_insp_b)+1),
    shape = 21, color = "black"
  ) +
  geom_sf_label(data = station_labels |> filter(map_label %in% stations_ps_sf$map_label), aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(
    name = paste0(my.year, ' Inspections \nby Permanent Stations'),
    values = my_colors,
    labels = unique(stations_ps_sf$bin_label),
    breaks = unique(stations_ps_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_ps_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(3,7),
    breaks = unique(stations_ps_sf$num_insp_b),
    labels = unique(stations_ps_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

p4


if(!interactive()) {
# tmap_save(tm = map_2b_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2b_Total_Inspections_by_Permanent_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2b_Total_Inspections_by_Permanent_Station.jpg'), p4, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2.c Total Inspections by Roving Station

```{r map2c_total_inspections_by_roving_station}

my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

p5 = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_rs_sf,
    aes(fill = factor(num_insp_b), size = log(num_insp_b)+1),
    shape = 21, color = "black"
  ) +
  geom_sf_label(data = station_labels_roving, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(
    name = paste0(my.year, ' Inspections \nby Roving Crew'),
    values = my_colors,
    labels = unique(stations_rs_sf$bin_label),
    breaks = unique(stations_rs_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_rs_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(3,7),
    breaks = unique(stations_rs_sf$num_insp_b),
    labels = unique(stations_rs_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  coord_sf(xlim = c(-14201388, -12467185), ylim =c(6107624, 7058093)) +
  theme(
    legend.position = c(0.95, 0.99),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

p5

if(!interactive()) {
# tmap_save(tm = map_2c_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2c_Total_Inspections_by_Roving_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2c_Total_Inspections_by_Roving_Station.jpg'), p5, width = 7.6, height = 6.4, dpi = 300)
}
```

### Aside: Number of Shifts by Station
```{r}
# Number of shifts
dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  dplyr::select(Station, Shift_ID) |> 
  dplyr::distinct() |> 
  dplyr::count(Station, sort = T) |> 
  knitr::kable()
```

### Figure 3 Encounter Frequency by Station

```{r fig3_total_boats_by_station}



source(here::here("02_IMDP_Figure_Generator", "utils", "dat_for_charts_and_pies.R"))


p3 = fig3_data |>
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))+
scale_x_discrete(labels = c(
    "Douglas Crossing" = "Douglas"
  ))

p3

if(!interactive()) {
ggsave("Fig3_EncounterFrequency_HR.jpg",p3)
}
```

### Figure 3.b Encounter Frequency by Permanent Station

```{r fig3_total_boats_by_permanent_station}


# The code below creates a double-Y-axis figure with encounter frequency (watercraft encounters divided by effort)
# on the left Y axis.

p3_b = fig3b_data |>
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3_b

if(!interactive()) {
ggsave("Fig3b_EncounterFrequency_HR_PermanentStations.jpg",p3_b)
}
```

### Figure 3.c Encounter Frequency by Roving Station

```{r fig3_total_boats_by_roving_station}


# The code below creates a double-Y-axis figure with encounter frequency (watercraft encounters divided by effort)
# on the left Y axis.

p3_c = fig3c_data |>
  mutate(StationLabel = str_remove(StationLabel, "\\*$")) |> 
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3_c

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig3b_EncounterFrequency_HR_RovingStations.jpg"),
       p3_c,
       height = 4, width = 8)
}
```

### Figure 3.x Total Inspections by Station

```{r}

# These are made in dat_for_charts_and_pies
p3.x 

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0("Fig3x_TotalInspections_",my.year-2,"_to_",my.year,"_All_Stations.jpg"),p3.x)
}
```

### Figure 3.x_b Total Inspections by Permanent Station

```{r}
# These are made in dat_for_charts_and_pies
p3.x_b

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0("Fig3x_b_TotalInspections_",my.year-2,"_to_",my.year,"_Permanent_Stations.jpg"),p3.x_b)
}
```

### Figure 3.x_c Total Inspections by Roving Station

```{r}


p3.x_c

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig3x_c_TotalInspections_",my.year-2,"_to_",my.year,"_Roving_Stations.jpg"),p3.x_c)
}
```

### Figure 4 Total Number of Jurisdictions

```{r fig4_total_number_jurisdictions}


p4

if(!interactive()) {
ggsave("Fig4_Total_Jurisdictions_by_Station.jpg",p4)
}
```

### Figure 5 Number of Inspections and Total Effort by month

```{r fig5_total_inspections_and_total_effort_by_month}


p5

if(!interactive()) {
ggsave("Fig5_NumberInspections_and_TotalEffort_month.jpg",p5)
}
```

### Figure 6 Encounter Frequency by Month

```{r fig6_EncounterFrequency_by_month}


p6

if(!interactive()) {
ggsave("Fig6_EncounterFrequency_by_month.jpg",p6)
}
```

### Figure 7 Total Inspections and Total Effort by Day of Week

```{r fig7_total_inspections_and_total_effort_by_day_of_week}


p7

if(!interactive()) {
ggsave("Fig7_NumberInspections_and_TotalEffort_day.jpg",p7)
}
```

### Figure 8 Encounter Frequency by day of week

```{r fig8_Encounter_Frequency_by_day_of_week}
#This one requires grouping the data by the week number in the year (i.e. 1,2, 3 ... up to 54) and the day of the week to first calculate the standard error within each day of the week (which is the eventual grouping factor for the figure), then summarise by day of the week the calculate mean frequency.


p8

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig8_EncounterFrequency_day_of_week.jpg"),p8)
}
```

### Figure 9 Total Inspections by Time of Day

```{r fig9_total_inspections_by_time_of_day}


p9

if(!interactive()) {
ggsave("Fig9_NumberInspections_hour_of_day.jpg",p9)
}
```

### Figure 9. Part 2 High-Risk Inspections by Time of Day

```{r fig9_HR_inspections_by_time_of_day}


p9.2

if(!interactive()) {
ggsave("Fig9_Part2_Number_Highrisk_Inspections_hour_of_day.jpg",p9.2)
}
```

### Figure 9. Part 3 Total Inspections by Time of Day for Golden Station

```{r fig9_Golden_inspections_by_time_of_day}


p9.3

cat("\nNumber of Golden inspections between 10 PM and 6 AM")

dat |> 
  filter(Station == "Golden") |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  dplyr::filter(the.hour >= 22 | the.hour <= 6) |> 
  dplyr::summarise(night_inspections = sum(Number_Insp))

if(!interactive()) {
ggsave("Fig9_Part3_Number_Inspections_Golden_hour_of_day.jpg",p9.3)
}
```

### Figure 9. Part 4 High-Risk Inspections by Time of Day for Golden Station

```{r fig9_HR_Golden_inspections_by_time_of_day}


p9.4

if(!interactive()) {
ggsave("Fig9_Part4_Number_Highrisk_Inspections_Golden_hour_of_day.jpg",p9.4)
}
```

### Figure 11 Destination Waterbodies with Percent

```{r fig11_Destination_Waterbodies_with_percent}

p11

if(!interactive()) {
ggsave("Fig11_DestinationWaterbody_Percent_Inspections.jpg",p11)
}
```

### Map 3: Home Residence of Boats

```{r map2_home_residence_of_boats}



source(here::here("02_IMDP_Figure_Generator", "utils", "boat_residence.R"))
my_colors <- RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]
#northamerica_view_bbox <- sf::st_bbox(northamerica_view)


legend_sizes <- centr_with_dat |>
  group_by(TotalInsp_b) |>
  summarise(size = log(mean(TotalInsp, na.rm = TRUE) + 1)) |>
  arrange(TotalInsp_b) |>
  pull(size)

bounds <- st_bbox(centr_with_dat)
bounds["xmin"] <- bounds["xmin"] - 4
bounds["xmax"] <- bounds["xmax"] + 4
bounds["ymin"] <- bounds["ymin"] - 4
bounds["ymax"] <- bounds["ymax"] + 4

bounds_sfc <- st_as_sfc(bounds)
bounds_sfc <- st_transform(bounds_sfc, st_crs(north_america_stations_basemap_colour))

bounds_vect <- terra::vect(bounds_sfc)

basemap_cropped <- terra::crop(north_america_stations_basemap_colour, bounds_vect)

home_res_plot<-ggplot() +
  tidyterra::geom_spatraster_rgb(data = basemap_cropped) +
  coord_sf(
    xlim = c(bounds$xmin, bounds$xmax),
    ylim = c(bounds$ymin, bounds$ymax),
    expand = FALSE
  ) +
  geom_sf_text(
    data = centr_without_dat,
    aes(label = ABBR),
    size = 2.5,
    color = "grey50",
    check_overlap = TRUE
  ) +
  geom_sf(
    data = centr_without_dat,
    shape = 21,
    size = 1,
    fill = "grey90",
    color = "grey70"
  ) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = factor(TotalInsp_b), size = TotalInsp),
    shape = 21,
    color = "black"
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR),
    size = 2.5,
    check_overlap = TRUE
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Home Residence\nFrequency"),
    values = my_colors,
    labels = unique(centr_with_dat$bin_label),
    breaks = unique(centr_with_dat$TotalInsp_b),
    guide = guide_legend(
      order = 1,
      override.aes = list(size = legend_sizes)
    )
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.05, 0.05),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(
      fill = alpha("white", 0.9),
      color = "black",
      linetype = "solid"
    )
  )

home_res_plot



if(!interactive()) {
# tmap_save(tm = map_3_tmap, filename = 'Map3_Home_Residence_Frequency.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Map3_Home_Residence_Frequency.jpg"),
         plot = home_res_plot,
         width = 7.6, height = 6.4, dpi = 300)
}
```

### Optional Figure: Total and High-risk Inspections at Boat Launches

```{r}

source(here::here("02_IMDP_Figure_Generator", "utils", "boat_launch_again.R"))

boatlaunch_dat_count = boatlaunch_dat_count |> 
  group_by(likely_lake) |> 
  mutate(ypos = sum(n))

boatlaunch_dat_count$High_Risk_AIS_Ind <- factor(boatlaunch_dat_count$High_Risk_AIS_Ind, levels = c("TRUE", "FALSE"))

fig_boat_launches <- ggplot(boatlaunch_dat_count) + 
  geom_col(
    aes(
      x = reorder(likely_lake, -n),
      y = n, 
      fill = Station,
      color = as.factor(High_Risk_AIS_Ind),   # outline color
      size = High_Risk_AIS_Ind     # outline thickness
    ),
   # position = position_dodge(width = 0.9),
    width = 0.8
  ) +
  geom_text(
  data = boatlaunch_dat_count |> filter(High_Risk_AIS_Ind == TRUE),
  aes(
    x = reorder(likely_lake, -n),
    y = ypos +1,       # push label above bar top by 2 units
    label = paste0("High Risk: ", n)
  ),
  vjust = 0,         # anchor bottom of text at this height
)+
  scale_color_manual(
    values = c("FALSE" = "grey40", "TRUE" = "red"),
    labels = c("No", "Yes")
  ) +
  scale_size_manual(
    values = c("FALSE" = 0.3, "TRUE" = 1.2),
    guide = "none"     # hide size legend
  ) +
  scale_fill_brewer(palette = 'Set2') +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1),
    legend.position = "None",
    legend.box = "vertical",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  ) + 
  labs(
    y = "Number of Inspections",
    x = NULL,
    fill = "Boat Launch",
    color = "High Risk Inspection"
  )

fig_boat_launches

if(!interactive()) {
# tmap_save(tm = map_3_tmap, filename = 'Map3_Home_Residence_Frequency.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig_boat_launches_risk.jpg"),
         plot = fig_boat_launches,
         width = 7.6, height = 6.4, dpi = 300)
}
```

### Brief Aside: Roving Stations whose location is unknown (not boat launch nor scheduled inspection)
```{r}
boatlaunch_dat |> 
  dplyr::select(Station,TimeOfInspection,High_Risk_AIS_Ind,Shift_Start_Comment,likely_lake) |> 
  dplyr::filter(is.na(likely_lake)) |> 
  dplyr::select(Station,Shift_Start_Comment) |> 
  knitr::kable()
```

### Brief Aside: Breakdown of High-risk / Low-risk for Scheduled Inspections
```{r}
# Look at 'scheduled inspection' records
dat |> 
  filter(str_detect(Station,"^Scheduled")) |> 
  count(Station,High_Risk_AIS_Ind, name = 'Number of Inspections') |> 
  knitr::kable()


### ADJUST THIS TO ALSO LOOK IN THE COMMENT FIELD FOR 'SCHEDULED' ETC.
```

### Figure 12 Percent Compliance by station

```{r fig12_percent_compliance_by_station}


source(here::here("02_IMDP_Figure_Generator", "utils", "compliance_dat.R"))

p12

if(!interactive()) {
ggsave("Fig12_PercentCompliance_Station.jpg",p12)
}
```

```{r total_compliance_not_by_station}


source(here::here("02_IMDP_Figure_Generator", "utils", "compliance_total_data.R"))
```

### Blowbys By Hour
```{r}


source(here::here("02_IMDP_Figure_Generator", "utils", "blowbys_by_hour.R"))

blowby_by_hour_plot = ggplot() +
  geom_col(data = blowb_by_hour, aes(x = the_hour, y = `Number of Blowbys`)) + 
  labs(fill = "Overnight\nInspection\n(21:00 to 5:59)", x = "Hour of Day") +
  scale_x_continuous(limits = c(0 , 24), breaks = seq(0,23,1))+
  theme_classic()
blowby_by_hour_plot

ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/blowbys_by_hour.jpg"),
       plot = blowby_by_hour_plot,
       height = 4, width = 8)
```

### Figure 13 Noncompliant Watercraft Breakdown
```{r fig13_noncompliant_breakdown}


source(here::here("02_IMDP_Figure_Generator", "utils", "plot_charts_and_pies_2.R"))

p13

if(!interactive()) {
ggsave("Fig13_Percent_Blowbys_Station.jpg",p13)
}
```

### Figure 14 Percent Watercraft Inspected with Previous Inspection

```{r fig14_percent_watercraft_insp_with_prev_insp}


if(interactive()){
  # For inspections that were previously inspected prior, calculate the % 
  # per each grouping of time (e.g. )
  dat |> 
  filter(!Station %in% c("Scheduled Inspection",
                         "Okanagan",
                         "Other", "Penticton Roving"))
}

p14

if(!interactive()) {
ggsave("Fig14_Percent_Intercepted_with_Prev_Insp.jpg",p14)
}
```

### Figure 15 Frequency of Previously Inspected Watercraft's Inspections

```{r fig15_prev_insp_watercraft_insp_time}


p15 

cat("\nDate Bins for all inspection data from this year:")

# Drop the station grouping level; get these stats across all stations.
dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  filter(Previous_Inspection_Ind == T) |> 
  filter(!is.na(Previous_Inspection_Days_Count)) |> 
  mutate(previnsp = case_when(
    Previous_Inspection_Days_Count %in% c('0','Same day') ~ 'Same Day',
    Previous_Inspection_Days_Count %in% c('30','60','180') ~ '> 30 Days',
    Previous_Inspection_Days_Count %in% c('< 30 days','<30 days') ~ '< 30 Days',
    Previous_Inspection_Days_Count == '> 30 days' ~ '> 30 Days',
    Previous_Inspection_Days_Count == '> 1 year' ~ '> 1 Year',
    T ~ NA
  )) |> 
  select(previnsp) |> 
  count(previnsp, name = 'NumberInsp') |>
  # group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
    mutate(prop = 100*NumberInsp / TotalInsp) |> 
  knitr::kable()

if(!interactive()) {
ggsave("Fig15_Percent_PreviouslyInspected_Date_Bins.jpg",p15)
}
```

### Figure of Pull the Plug Compliance
```{r}


pl_of_plugs

if(!interactive()) {
  ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig_of_Pull_the_Plug_Compliance.jpg"),
         plot = pl_of_plugs,
         width = 8, height = 4)
}
```

### Figure 16 Total High-risk Inspections over 3 years

```{r fig16_total_HR_insp_3_years}


p16

if(!interactive()) {
ggsave("Fig16_Total_HR_Inspections_3_year_spread.jpg",p16)
}
```

### Map 4. High-risk Inspections by Station

```{r fig17_map4_high_risk_insp_by_station}



source(here::here("02_IMDP_Figure_Generator", "utils", "high_risk_by_station.R"))

print("High-risk inspections by Station")
  
stations_sf |> st_drop_geometry() |> dplyr::select(station_name, num_insp) |> 
  arrange(desc(num_insp)) |> 
  knitr::kable()
# }


my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = st$num_insp_b,
  reverse = T
)

station_labels = adjust_station_labels(stations_for_maps ,offsets)

my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

map_high_risk_ggplot = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_sf,
    aes(fill = factor(num_insp_b), size = num_insp_b),
    shape = 21,
    color = "black"
  ) +
  geom_sf_label(
  data = dplyr::filter(station_labels, map_label %in% stations_sf$map_label),
  aes(label = map_label),
  size = 3,
  fill = "white",
  color = "black",
  label.size = 0.1
)+
  scale_fill_manual(
    name = paste0(my.year, ' High Risk \nInspections'),
    values = my_colors,
    labels = unique(stations_sf$bin_label),
    breaks = unique(stations_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    breaks = unique(stations_sf$num_insp_b),
    labels = unique(stations_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

map_high_risk_ggplot


if(!interactive()) {
# tmap_save(tm = map_4_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map4_HighRisk_Inspections_by_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
ggsave(filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map4_HighRisk_Inspections_by_Station.jpg'), 
       plot = map_high_risk_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

```{r high_risk_number_summaries}
# if(interactive()){
  # Get number of inspections coming from a high-risk area.
print("High-risk inspections from high-risk areas or not:")

dat_hr |> 
  filter(Year == my.year) |> 
  count(High_Risk_Area_Ind) |> 
  knitr::kable()

print("All inspections this year from high-risk areas or not:")
dat |> 
  dplyr::filter(High_Risk_Area_Ind == T,
                High_Risk_AIS_Ind == F) |> 
  count(Previous_Waterbody_1_Province_Or_State,
        High_Risk_AIS_Ind,
        High_Risk_Area_Ind) |> 
  knitr::kable()
# }
print(paste0("Besides Alberta, there were this many inspections that were not HR for mussels but were HR for whirling disease: ",(nrow(dat |> 
  dplyr::filter(High_Risk_Area_Ind == T,
                High_Risk_AIS_Ind == F,
                Previous_Waterbody_1_Province_Or_State != "AB"))))
)

# if(interactive()){
print('Number of high-risk inspections that had been previously inspected')

dat_hr |> 
  filter(Year == my.year) |> 
  count(Previous_Inspection_Ind) |> 
  mutate(prop = 100*n/sum(n)) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Decontamination_Performed_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Decontamination_order_issued_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Quarantine_Period_Issued_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(High_Risk_AIS_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(High_Risk_Area_Ind) |> 
  knitr::kable()

dat |> 
  dplyr::filter(!Watercraft_Risk_Assessment_ID %in% dat_hr$Watercraft_Risk_Assessment_ID) |> 
  dplyr::count(High_Risk_Area_Ind)

dat |> 
  dplyr::filter(Watercraft_Risk_Assessment_ID %in% dat_hr$Watercraft_Risk_Assessment_ID) |> 
  dplyr::count(Previous_Inspection_Ind)
  
# }
```

### Figure 18 Source Locations of High-Risk Inspections

```{r fig18_pie_chart_source_locations_HR_Insp}

# If interactive, show number of high-risk inspections by station as table.
# if(interactive()){
print("HR inspections source state/prov")

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Previous_Waterbody_1_Province_Or_State) |> 
  arrange(desc(n)) |> 
  dplyr::mutate(proportion = 100*(n / sum(n))) |> 
  as.data.frame() |> 
  left_join(state_longnames |> dplyr::rename(Previous_Waterbody_1_Province_Or_State = abbr)) |> 
  knitr::kable()
# }



p18 

if(!interactive()) {
ggsave("Fig18_Inspection_Source_Pie_Charts.jpg",p18)
}
```

### Figure 19 Destination Regions of High-Risk Inspections

```{r fig19_pie_chart_destination_locations_HR_Insp}
#Quick aside - Martina wants to know how many of the HR inspections that have "Unknown" recorded in the DestRegion field also have the Source_wb_prov_unknown field toggled as T.



p19

if(!interactive()) {
  ggsave("Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19,height=5)
}

# getwd()

# ggsave("02_IMDP_Figure_Generator/output/Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19)
```

### Map 5. Home Residence Frequency of High-risk Inspections

```{r map_5_home_residence_freq_high_risk}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(HRInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HRInsp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(HRInsp_b = case_when(
    HRInsp <= jenks_2 ~ 1,
    HRInsp <= jenks_3 ~ 2,
    HRInsp <= jenks_4 ~ 3,
    HRInsp <= jenks_5 ~ 4,
    HRInsp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    HRInsp_b == 1 ~ paste0('1 - ',jenks_2),
    HRInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HRInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HRInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HRInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  # mutate(HRInsp_b = factor(HRInsp_b, levels = c(1:5))) |> 
  arrange(HRInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(HRInsp)))

source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$HRInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(HRInsp))
centr_without_dat = sources_centroid |> filter(is.na(HRInsp))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(HRInsp_b))


# Make a version of centr_with_dat that is slightly offset;
# this might help to have text labels not on top of circles.
centr_offset = centr_with_dat |> 
  dplyr::mutate(lat = sf::st_coordinates(geom)[,2],
                lng = sf::st_coordinates(geom)[,1]) |> 
  dplyr::mutate(lat = lat - 1,
                lng = lng - 1) |> 
  sf::st_drop_geometry() |> 
  sf::st_as_sf(coords = c("lng","lat"), crs = 4326)



bounds <- st_bbox(centr_with_dat)
bounds["xmin"] <- bounds["xmin"] - 8
bounds["xmax"] <- bounds["xmax"] + 8
bounds["ymin"] <- bounds["ymin"] - 8
bounds["ymax"] <- bounds["ymax"] + 8

bounds_sfc <- st_as_sfc(bounds)
bounds_sfc <- st_transform(bounds_sfc, st_crs(north_america_stations_basemap_colour))

bounds_vect <- terra::vect(bounds_sfc)

basemap_cropped <- terra::crop(north_america_stations_basemap_colour, bounds_vect)



map_home_res_high_risk_ggplot = ggplot() +
  tidyterra::geom_spatraster_rgb(data = basemap_cropped) +
  coord_sf(
    xlim = c(bounds_sfc$xmin, bounds_sfc$xmax),
    ylim = c(bounds_sfc$ymin, bounds_sfc$ymax),
    expand = FALSE
  ) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = factor(HRInsp_b), size = HRInsp_b),
    shape = 21,
    color = "black"
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR),
    size = 2.5,
    check_overlap = TRUE
  ) +
  scale_fill_manual(
    name = paste0(my.year, ' Source of \nHigh Risk Inspections'),
    values = unique(centr_with_dat$my_colors),
    labels = unique(centr_with_dat$bin_label),
    breaks = unique(centr_with_dat$HRInsp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(centr_with_dat$HRInsp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    breaks = unique(centr_with_dat$HRInsp_b),
    labels = unique(centr_with_dat$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
  plot.margin = margin(0, 0, 0, 0),  # top, right, bottom, left
  #plot.margin = margin(10, 80, 10, 10), # top, right, bottom, left
  legend.position = c(0.97, 0.03),
  legend.justification = c("right", "bottom")
)

map_home_res_high_risk_ggplot


if(!interactive()) {
# tmap_save(tm = map_5_tmap, filename = paste0(my.external.output.folder, '/GIS Maps and Excel Figures/ExcelFigures/Map5_Home_Residence_Frequency_HighRisk_2.jpg'), width = 7.6, height = 6.4, dpi = 300)

  ggsave(filename = paste0(my.external.output.folder, '/GIS Maps and Excel Figures/ExcelFigures/Map5_Home_Residence_Frequency_HighRisk_2.jpg'), 
       plot = map_home_res_high_risk_ggplot, width = 7.6, height = 6.4, dpi = 300)
  
}
```

### Map 6. Destination locations of High Risk Inspections

```{r dest_location_high_risk_inspections}
dest_wb = read_sf(paste0('W:/CMadsen/Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Waterbodies_with_Inspection_Data_Summaries_',my.year,'.gpkg')) |> 
  st_transform(crs = 4326)

dest_wb_hr = dest_wb |> 
  mutate(HighRisk = HR_mot + HR_nonmot) |> 
  filter(HighRisk > 0)

# We're going to lose the geometry of this table in the next step.
# Save it to be reattached later!
# dest_wb_hr$geom

# Get 5 (or fewer, if data demands) levels of natural breaks ('jenks'); colour of waterbodies depends on these bins.
dest_wb_hr = dest_wb_hr |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HighRisk, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(HighRisk_b = case_when(
    HighRisk <= jenks_2 ~ 1,
    HighRisk <= jenks_3 ~ 2,
    HighRisk <= jenks_4 ~ 3,
    HighRisk <= jenks_5 ~ 4,
    HighRisk <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    HighRisk_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    HighRisk_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HighRisk_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HighRisk_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HighRisk_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(HighRisk_b) |> 
  dplyr::mutate(bin_label = str_replace(bin_label,"1 - 1","1"))

my_pal = leaflet::colorFactor(
  palette = 'RdYlGn',
  domain = dest_wb_hr$HighRisk_b,
  reverse = T
)

labels = unique(dest_wb_hr$bin_label)

dest_wb_hr = st_set_geometry(dest_wb_hr, dest_wb_hr$geom)

# Remove labels for all waterbodies below a 'yellow' level of HR inspections.
dest_wb_hr = dest_wb_hr |>
  mutate(GNIS_NA_label = ifelse(as.numeric(HighRisk_b) >= 3 | GNIS_NA %in% c("Elk River","Kootenay Lake"), GNIS_NA, NA))

# Buffer the destination waterbodies a bit.
dest_wb_hr = st_buffer(dest_wb_hr, 500)

# Add in counts for each of the bins.
# bin_label_w_count = dest_wb_hr |> 
#   sf::st_drop_geometry() |> 
#   dplyr::count(bin_label) |> 
#   dplyr::mutate(bin_label_w_count = paste0(bin_label, " (",n,")")) |> 
#   dplyr::select(-n)

# dest_wb_hr = dest_wb_hr |> 
#   dplyr::left_join(bin_label_w_count)

# Which bins are composed of a single lake?
single_member_bins = dest_wb_hr |> 
  sf::st_drop_geometry() |> 
  dplyr::count(bin_label) |> 
  dplyr::filter(n == 1) |> 
  dplyr::pull(bin_label)

# Add word 'watercraft' to bin labels

dest_wb_hr = dest_wb_hr |> 
  dplyr::mutate(bin_label_precise = case_when(
    bin_label %in% single_member_bins ~ as.character(highrisk_Counter),
    T ~ bin_label
  )) |> 
  dplyr::mutate(bin_label_precise = paste0(bin_label_precise,' watercraft'))

# Calculate the centroid for each waterbody, add a dot there.
dest_wb_hr_centr = sf::st_centroid(dest_wb_hr)

# Make palette
Breaks <- unique(c(dest_wb_hr$jenks_1,dest_wb_hr$jenks_2,dest_wb_hr$jenks_3,dest_wb_hr$jenks_4,dest_wb_hr$jenks_5))
Labels <- unique(dest_wb_hr$bin_label_precise)
MyPalette <- c("#4e92e6", "#26e0ce","gold","orange","darkred")

bc_station_view_pushed_north = bc_station_view
bc_station_view_pushed_north[4] = 57

raster_bbox <- terra::ext(bc_stations_basemap_colour)
raster_bbox_df <- data.frame(
  xmin = raster_bbox[1],
  xmax = raster_bbox[2],
  ymin = raster_bbox[3],
  ymax = raster_bbox[4]
)


map_6_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_white) +
  geom_sf(data = bc_bound, color = "grey", fill = NA, linewidth = 1) +
  geom_sf(data = dest_wb_hr, aes(fill = bin_label_precise), color = NA) +
  geom_sf(data = dest_wb_hr_centr,
          shape = 21, size = 3, color = "black", stroke = 0.2, aes(fill = bin_label_precise), show.legend = FALSE) +
  geom_sf_text(data = dest_wb_hr, aes(label = GNIS_NA_label),
               color = "black", size = 3, vjust = 1) +
  scale_fill_manual(name = paste0(my.year, " High Risk\nDestination Waterbodies"),
                    values = MyPalette) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black",
      linetype = "solid"
    ),
    legend.key = element_blank()
  ) +
  coord_sf(
    xlim = c(raster_bbox_df$xmin, raster_bbox_df$xmax),
    ylim = c(raster_bbox_df$ymin, raster_bbox_df$ymax),
    expand = FALSE
  )

map_6_ggplot

if(!interactive()) {
# tmap_save(tm = map_6_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map6_Destination_locations_HighRisk.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map6_Destination_locations_HighRisk.jpg'), map_6_ggplot,  width = 7.6, height = 6.4, dpi = 300)
}
# 
# tmap_save(tm = map_6_tmap, filename = 'Map6_Destination_locations_HighRisk.jpg', width = 7.6, height = 6.4, dpi = 300)
```

### Figure 22 Pie Chart of Total Watercraft Types

```{r fig22_pie_chart_total_watercraft_types}
p22 = dat |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  # mutate(value = replace(value, value > 1, 1)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  mutate(TotalBoats = sum(NumberBoats)) |>
  mutate(PercBoats = 100*NumberBoats/TotalBoats) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) |> 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49,
                      label = paste0(name,"\n",round(PercBoats,1),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p22

if(!interactive()) {
ggsave("Fig22_Total_Watercraft_Type_Pie_Chart.jpg",p22)
}
```

### Figure 23 Pie Chart of High-Risk Watercraft Types

```{r fig23_pie_chart_HR_watercraft_types}
p23 = dat_hr |> 
  filter(Year == my.year) |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  # mutate(value = replace(value, value > 1, 1)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  mutate(TotalBoats = sum(NumberBoats)) |> 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) |> 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x=1.49, label = paste0(name,"\n",round(PercBoats,1),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p23

if(!interactive()) {
ggsave("Fig23_Highrisk_Watercraft_Type_Pie_Chart.jpg",p23)
}
```


### Figure 24 Mussel-fouled By Month 5 Years
```{r fig24_musselfouled_by_month_all_years}
#If an excel sheet can be found in the Final Report > my.year > GIS Maps and Excel Figures folder, use that. We make this excel sheet automatically below, and it can be updated by hand after its creation.

if(file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
  mf_time_table = read_excel(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

#If that file does not yet exist...
if(!file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
#Read in the hand-cleaned excel sheet from 2020 report, and add more recent data to it.
mf_time_table = read_excel("J:/2 SCIENCE - Invasives/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/2020/GIS Maps and Excel Figures/ExcelFigureData/2019_Fig24_MusselFouled_byMonth_2017-2020.xlsx",sheet = "dat_for_R")

#Add my.year (and any intervening years between 2020 and my.year, if there are any)'s mf data to the excel sheet.
mf_time_table = mf_time_table |> 
  bind_rows(dat_mf |> 
              mutate(Month = month(TimeOfInspection, label = T, abbr = F)) |> 
              filter(Year %in% 2021:my.year) |> 
              group_by(Year,Month) |> 
              summarise(Number = n()) |> 
              pivot_wider(names_from = Month, values_from = Number)) |> 
  mutate(across(c(April:November), ~ replace_na(.x, 0))) |> 
  ungroup() |> 
  mutate(Total = (April+May+June+July+August+September+October+November))

#Save the excel file in my.year's folder.
write.xlsx(mf_time_table, paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

p24 = mf_time_table |> 
  pivot_longer(-Year) |> 
  filter(name != "Total") |> 
  dplyr::filter(name != "November") |> 
  filter(Year > my.year-5) |> 
  rename(Month = name) |> 
  mutate(NumberBoats = as.numeric(value),
         Month = factor(Month,levels = c("April","May","June","July","August","September","October","November"))) |> 
  mutate(Year = factor(Year, levels = c(2015:my.year))) |> 
  ggplot() + 
  geom_col(aes(x = Month, y=NumberBoats, fill=Year), col="black", position=position_dodge2(width = 0.5, preserve = "single")) + 
  scale_fill_brewer(palette = "Dark2") + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) + 
  labs(x = "", y = "Mussel Fouled Boats")

p24

if(!interactive()) {
ggsave("Fig24_Musselfouled_by_Month.jpg",p24)
}
```

### Figure 25 Source Provinces / States for Mussel-fouled Boats
```{r fig25_source_province_states_for_musselfouled}
# p25 = dat_mf |>
#   filter(Year == my.year) |>
#   rename(prev = Previous_Waterbody_1_Province_Or_State) |>
#   group_by(prev) |>
#   summarise(NumberBoats = n()) |>
#   left_join(abbrev |> rename(prev = Abbrev)) |>
#   arrange(desc(prev)) |>
#   mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |> 
#   ggplot(aes(x = "", y = NumberBoats, 
#            fill = Province_or_State)) +
#   geom_bar(width = 1, stat = "identity", color = "white") +
#   coord_polar("y", start = 0)+
#   geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Province_or_State,", ",NumberBoats)), 
#             color = "black",nudge_x=0.7)+
#   theme_void() + 
#   labs(fill = "Destination Region") + 
#   theme(legend.position = "none")

# Sadly, this piece must be updated by hand each year. Ultimately,
# the mussel-fouled data is too tricky to work in, since we 
# keep a hand-tracked excel sheet that changes frequently...
if(my.year == 2022){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Manitoba","Quebec")),
       NumberBoats = c(11,1,1))
}
if(my.year == 2023){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Nevada","Michigan","Manitoba","South Carolina")),
       NumberBoats = c(10,1,1,1,1))
}
if(my.year == 2024){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Utah","Arizona","Michigan","Manitoba","Quebec")),
       NumberBoats = c(4,1,2,2,2,1))
}
p25 = p25_dat |>
  arrange(desc(Province_or_State)) |> 
  # mutate(Province_or_State = forcats::fct_rev(Province_or_State)) |> 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |>
  ggplot(aes(x = "", y = NumberBoats,
           fill = Province_or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.65, label = paste0(Province_or_State,", ",NumberBoats)),
            color = "black",nudge_x=0)+
  theme_void() +
  labs(fill = "Destination Region") +
  theme(legend.position = "none")

p25

if(!interactive()) {
ggsave("Fig25_MusselFouled_Source_Regions_Pie_Charts.jpg",p25)
}
```

### Figure 26 Destination Regions of Mussel-fouled Inspections

```{r fig26_pie_chart_destination_locations_MF_Insp}
# As above, this one needs to be updated by hand each year...

# fig26dat = read_excel(MusselFouledTracker,
#                       sheet = MF_tracker_sheet)
# 
# p26 = fig26dat |> 
#   group_by(Region) |> 
#   reframe(Number = sum(Number)) |> 
#   arrange(desc(Region)) |> 
#   mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
#   ggplot(aes(x = "", y = Number, 
#            fill = Region)) +
#   geom_bar(width = 1, stat = "identity", color = "white") +
#   coord_polar("y", start = 0)+
#   geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.2)+
#   theme_void() + 
#   scale_fill_brewer(palette = "Dark2") + 
#   labs(fill = "Destination Region") +
#   theme(legend.position = "none")

if(my.year == 2022){
  p26 = tibble(Region = factor(c("Lower \nMainland","Okanagan","Vancouver \nIsland",'Thompson \nNicola')),
               Number = c(5,4,2,2)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
if(my.year == 2023){
    p26 = tibble(Region = factor(c("Lower \nMainland",
                                   "Thompson-Okanagan",
                                   "Peace",
                                   'Kootenay-Boundary')),
               Number = c(4,8,1,1)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
if(my.year == 2024){
    p26 = tibble(Region = factor(c("Thompson-Okanagan",
                                   "Lower Mainland",
                                   "Omineca",
                                   'Kootenay-Boundary')),
               Number = c(4,6,1,1)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
p26

if(!interactive()) {
ggsave("Fig26_MusselFouled_Destination_Regions_Pie_Charts.jpg",p26)
}
```

### Map 7. Source Location of Mussel-fouled Watercraft

```{r source_for_mussel_fouled}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(MFInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(MFInsp, k = 4))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(MFInsp_b = case_when(
    MFInsp <= jenks_2 ~ 1,
    MFInsp <= jenks_3 ~ 2,
    MFInsp <= jenks_4 ~ 3
  )) |>
  mutate(bin_label = case_when(
    MFInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    MFInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    MFInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4)
  )) |> 
  # mutate(MFInsp_b = factor(MFInsp_b, levels = c(1:3))) |> 
  arrange(MFInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(MFInsp))) |> 
  # And remove the row for BC.
  filter(NAME_1 != 'British Columbia')

source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$MFInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(MFInsp_b))
centr_without_dat = sources_centroid |> filter(is.na(MFInsp_b))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(MFInsp_b))

# Make a version of centr_with_dat that is slightly offset;
# this might help to have text labels not on top of circles.
centr_offset = centr_with_dat |> 
  dplyr::mutate(lat = sf::st_coordinates(geom)[,2],
                lng = sf::st_coordinates(geom)[,1]) |> 
  dplyr::mutate(lat = lat - 1,
                lng = lng - 1) |> 
  sf::st_drop_geometry() |> 
  sf::st_as_sf(coords = c("lng","lat"), crs = 4326)

legend_df <- centr_with_dat |>
  sf::st_drop_geometry() |>
  dplyr::select(bin_label, my_colors, MFInsp_b) |>
  distinct()

bounds <- st_bbox(centr_with_dat)
bounds["xmin"] <- bounds["xmin"] - 18
bounds["xmax"] <- bounds["xmax"] + 8
bounds["ymin"] <- bounds["ymin"] - 8
bounds["ymax"] <- bounds["ymax"] + 8

bounds_sfc <- st_as_sfc(bounds)
bounds_sfc <- st_transform(bounds_sfc, st_crs(north_america_stations_basemap_colour))

bounds_vect <- terra::vect(bounds_sfc)

basemap_cropped <- terra::crop(north_america_stations_basemap_colour, bounds_vect)


map_7_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = basemap_cropped) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = bin_label, size = MFInsp_b),
    shape = 21,
    color = "black",
    stroke = 0.2
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR, color = map_label_colour),
    size = 3
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Source of\nMussel-Fouled Inspections"),
    values = setNames(legend_df$my_colors, legend_df$bin_label),
    guide = guide_legend(
      override.aes = list(
        shape = 21,
        fill = legend_df$my_colors,
        size = log(legend_df$MFInsp_b + 1)+1
      )
    )
  ) +
  scale_size_continuous(range = c(2, 6), guide = "none") +
  scale_color_identity() +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )

map_7_ggplot
if(!interactive()) {
# tmap_save(tm = map_7_tmap, filename = 'Map7_Home_Residence_Frequency_MusselFouled.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = 'Map7_Home_Residence_Frequency_MusselFouled.jpg', map_7_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

### Figure 28 Pie Chart of Mussel-fouled Watercraft Types

```{r fig28_pie_chart_MF_watercraft_types}
fig28_dat = dat_mf |> 
  filter(Year == my.year) |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  dplyr::mutate(value = ifelse(value > 0, 1, 0)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  filter(NumberBoats > 0)

if(my.year == 2022){
  fig28_dat = fig28_dat |> 
    mutate(NumberBoats = ifelse(name == 'Very complex', 8, NumberBoats)) |> 
    add_row(name = 'Unknown', NumberBoats = 1)
}

fig28_dat |> 
  mutate(prop = 100*NumberBoats/sum(NumberBoats)) |> 
  knitr::kable()

p28 = fig28_dat |> 
  dplyr::mutate(name = ifelse(name == 'Non-motorized / Hand launched','Non-motorized / \nHand launched',name)) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |> 

  ggplot(aes(x = "", y = NumberBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(name,"\n",NumberBoats)), 
            color = "black",nudge_x=0.4) +
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p28

if(!interactive()) {
ggsave("Fig28_Musselfouled_Watercraft_Type_Pie_Chart.jpg",p28)
}
```

### Figure 29 Commercially Hauled Boats

```{r fig29_commercially_hauled_boats}
print("Total count of commercially hauled boats:")

 dat |> 
  filter(Station != "Hwy 97c") |> 
   dplyr::count(Commercially_Hauled_Ind, name = 'Total_Inspection') |> 
   dplyr::left_join(
     dat |> 
       filter(Station != "Hwy 97c",
              High_Risk_AIS_Ind) |> 
       dplyr::count(Commercially_Hauled_Ind, name = 'HR_Inspection')) |> 
   dplyr::left_join(
     dat |> 
       filter(Station != "Hwy 97c",
              MusselsFound_Ind) |> 
       dplyr::count(Commercially_Hauled_Ind, name = 'Mussel_Fouled')
   )
 
 
 p29 = dat |> 
  filter(Commercially_Hauled_Ind == T,
         Station != "Hwy 97c") |> 
  filter(Station %in% stations.to.include) |> 
  group_by(Station) |> 
  summarise(NumberBoats = n()) |> 
  arrange(desc(NumberBoats)) |> 
  left_join(station_types) |> 
  mutate(Station = as.factor(Station)) |> 
  ggplot() + 
  geom_col(aes(x=reorder(Station,-NumberBoats),y=NumberBoats),fill = my.grey, width = 0.40) +
  geom_text(aes(x=reorder(Station,-NumberBoats),y=NumberBoats+0.05*max(NumberBoats),label=NumberBoats)) +
  labs(y = "Commercially Hauled Boats",
       x = "Station") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p29

if(!interactive()) {
ggsave("Fig29_Commerically_Hauled_by_Station.jpg",p29)
}
```

### Map 8. Commercially Hauled Boat Source Locations

```{r map7_commercially_hauled_boat_sources}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(CHInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(CHInsp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(CHInsp_b = case_when(
    CHInsp <= jenks_2 ~ 1,
    CHInsp <= jenks_3 ~ 2,
    CHInsp <= jenks_4 ~ 3,
    CHInsp <= jenks_5 ~ 4,
    CHInsp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    CHInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    CHInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    CHInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    CHInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    CHInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  # mutate(CHInsp_b = factor(CHInsp_b, levels = c(1:5))) |> 
  arrange(CHInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(CHInsp)))

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$CHInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(CHInsp_b))
centr_without_dat = sources_centroid |> filter(is.na(CHInsp_b))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(CHInsp_b))

centr_offset = centr_with_dat |> 
  dplyr::mutate(lat = sf::st_coordinates(geom)[,2],
                lng = sf::st_coordinates(geom)[,1]) |> 
  dplyr::mutate(lat = lat - 1,
                lng = lng - 1) |> 
  sf::st_drop_geometry() |> 
  sf::st_as_sf(coords = c("lng","lat"), crs = 4326)


bounds <- st_bbox(centr_with_dat)
bounds["xmin"] <- bounds["xmin"] - 18
bounds["xmax"] <- bounds["xmax"] + 8
bounds["ymin"] <- bounds["ymin"] - 8
bounds["ymax"] <- bounds["ymax"] + 8

bounds_sfc <- st_as_sfc(bounds)
bounds_sfc <- st_transform(bounds_sfc, st_crs(north_america_stations_basemap_colour))

bounds_vect <- terra::vect(bounds_sfc)

basemap_cropped <- terra::crop(north_america_stations_basemap_colour, bounds_vect)


legend_df_ch <- centr_with_dat |>
  sf::st_drop_geometry() |>
  dplyr::select(bin_label, my_colors, CHInsp_b) |>
  distinct()

map_8_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = basemap_cropped) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = bin_label, size = CHInsp_b),
    shape = 21,
    color = "black",
    stroke = 0.2
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR),
    size = 3,
    color = "black"
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Commercially\nHauled Inspections"),
    values = setNames(legend_df_ch$my_colors, legend_df_ch$bin_label),
    guide = guide_legend(
      override.aes = list(
        shape = 21,
        fill = legend_df_ch$my_colors,
        size = log(legend_df_ch$CHInsp_b + 1) + 1
      )
    )
  ) +
  scale_size_continuous(range = c(2, 6), guide = "none") +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    plot.margin = margin(0, 0, 0, 0),  # top, right, bottom, left
    legend.position = c(0.05, 0.05),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )

map_8_ggplot
if(!interactive()) {
# tmap_save(tm = map_8_tmap, filename = 'Map8_Commercially_Hauled_Watercraft_Sources.jpg', width = 7.6, height = 6.4, dpi = 300)
   ggsave(filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map8_Commercially_Hauled_Watercraft_Sources.jpg'), map_8_ggplot,  width = 7.6, height = 6.4, dpi = 300)
  # ggsave(filename = 'Map8_Commercially_Hauled_Watercraft_Sources.jpg',map_8_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

```{r ais_passport_holder_summary}
dat |> 
  dplyr::count(Passport_Holder_Ind)
```

### Map 9. Lake Monitoring Plankton Sample Tows

```{r map8_lake_monitoring_figure}
if(my.year == 2022){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab Analysis/Final report and data/BC Veliger Sampling Inventory 2022_FinalReport.xlsx'))
}
if(my.year == 2023){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab results/BC Veliger Sampling Inventory 2023_11-20_Final Report.xlsx'))
}
if(my.year == 2024){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab results/Final report/BC Veliger Sampling Inventory 2024_FINAL REPORT.xlsx'))
}

lab_dat =  lab_dat |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, " \\(.*")) |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, "\\,.*")) |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, "\\'"))

lab_sf = lab_dat |> 
  dplyr::rename(
    lat = `Lat (Decimal degrees)`,
    lng = `Long (Decimal degrees)`
  ) |> 
  mutate(lat = as.numeric(lat),
         lng = as.numeric(lng)) |> 
  dplyr::filter(!is.na(lat)) |> 
  st_as_sf(coords = c("lng","lat"),
           crs = 4326)

# How many unique lakes were sampled?
paste0(length(lab_dat |> 
  dplyr::select(Waterbody) |> 
  st_drop_geometry() |> 
  mutate(Waterbody = str_squish(Waterbody)) |> 
  distinct() |> 
  pull(Waterbody)), " lakes sampled across the province.")

# And how many samples were taken?
print(paste0(nrow(lab_dat), " samples were taken."))

# hctf = read_excel(paste0(my_opts$base_dir,'04_Extra_Figures_and_Scripts/data/Appendix 1 for MoE report_2022 Draft.xlsx'))
# 
# hctf = hctf |> 
#   filter(!duplicated(Waterbody))

# # How many lakes were substrate sampled?
# paste0(length(hctf |> 
#                 filter(`# Substrate samplers` > 0,
#                        Waterbody != 'Total Samples') |> 
#                 dplyr::select(Waterbody) |> 
#                 mutate(Waterbody = str_squish(Waterbody)) |> 
#                 distinct() |> 
#                 pull(Waterbody)), " lakes substrate sampled across the province.")
# 
# hctf |> 
#   filter(`# Substrate samplers` > 0,
#          Waterbody != 'Total Samples') |> 
#   summarise(number_substrate_samplers = sum(`# Substrate samplers`))

if(my.year == 2024){
  lab_sf = lab_sf |> 
    dplyr::rename(`Type of plankton tow (Vertical or Horizontal)` = `Type of plankton tow (vertical or horizontal)`)
}
# Make excel sheet for updating final report appendix!
lab_sf |> 
  # Join the Natural Resource regions (n = 8) to the lakes.
  st_join(
    sf::read_sf(paste0(my_opts$remote_spatial_data,'shared_data_sets/FLNRO_Fishing_Boundaries.shp')) |>
      st_transform(crs = 4326) |> 
      dplyr::select(Region = REGION_N)
    ) |> 
  st_drop_geometry() |> 
  tidyr::separate_longer_delim(cols = `Type of plankton tow (Vertical or Horizontal)`, delim = ', ') |> 
  count(Waterbody,Region,`sampling group/agency`,`Type of plankton tow (Vertical or Horizontal)`,`Zebra/Quagga mussels veligers`) |> 
  dplyr::rename(`Sampling Group/Agency` = `sampling group/agency`) |> 
  dplyr::select(-n) |> 
  dplyr::select(-c(`Type of plankton tow (Vertical or Horizontal)`)) |> 
  mutate(Waterbody = str_squish(Waterbody)) |> 
  distinct() |> 
  filter(!is.na(Region)) |> 
  dplyr::group_by(Waterbody) |> 
  dplyr::summarise(Region = paste0(Region, collapse = ', '),
                   `Sampling Group/Agency` = paste0(`Sampling Group/Agency`, collapse = ', '),
                   `Zebra/Quagga mussels veligers` = paste0(`Zebra/Quagga mussels veligers`, collapse = ', ')) |> 
  openxlsx::write.xlsx(file = 'lake_monitoring_for_report_appendix.xlsx')

sampling_pal = leaflet::colorFactor(
  palette = 'Set3',
  domain = lab_sf$`sampling group/agency`
)

lab_sf = lab_sf |> 
  mutate(my_colors = sampling_pal(`sampling group/agency`))


legend_df_lab <- lab_sf |>
  sf::st_drop_geometry() |>
  dplyr::select(`sampling group/agency`, my_colors) |>
  distinct()

bc_stations_basemap_trimmed <- terra::trim(bc_stations_basemap_colour)
raster_bbox_df <- as.list(terra::ext(bc_stations_basemap_trimmed))

map_9_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_trimmed) +
  geom_sf(data = bc_bound, color = "grey", fill = NA, linewidth = 1) +
  geom_sf(
    data = lab_sf,
    aes(fill = `sampling group/agency`),
    shape = 21,
    color = "black",
    size = 3,
    stroke = 0.2
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Invasive\nMussel Lake Monitoring"),
    values = setNames(legend_df_lab$my_colors, legend_df_lab$`sampling group/agency`)
  ) +
  coord_sf(
    xlim = c(raster_bbox_df$xmin, raster_bbox_df$xmax),
    ylim = c(raster_bbox_df$ymin, raster_bbox_df$ymax),
    expand = FALSE
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )
map_9_ggplot

if(!interactive()) {
  # tmap_save(tm = map_9_tmap, filename = 'Map9_Map_of_Lake_Sampling.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = 'Map9_Map_of_Lake_Sampling.jpg',map_9_ggplot, width = 7.6, height = 6.4, dpi = 300)
} else {
  # tmap_save(tm = map_9_tmap, filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024.jpg", width = 7.6, height = 6.4, dpi = 300)
}

if(interactive()){
library(basemaps)

lab_sf_b = st_buffer(lab_sf,3000)

my_ext = lab_sf |> st_combine() |> st_bbox() |> st_as_sfc() |> 
  st_buffer(10000)

sat_basemap = basemap_terra(ext = my_ext, 'esri', 'world_ocean_base')

yellow_basemap = basemap_terra(ext = my_ext, 'esri', 'world_street_map')

inset_bc = ggplot() + 
  geom_sf(data = bc_bound |> 
            st_transform(3005)) + 
  geom_sf(data = my_ext, col = 'red', fill = 'transparent') +
  ggthemes::theme_map()

library(patchwork)

sat_plot = ggplot() + 
  tidyterra::geom_spatraster_rgb(data = sat_basemap) +
  geom_sf(data = lab_sf_b, aes(fill = `sampling group/agency`)) +
  scale_fill_brewer(palette = "Set3") + 
  ggspatial::annotation_scale() +
  labs(fill = "Sampling \nGroup/Agency",
       title = "2024 Invasive Mussel Lake Monitoring") +
  theme(plot.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.background = element_blank())

sat_plot = sat_plot + 
  inset_element(inset_bc, left = 0.8, top = 0.95, right = 0.95, bottom = 0.8)

# ggsave(filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024_Satellite_Background.jpg", width = 10, height = 8,
#        plot = sat_plot)

yellow_streets_plot = ggplot() + 
  tidyterra::geom_spatraster_rgb(data = yellow_basemap) +
  geom_sf(data = lab_sf_b, aes(fill = `sampling group/agency`)) +
  scale_fill_brewer(palette = "Set3") + 
  labs(fill = "Sampling \nGroup/Agency",
       title = "2024 Invasive Mussel Lake Monitoring") +
  ggspatial::annotation_scale() +
  theme(plot.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.background = element_blank())

yellow_streets_plot = yellow_streets_plot + 
  inset_element(inset_bc, left = 0.8, top = 0.95, right = 0.95, bottom = 0.8)

# ggsave(filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024_Streets_Background.jpg", width = 10, height = 8,
#        plot = yellow_streets_plot)
}
```

### Figure 30 
```{r fig30_CBSA_Notifications}
if(exists("cbsa_dat")){
cbsa_dat = cbsa_dat |> 
  filter(!is.na(Categories)) |> 
  mutate(Categories = str_to_upper(Categories)) |> 
  mutate(Categories = str_remove_all(Categories, " -")) |> 
  mutate(Subtype = str_extract(Categories, "(?<=CBSA ).*")) |> 
  mutate(Categories = str_remove_all(Categories, "(?<=CBSA).*")) |> 
  mutate(Year = my.year) |> 
  mutate(Categories = case_when(
    Categories %in% c("NEW BOATS","NEW BOAT SHIPMENT") ~ "NEW BOATS",
    str_detect(Categories, "INVASIVE SPECIES") ~ "ISCBC",
    T ~ Categories
  )) |> 
  mutate(Subtype = coalesce(Subtype, Categories)) |> 
  mutate(Categories = case_when(
    Categories %in% c("USA","US","US STATE","ID","MT") ~ "USA",
    Categories %in% c("AB","SK","MB") ~ "PROVINCES",
    T ~ Categories
  )) |> 
  count(Categories, Subtype, sort = T)

p30 = cbsa_dat |> 
  group_by(Categories) |> 
  summarise(group_n = sum(n)) |>
  ungroup() |> 
  arrange(group_n) |> 
  mutate(Categories = fct_inorder(Categories)) |> 
  ggplot() + 
  geom_col(aes(group_n, Categories, fill = Categories), col = "black") + 
  geom_text(aes(group_n/2, Categories, label = group_n), size = 5) +
  theme_light() +
  theme(text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(y = "", x = "Number of Notifications",
       title = "CBSA Notification Categories",
       subtitle = my.year)

p30

if(!interactive()) {
ggsave("Fig30_Percent_Previous_Knowledge.jpg",p30)
}
}
```

### Figure 32 Previous Knowledge

```{r fig32_previous_knowledge}
#Remove Penticton Roving
fig32_dat = dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  group_by(Station, Previous_AIS_Knowledge_Ind) |>
  summarise(Number = n()) |> 
  mutate(TotalPerStation = sum(Number)) |> 
  mutate(Diff = case_when(
    row_number() %% 2 != 0 ~ Number-lead(Number),
    row_number() %% 2 == 0 ~ -Number + lag(Number))) |>
  mutate(Diff = 100*Diff/TotalPerStation) |> 
  arrange(Diff) |> 
  ungroup() |> 
  filter(Previous_AIS_Knowledge_Ind == T) |> 
  left_join(station_types) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  ungroup() |> 
  mutate(prop = 100*Number/TotalPerStation) |> 
  mutate(StationType_T = paste0(StationType, Previous_AIS_Knowledge_Ind))
  
fig32_dat |> 
  dplyr::reframe(TotalPerStation = sum(TotalPerStation),
                 Number = sum(Number)) |> 
  dplyr::mutate(perc_with_prev_AIS_knowledge = 100*Number / TotalPerStation) |> 
  knitr::kable()
#Add in dummys for FALSE of Previous_AIS_Knowledge_Ind to make backdrop of plot.
fig32_dat = fig32_dat |> 
  filter(Station %in% stations.to.include) |> 
  mutate(prop_queda = 100-prop) |> 
  pivot_longer(cols = c(prop, prop_queda), names_to = "Prop_type",values_to = "prop") |> 
  mutate(Previous_AIS_Knowledge_Ind = replace(Previous_AIS_Knowledge_Ind, Prop_type == "prop_queda", "FALSE")) |> arrange(desc(Previous_AIS_Knowledge_Ind), Station)

fig32_dat |> 
  dplyr::select(Station,Number,TotalPerStation,prop) |> 
  dplyr::arrange(desc(prop)) |> 
  knitr::kable()

p32 = ggplot() + 
  geom_col(data = fig32_dat,
           aes(x=StationLabel,y=prop,fill = Previous_AIS_Knowledge_Ind),
           col = "black", width = 0.4) + 
  labs(y = "Percent Previous Knowledge",fill = "",
       x = 'Station') + 
  theme_classic() +
  scale_fill_manual(breaks = c("TRUE","FALSE"),
                    values = c("TRUE" = my.grey,
                               "FALSE" = "grey"),
                    labels = c("Yes","No")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))+
  scale_x_discrete(labels = c(
    "Douglas Crossing*" = "Douglas*"
  ))

  
p32

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig32_Percent_Previous_Knowledge.jpg"),p32,
       width = 8, height = 4, dpi = 300)
}
```

### Figure 33 Primary Sources of Previous Knowledge

```{r fig33_primary_sources_previous_knowledge}

# To see the proportions of each type:
dat |> 
    rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) |> 
    #Join the lookup table for previous AIS knowledge
    left_join(ais_know |> 
                  rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) |> 
                  mutate(ais_know_id = as.character(ais_know_id)) |> 
                  select(Description, ais_know_id)) |> 
    #Only keep records that have some kind of previous AIS knowledge.
    filter(!is.na(Description)) |> dplyr::count(Description) |> dplyr::mutate(prop = 100*n / sum(n)) |> 
  knitr::kable()

p33 = dat |> 
  rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) |> 
  #Join the lookup table for previous AIS knowledge
  left_join(ais_know |> 
              rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) |> 
              mutate(ais_know_id = as.character(ais_know_id)) |> 
              select(Description, ais_know_id)) |> 
  #Only keep records that have some kind of previous AIS knowledge.
  filter(!is.na(Description)) |> 
  # Amalgamate Previous Inspections outside BC into one group.
  mutate(Description = case_when(
    Description == 'Previous Inspection (other)' ~ Description,
    Description == 'Previous Inspection in AB' ~ 'Previous Inspection (other)',
    T ~ Description
  )) |> 
  #Get the number of records for each knowledge source
  group_by(Description) |> 
  summarise(Number = n()) |> 
  #Calculate the percentage for each knowledge source
  mutate(Total = sum(Number)) |> 
  mutate(prop = 100*Number/Total) |> 
  #Put all knowledge sources below 1% into a single category called 'Other', label the groups for all knowledge sources >= 1% with their descriptions.
  mutate(Grouper = case_when(
    prop >= 1 ~ Description,
    T ~ "Other"
  )) |> 
  #Add together proportions within each of these groups. This combines the "Other" group.
  group_by(Grouper) |> 
  summarise(prop = sum(prop)) |> 
  arrange(desc(Grouper)) |> 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) |> 
  ggplot(aes(x = "", y = prop, 
           fill = Grouper)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(round(prop,0), "%")),
                   size = 4.5, nudge_x = 0.2) +
  #geom_text(aes(y = lab.ypos, label = paste0(Grouper,", ",round(prop,0),"%")), 
#            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Knowledge Source") +
  scale_fill_brewer(palette = "Dark2")

p33

if(!interactive()) {
ggsave("Fig33_Primary_Sources_Previous_AIS_Knowledge.jpg",p33)
}
```

```{r number_nonmotorized_non_compliers}
print('Blowby Info')
dat |> filter(Year == my.year) |> 
  mutate(all_boats = n()) |> 
  dplyr::select(Shift_ID,
                all_boats,
                Motorized_Blow_Bys_Counter,
                Non_Motorized_Blow_Bys_Counter) |> 
  distinct() |> 
  group_by(all_boats) |> 
  summarise(total_motorized_blowbys = sum(as.numeric(Motorized_Blow_Bys_Counter)),
         total_non_motorized_blowbys = sum(as.numeric(Non_Motorized_Blow_Bys_Counter)))
```

```{r previous_CDD_AIS_knowledge_numbers}

print('What percentage of inspections had previous knowledge of AIS / CDD?')

( nrow(dat |> filter(Previous_AIS_Knowledge_Ind == T)) ) /
  ( nrow(dat) )

print('And which sources of knowledge were most salient?')
dat |> 
  count(Previous_AIS_Knowledge_Source_Code_ID, sort = T) |> 
  mutate(Previous_AIS_Knowledge_Source_Code_ID = as.numeric(Previous_AIS_Knowledge_Source_Code_ID, sort = T)) |> 
  left_join(ais_know |> select(Previous_AIS_Knowledge_Source_Code_ID = `Previous Ais Knowledge Source Code ID`,
                                Description)) |> 
  knitr::kable()
  
```

```{r calculation_of_boat_types}

print("Breakdown of boats by complexity")
dat |> summarise(across(ends_with('_Counter'), as.numeric)) |> summarise(across(ends_with('_Counter'), sum)) |> 
  pivot_longer(cols = everything()) |> 
  filter(!str_detect(name, '_Bys_')) |> 
  mutate(percentage = 100*value/sum(value)) |> 
  knitr::kable()

print("Of HR boats, how many were complex?")
dat |> 
  filter(High_Risk_AIS_Ind == T) |> 
  mutate(Complex_Counter = replace(Complex_Counter, Complex_Counter != '0', '1')) |> 
  count(Complex_Counter) |> 
  mutate(percentage = 100*n/sum(n))

print("Of HR boats, how many were very complex?")
dat |> 
  filter(High_Risk_AIS_Ind == T) |> 
  count(Very_Complex_Counter) |> 
  mutate(percentage = 100*n/sum(n))
```

