---
title: "02_IMDP_FinalReport_Figures"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
fig_width: 8
---

```{r setup, include=FALSE}
pacman::p_load(
readxl,
ggpubr,
ggrepel,
ggExtra,
tidyverse,
leaflet,
sf,
RColorBrewer,
openxlsx,
scales,
lubridate,
plotrix)

#=====================================================
#                       OPTIONS 
#=====================================================
my_opts = read_csv(paste0(str_extract(getwd(),".*ZQMussels[/]?"),"/Options.csv"))

#Which year should we focus on?
my.year = my_opts$year

#Update GIS maps? We probably want this turned on unless you are making fine adjustments to some figures.
update.gis = FALSE

#Are there any stations we would like to exclude from the excel-type figures?
#In 2021, we will exclude:
stations.to.include = c("Golden","Radium","Olsen","Yahk",
                        "Pacific","Osoyoos","Hwy 97c","Mt. Robson",
                        "Keremeos","Greenwood","Dawson Creek","Kaleden")

stations.to.put.aside = c("Scheduled Inspection","Boat Launch - Okanagan",
                          "Okanagan",
                          "Penticton Roving - Hwy 33", 
                          "Penticton Roving - Inspection Event")

# Just in case it's different, which stations do we want to show in the 
# leaflet maps?
leaflet.stations.to.include = c("Golden","Radium","Olsen","Dawson Creek","Mt. Robson","Penticton Roving","Keremeos","Osoyoos","Fraser Valley Roving","Pacific")

#Data folders
my.data.folder = paste0(my_opts$zqm_figure_local_folder,"data/")
my.external.data.folder = paste0(my_opts$remote_spatial_data,"Projects/ZQMussels/data/")

#Which folder should we put specific output files in?
my.output.folder = paste0(my_opts$zqm_figure_local_folder,"output/")
my.external.output.folder = paste0(my_opts$zqm_figure_output_remote_folder,my_opts$year)
zqm.operations.folder = my_opts$zqm_operations_data_folder
this.years.report.folder = paste0(my_opts$remote_spatial_data,"Projects/ZQMussels/",my.year," IMDP Final Report/")

#Where is the mussel-fouled tracking sheet?
MusselFouledTracker = paste0(my_opts$zqm_operations_data_folder,"Watercraft Inspection Data/", my.year," data/2022 mussel fouled boats tracking sheet.xlsx")

#What is the sheet name of the destination regions for the mussel fouled tracking sheet?
MF_tracker_sheet = "DestRegions"

#Where can we find the CBSA notifications excel sheet for this year?
if(file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/",my.year," COS inbox notifications.xlsx"))){
  cbsa_dat = read_excel(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/",my.year," COS inbox notifications.xlsx"),
                 sheet = "Filtered list")
}

#These lines below set options for all of the code for the rest of this script. You probably don't need to change any of these.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_chunk$set(fig.height = 4)
knitr::opts_knit$set(root.dir = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures"))

#Colour for some of the figures:
my.grey = "#5f6a6f"

#=====================================================
#                     END OF OPTIONS
#=====================================================

#If there is no folder for excel figures for the target year in the I: drive, make it now.
if(!dir.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures"))){
  dir.create(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/"))
}
```

```{r load in data}
setwd(my.data.folder)

dat = read.xlsx('figure_dat.xlsx') %>% 
  mutate(TimeOfInspection = convertToDateTime(TimeOfInspection)) %>% 
  as_tibble()

dat_all = read.xlsx('figure_dat_all.xlsx') %>%
  mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) %>% 
  as_tibble()

dat_hr = read.xlsx('figure_dat_hr.xlsx') %>% 
  mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) %>% 
  as_tibble()

dat_mf = read.xlsx('figure_dat_mf.xlsx') %>%
  mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) %>% 
  as_tibble()

flnro_lookup = read_excel(paste0(my.external.data.folder,"waterbody_name_flrno_region_lookup_table.xlsx")) %>% distinct()

abbrev = read_excel(paste0(my.external.data.folder,"Province_States_Abbreviation_Table.xlsx"))

#Lookup table for what the Previous Knowledge of AIS field's codes mean.
ais_know = read_excel(paste0(my.external.data.folder,"Previous_Knowledge_of_AIS_lookup_table.xlsx"))

# Outline of BC
bc_bound = bcmaps::bc_bound() %>% st_transform(crs = 4326)
```

```{r}
#Establish colour scheme for roving stations that we keep.
rovers = data.frame(Station = c("Hwy 97c","Keremeos","Greenwood","Kaleden","Fraser Valley Roving"),
                    StationType = "Roving")

station_types = bind_rows(rovers,
          data.frame(Station = dat %>% 
                       select(Station) %>% 
                       filter(!Station %in% rovers$Station) %>% 
                       distinct() %>% 
                       pull(Station),
                     StationType = "Permanent"))
rm(rovers)
```

```{r}
#Make one more vector of stations that we want to drop in the figures. These are roving stations.
rovers_to_drop = c("Scheduled Inspection","Other","Okanagan","Penticton Roving")
```

<!-- ```{css css_changes_for_leaflet_maps, echo = FALSE} -->
<!-- .legend { -->
<!--     font-size: large; -->
<!-- } -->
<!-- .leaflet-control-scale-line { -->
<!--     font-size: large; -->
<!-- } -->
<!-- ``` -->

### Map 1. Inspection Stations by Type

```{r map1_inspection_stations_by_type, fig.width=800}
# Grab inspection stations shapefile.
stations = read_sf(paste0(my_opts$remote_spatial_data,
                          'Projects/ZQMussels/data/inspection_stations.gpkg'))

# Drop stations from leaflet maps that we did not want to keep.
stations = stations %>% 
  filter(station_name %in% leaflet.stations.to.include)

stations_for_maps = stations %>% 
  mutate(station_type = replace(station_type, station_type == 'Unknown', 'Roving')) %>% 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

station_type_pal = colorFactor(
  palette = 'RdYlBu',
  domain = unique(stations_for_maps$station_type)
)

map_1 = leaflet(
  options = leafletOptions(style = list(
    "font-size" = "large"
  ))
) %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolygons(
    color = 'purple',
    fillColor = 'transparent',
    weight = 2,
    data = bc_bound
  ) %>% 
  addCircleMarkers(
    color = 'black',
    fillColor = ~station_type_pal(station_type),
    weight = 1,
    fillOpacity = 0.8,
    label = ~lapply(
      paste0(
          "<p style = 'font-size: ",
          my_text_size,"
          '>",
          paste0(
            ifelse(str_detect(map_label,"Roving$"),"","<br>"),
            map_label
          ),
          "</p>"), 
      htmltools::HTML),
    labelOptions = ~labelOptions(noHide = T, 
                                textOnly = T, 
                                textsize = 15),
    data = stations_for_maps
  ) %>% 
  addLegend(
    pal = station_type_pal,
    values = ~station_type,
    title = "2022 Watercraft Inspection Stations",
    # labFormat = function(type, cuts, p) paste0(labels),
    data = stations_for_maps
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lng = -120, lat = 52.5, zoom = 6)

map_1 %>%
  mapview::mapshot(file = "Map1_Stations_by_Type.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton")
  )

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg"))
```

### Map 2: Total Inspections by Station

```{r map2_total_inspections_by_station}
# Grab inspection stations shapefile.
stations = read_sf(paste0(my_opts$remote_spatial_data,
                          'Projects/ZQMussels/data/inspection_stations.gpkg'))
  
# Join number of inspections to stations.
st = stations %>% 
  left_join(dat %>% 
              count(Station, name = 'num_insp') %>% 
              dplyr::rename(station_name = Station)) %>% 
  filter(!is.na(num_insp))


# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st = st %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(num_insp_b = factor(num_insp_b, levels = c(1:5))) %>% 
  arrange(num_insp_b) %>% 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = st$num_insp_b,
  reverse = T
)

labels = unique(st$bin_label)

map_2 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolygons(
    color = 'purple',
    fillColor = 'transparent',
    weight = 2,
    data = bc_bound
  ) %>% 
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(num_insp_b),
    # Apply HTML to the labels so we can get line breaks in longer names.
    # Don't apply this to spaces followed by a number (e.g. '(Hwy 3)')
    label = ~lapply(
      paste0(
          "<p style = 'font-size: ",
          my_text_size,
          ";'>",
          paste0(
            ifelse(str_detect(map_label,"Roving$"),"","<br>"),
            map_label
          ),
          "</p>"), 
      htmltools::HTML),
    radius = ~as.numeric(num_insp_b)*5,
    labelOptions = ~labelOptions(noHide = T, 
                                textOnly = T, 
                                textsize = 15,
                                offset = c(-5,-10)),
    data = st
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~num_insp_b,
    title = "2022 Inspections by Station",
    labFormat = function(type, cuts, p) paste0(labels),
    data = st
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lng = -120, lat = 52.5, zoom = 6)

map_2 %>%
  mapview::mapshot(file = "Map2_Total_Inspections_by_Station.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"))

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map2_Total_Inspections_by_Station.jpg"))
```

### Figure 3 Total Boats by Station

```{r fig3_total_boats_by_station}
fig3_data = dat %>% 
  filter(!Station %in% rovers_to_drop) %>% 
  group_by(Station) %>% 
  summarise(NumberInsp = n()) %>% 
  left_join(dat_hr %>% 
              filter(Year == my.year) %>% 
              group_by(Station) %>% 
              summarise(NumberHighRiskInsp = n())
  ) %>% 
  #For any stations with 0 HR inspections, replace NA with 0.
  mutate(NumberHighRiskInsp = replace_na(NumberHighRiskInsp, 0)) %>% 
  mutate(PercentHR = 100*NumberHighRiskInsp/NumberInsp) %>% 
  arrange(desc(NumberInsp)) %>% 
  mutate(Station = factor(Station)) %>% 
  mutate(Station = fct_inorder(Station)) %>% 
  left_join(station_types) %>% 
  mutate(StationLabel = ifelse(StationType == "Roving", paste0(Station,"*"),Station)) %>% 
  mutate(StationLabel = fct_inorder(StationLabel)) %>% 
  mutate(col.width = as.numeric(cut(log10(NumberInsp),3))) %>% 
  mutate(col.width = replace(col.width, col.width == 3, 4))

p3 = fig3_data %>% 
  ggplot() +
  geom_col(aes(x=StationLabel, y=NumberInsp/1000), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",size=2) +
   scale_y_continuous(breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Total Inspections") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3

ggsave("Fig3_EncounterFrequency_HR.jpg",p3)
```

### Figure 3.x Total Inspections by Station

```{r}
p3.x = dat_all %>% 
  filter(Year %in% c(2019:2021)) %>% 
  filter(Station %in% c("Golden","Yahk","Olsen",
                        "Radium","Mt. Robson","Osoyoos",
                        "Dawson Creek",
                        "Pacific")) %>% 
  group_by(Year, Station) %>% 
  summarise(NumberInsp = n()) %>% 
  group_by(Station) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  ungroup() %>% 
  arrange(desc(TotalInsp),desc(NumberInsp)) %>% 
  mutate(Station = fct_inorder(Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberInsp,fill=Year), width = 0.40,position=position_dodge(preserve = "single")) +
  scale_y_continuous(name = "Number of Inspections",
                     breaks = c(0,1000,2500,5000,7500,10000,15000)) +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

p3.x

ggsave("Fig3x_TotalInspections_2019_to_2021_All_Stations.jpg",p3.x)
```

### Figure 4 Total Number of Jurisdictions

```{r fig4_total_number_jurisdictions}
p4 = dat %>%
  filter(!Station %in% rovers_to_drop) %>% 
  group_by(Station,Previous_Waterbody_1_Province_Or_State) %>% 
  summarise(Different_Sources = n()) %>% 
  summarise(TotalSources = n()) %>% 
  arrange(desc(TotalSources)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station,levels = .$Station)) %>% 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) %>% 
  mutate(StationLabel = fct_reorder(StationLabel, -TotalSources)) %>% 
  ggplot() + 
  geom_col(aes(x=StationLabel,y=TotalSources), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,y=TotalSources+0.05*max(TotalSources),label=TotalSources)) +
  labs(y = "Number of Origin Jurisdictions") + 
  theme_classic() + 
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p4

ggsave("Fig4_Total_Jurisdictions_by_Station.jpg",p4)
```

### Figure 5 Number of Inspections and Total Effort by month

```{r fig5_total_inspections_and_total_effort_by_month}
p5 = ggarrange(dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  #Calculate the number of inspections for each month
  group_by(the.month) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=Number_Insp),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.month,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  
  dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  group_by(the.month) %>% 
  select(the.month,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours)) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=TotalEffort),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.month,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p5

ggsave("Fig5_NumberInspections_and_TotalEffort_month.jpg",p5)
```

### Figure 6 Encounter Frequency by Month

```{r fig6_EncounterFrequency_by_month}
p6 = dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  mutate(the.day = day(TimeOfInspection)) %>% 
  filter(!the.month %in% c("January","February","December")) %>% 
  #Calculate the number of inspections for each month
  group_by(the.month,the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  left_join(
  dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  mutate(the.day = day(TimeOfInspection)) %>% 
  group_by(the.month,the.day) %>% 
  select(the.month,the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours))
  ) %>% 
  mutate(EncounterFreq = Number_Insp/TotalEffort) %>%
  mutate(StandardError = plotrix::std.error(EncounterFreq)) %>% 
  #Summarise for each month
  group_by(the.month,StandardError) %>% 
  summarise(EncounterFreq = mean(EncounterFreq)) %>% 
  #If the bottom half of the errorbar would be below 0, change to 0.
  mutate(StandardError = case_when(
    EncounterFreq - StandardError <= 0 ~ EncounterFreq,
    T ~ StandardError
  )) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=EncounterFreq),fill = my.grey,width = 0.40) +
  geom_errorbar(aes(x=the.month,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +

  geom_text(aes(x=the.month,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_y_continuous(breaks = seq(0,6.5,0.5))

p6

ggsave("Fig6_EncounterFrequency_by_month.jpg",p6)
```

### Figure 7 Total Inspections and Total Effort by Day of Week

```{r fig7_total_inspections_and_total_effort_by_day_of_week}
p7 = ggarrange(dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  #Calculate the number of inspections for each month
  group_by(the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=Number_Insp),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.day,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
                dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  group_by(the.day) %>% 
  select(the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours)) %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=TotalEffort),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.day,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p7

ggsave("Fig7_NumberInspections_and_TotalEffort_day.jpg",p7)
```

### Fig 8 Encounter Frequency by day of week

```{r fig8_Encounter_Frequency_by_day_of_week}
#This one requires grouping the data by the week number in the year (i.e. 1,2, 3 ... up to 54) and the day of the week to first calculate the standard error within each day of the week (which is the eventual grouping factor for the figure), then summarise by day of the week the calculate mean frequency.
p8 = dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  mutate(the.week = week(TimeOfInspection),
         Month = month(TimeOfInspection)) %>% 
  #Calculate the number of inspections for each month
  group_by(Month,the.week,the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  left_join(
    dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  mutate(the.week = week(TimeOfInspection),
         Month = month(TimeOfInspection)) %>% 
  group_by(Month,the.week,the.day) %>% 
  select(Month,the.week,the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours))
  ) %>% 
  mutate(EncounterFreq = Number_Insp/TotalEffort) %>%
  group_by(the.day) %>% 
  mutate(StandardError = plotrix::std.error(EncounterFreq)) %>% 
  mutate(EncounterFreq = mean(EncounterFreq,na.rm=T)) %>% 
  select(the.day,EncounterFreq,StandardError) %>% 
  distinct() %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=EncounterFreq),fill = my.grey,width = 0.40) +
  geom_errorbar(aes(x=the.day,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +
  geom_text(aes(x=the.day,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_y_continuous(breaks = seq(0,6.5,0.5))

p8

ggsave("Fig8_EncounterFrequency_day_of_week.jpg",p8)

```

### Figure 9 Total Inspections by Time of Day

```{r fig9_total_inspections_by_time_of_day}
p9 = dat %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  # geom_text(
  #   size = 3.5,
  #   aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
  #       label=round(Number_Insp,0))#,
  #   # min.segment.length = 0.1,
  #   # force = 0.1,
  #   # force_pull = 100
  # ) +
   geom_text_repel(
    size = 3.5,
    aes(x=the.hour,y=Number_Insp,#+max(Number_Insp)*0.05,
        label=round(Number_Insp,0)),
    min.segment.length = 0.1,
    force = .01,
    force_pull = 100,
    nudge_y = 100
  ) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9

ggsave("Fig9_NumberInspections_hour_of_day.jpg",p9)
```

### Figure 9. Part 2 High-Risk Inspections by Time of Day

```{r fig9_HR_inspections_by_time_of_day}
p9.2 = dat %>% 
  filter(High_Risk_AIS_Ind == T) %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.2

ggsave("Fig9_Part2_Number_Highrisk_Inspections_hour_of_day.jpg",p9.2)
```

### Figure 9. Part 3 Total Inspections by Time of Day for Golden Station

```{r fig9_Golden_inspections_by_time_of_day}
p9.3 = dat %>% 
  filter(Station == "Golden") %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.3

ggsave("Fig9_Part3_Number_Inspections_Golden_hour_of_day.jpg",p9.3)
```


### Figure 9. Part 4 High-Risk Inspections by Time of Day for Golden Station

```{r fig9_HR_Golden_inspections_by_time_of_day}
p9.4 = dat %>% 
  filter(High_Risk_AIS_Ind == T,
         Station == "Golden") %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.4

ggsave("Fig9_Part4_Number_Highrisk_Inspections_Golden_hour_of_day.jpg",p9.4)
```

### Figure 11 Destination Waterbodies with Percent

```{r fig11_Destination_Waterbodies_with_percent}
p11 = dat %>% 
  filter(!is.na(Destination_Waterbody_1_Name)) %>% 
  group_by(Destination_Waterbody_1_Name) %>% 
  summarise(NumberInsp = n()) %>% 
  arrange(desc(NumberInsp)) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  mutate(Percent = 100*NumberInsp/TotalInsp) %>% 
  slice(1:15) %>% 
  mutate(Destination_Waterbody_1_Name = factor(Destination_Waterbody_1_Name,levels = .$Destination_Waterbody_1_Name)) %>%
  ggplot() + 
  geom_col(aes(x=Destination_Waterbody_1_Name,
               y=Percent),fill = my.grey, width = 0.40) +
  geom_text(aes(x=Destination_Waterbody_1_Name,
                y=Percent+max(Percent)*0.05,
               label=paste0(round(Percent,1),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent of Total Inspections") + 
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1))

p11

ggsave("Fig11_DestinationWaterbody_Percent_Inspections.jpg",p11)
```

### Map 3: Home Residence of Boats

```{r map2_home_residence_of_boats}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# ggplot() + geom_sf(data = sources_centroid)

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid %>% 
  mutate(map_label_colour = ifelse(is.na(TotalInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(TotalInsp, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(TotalInsp_b = case_when(
    TotalInsp <= jenks_2 ~ 1,
    TotalInsp <= jenks_3 ~ 2,
    TotalInsp <= jenks_4 ~ 3,
    TotalInsp <= jenks_5 ~ 4,
    TotalInsp <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    TotalInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    TotalInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    TotalInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    TotalInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    TotalInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(TotalInsp_b = factor(TotalInsp_b, levels = c(1:5))) %>% 
  arrange(TotalInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid %>% 
  filter(!(NAME_0 == 'Mexico' & is.na(TotalInsp)))

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$TotalInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

map_3 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>%
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(TotalInsp_b),
    # Apply HTML to the labels.
    label = ~lapply(paste0("<p style = 'font-size: large;color:",map_label_colour,"'>",ABBR,"</p>"), htmltools::HTML),
    labelOptions = labelOptions(noHide = T, textOnly = T,
                                textsize = 20),
    radius = ~as.numeric(TotalInsp_b)*5,
    data = sources_centroid
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~TotalInsp_b,
    title = "2022 Home Residence Freqeuncy",
    labFormat = function(type, cuts, p) paste0(labels),
    data = sources_centroid
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 50, lng = -100, zoom = 4)

map_3 %>% 
  mapview::mapshot(file = "Map3_Home_Residence_Frequency.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"),
                   vwidth = 1400, vheight = 1100)

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map3_Home_Residence_Frequency.jpg"))
```

### Figure 12 Percent Compliance by station

```{r fig12_percent_compliance_by_station}
p12 = dat %>% 
  filter(!Station %in% rovers_to_drop) %>% 
  group_by(Station,Shift_ID) %>% 
  summarise(NumberInsp = n()) %>% 
  #Add number of non-motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(Non_Motorized_Blow_Bys_Counter = as.numeric(Non_Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,Non_Motorized_Blow_Bys_Counter) %>% 
              distinct()) %>% 
  #Add number of motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(Motorized_Blow_Bys_Counter = as.numeric(Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,Motorized_Blow_Bys_Counter) %>% 
              distinct()) %>% 
  group_by(Station) %>% 
  summarise(NumberInsp = sum(NumberInsp),
            Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
            Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) %>% 
  group_by(Station) %>% 
  summarise(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter)) %>% 
  arrange(desc(PercentCompliance)) %>% 
  #Add station type...
  left_join(station_types) %>% 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) %>% 
  mutate(StationLabel = fct_reorder(StationLabel, -PercentCompliance)) %>% 
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=PercentCompliance), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,
                y=PercentCompliance+max(PercentCompliance)*0.05,
               label=paste0(round(PercentCompliance,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Compliance") + 
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p12

ggsave("Fig12_PercentCompliance_Station.jpg",p12)
```

### Figure 13 Noncompliant Watercraft Breakdown
```{r fig13_noncompliant_breakdown}
p13 = dat %>% 
  filter(!Station %in% c(rovers_to_drop,"Osoyoos","Sumas Border")) %>% 
  group_by(Station,Shift_ID) %>% 
  mutate(nonm = as.numeric(Non_Motorized_Blow_Bys_Counter)) %>% 
  select(Station,Shift_ID,nonm) %>% 
  distinct() %>% 
  #Add number of motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(m = as.numeric(Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,m) %>% 
              distinct()) %>% 
  mutate(Total_Blowbys = nonm + m) %>% 
  group_by(Station) %>% 
  summarise(Total_Blowbys = sum(Total_Blowbys),
            nonm = sum(nonm),
            m = sum(m)) %>% 
  group_by(Station) %>% 
  summarise(`Non-Motorized` = 100*nonm/Total_Blowbys,
            Motorized = 100*m/Total_Blowbys) %>% 
  arrange(desc(`Non-Motorized`)) %>% 
  #mutate(Station = factor(Station, levels = .$Station)) %>% 
  pivot_longer(cols = -Station) %>%
  arrange(desc(value),Station) %>% 
  left_join(station_types) %>% 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) %>% 
  mutate(StationLabel = fct_inorder(StationLabel)) %>%
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=value,
               fill = name),
           col = "black",
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Blow-bys", fill = "") + 
  scale_fill_manual(values = c("Non-Motorized" = my.grey,
                               "Motorized" = "grey")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p13 

ggsave("Fig13_Percent_Blowbys_Station.jpg",p13)
```

### Figure 14 Percent Watercraft Inspected with Previous Inspection

```{r fig14_percent_watercraft_insp_with_prev_insp}
p14 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Okanagan",
                         "Other", "Penticton Roving")) %>% 
  group_by(Station) %>% 
  summarise(TotalInsp = n()) %>% 
  left_join(dat %>% 
              filter(Previous_Inspection_Ind == T) %>% 
              group_by(Station) %>% 
              summarise(PrevInspected = n())
            ) %>% 
  mutate(PercPrevInsp = 100*PrevInspected/TotalInsp) %>% 
  arrange(desc(PercPrevInsp)) %>% 
  left_join(station_types) %>% 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) %>% 
  mutate(StationLabel = fct_inorder(StationLabel)) %>% 
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=PercPrevInsp), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,
                y=PercPrevInsp+max(PercPrevInsp)*0.1,
               label=paste0(round(PercPrevInsp,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected") + 
  scale_y_continuous(breaks = seq(0,100,10), 
                     limits = c(0,100),
                     labels = paste0(seq(0,100,10),"%")) +  
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

  
p14

ggsave("Fig14_Percent_Intercepted_with_Prev_Insp.jpg",p14)
```

### Figure 15 Frequency of Previously Inspected Watercraft's Inspections

```{r fig15_prev_insp_watercraft_insp_time}
#Remove Penticton Roving
p15 = dat %>% 
  filter(!Station %in% rovers_to_drop) %>% 
  filter(Previous_Inspection_Ind == T) %>% 
  filter(!is.na(Previous_Inspection_Days_Count)) %>% 
  mutate(previnsp = case_when(
    Previous_Inspection_Days_Count %in% c('0','Same day') ~ 'Same Day',
    Previous_Inspection_Days_Count %in% c('30','60','180') ~ '> 30 Days',
    Previous_Inspection_Days_Count %in% c('< 30 days','<30 days') ~ '< 30 Days',
    Previous_Inspection_Days_Count == '> 30 days' ~ '> 30 Days',
    Previous_Inspection_Days_Count == '> 1 year' ~ '> 1 Year',
    T ~ NA
  )) %>% 
  select(Station, previnsp) %>% 
  # mutate(Timeperiod = as.numeric(cut(previnsp, breaks = c(-1,0.1,30,365,10000)))) %>% 
  # mutate(Timeperiod_name = case_when(
  #   Timeperiod == 1 ~ "Same Day",
  #   Timeperiod == 2 ~ "< 30 Days",
  #   Timeperiod == 3 ~ "> 30 Days",
  #   Timeperiod == 4 ~ "> 1 Year",
  #   T ~ "Unknown"
  # )) %>% 
  count(Station, previnsp, name = 'NumberInsp') %>%
  group_by(Station) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  mutate(PercInsp = 100*NumberInsp/TotalInsp) %>% 
  mutate(previnsp = factor(previnsp, 
                                  levels = c("Same Day",
                                             "< 30 Days",
                                             "> 30 Days",
                                             "> 1 Year"))) %>% 
  arrange(Station,previnsp) %>% 
  select(Station,previnsp,PercInsp) %>% 
  left_join(station_types) %>% 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) %>% 
  mutate(StationLabel = fct_inorder(StationLabel)) %>% 
  ggplot() +
  geom_col(aes(x=StationLabel,
               y=PercInsp,
               fill = previnsp),
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected", fill = "") + 
  scale_fill_manual(values = c("Same Day" = "#ab52c5",
                               "< 30 Days" = "#8b9f4a",
                               "> 30 Days" = "#cc0000",
                               "> 1 Year" = "#2986cc")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p15 

ggsave("Fig15_Percent_PreviouslyInspected_Date_Bins.jpg",p15)
```

### Figure 16 Total High-risk Inspections over 3 years

```{r fig16_total_HR_insp_3_years}
p16 = dat_hr %>% 
  #Filter for our target year and the 2 years prior
  filter(Year %in% c(my.year-2, my.year-1, my.year)) %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  group_by(Year,the.month) %>% 
  summarise(Number_HR = n()) %>% 
  ungroup() %>% 
  #Add in a row for year-month combos with no records: 2020 April.
  add_row(Year = "2020",the.month = month(4,abbr=F,label=T),Number_HR = 0) %>% 
  group_by(Year) %>% 
  filter(!is.na(the.month)) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,
               y=Number_HR,
               fill = Year), 
           width = 0.40,
           col = "black",
           position = "dodge") +
  geom_text(data = . %>% filter(Year == my.year),
            aes(x=the.month,
                y=Number_HR+max(Number_HR)*0.2,
               label=round(Number_HR,0)),
               nudge_x = 0.15) +
  theme_classic() +
  scale_fill_manual(values = c("darkgrey","lightgrey","black")) +
  labs(x = "",y = "Number of High-Risk Inspections")

p16

ggsave("Fig16_Total_HR_Inspections_3_year_spread.jpg",p16)
```

### Figure 17. Map 4. High-risk Inspections by Station

```{r fig17_map4_high_risk_insp_by_station}
# Join number of inspections to stations.
st = stations %>% 
  left_join(dat %>% 
              filter(High_Risk_AIS_Ind == TRUE) %>% 
              count(Station, name = 'num_insp') %>% 
              dplyr::rename(station_name = Station)) %>% 
  filter(!is.na(num_insp))

# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st = st %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(num_insp_b = factor(num_insp_b, levels = c(1:5))) %>% 
  arrange(num_insp_b) %>% 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = st$num_insp_b,
  reverse = T
)

labels = unique(st$bin_label)

map_4 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolygons(
    color = 'purple',
    fillColor = 'transparent',
    weight = 2,
    data = bc_bound
  ) %>% 
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(num_insp_b),
    # Apply HTML to the labels so we can get line breaks in longer names.
    # Don't apply this to spaces followed by a number (e.g. '(Hwy 3)')
    label = ~lapply(
      paste0(
          "<p style = 'font-size: ",
          my_text_size,
          ";'>",
          paste0(
            ifelse(str_detect(map_label,"Roving$"),"","<br>"),
            map_label
          ),
          "</p>"), 
      htmltools::HTML),
    radius = ~as.numeric(num_insp_b)*5,
    labelOptions = ~labelOptions(noHide = T, 
                                textOnly = T, 
                                textsize = 15#,
                                #offset = c(4*as.numeric(num_insp_b),
                                #           -2*as.numeric(num_insp_b))
                                ),
    data = st
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~num_insp_b,
    title = "2022 High Risk Inspections",
    labFormat = function(type, cuts, p) paste0(labels),
    data = st
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lng = -120, lat = 52.5, zoom = 6)

map_4 %>% 
  mapview::mapshot(file = "Map4_HighRisk_Inspections_by_Station.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"))

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map4_HighRisk_Inspections_by_Station.jpg"))
```

### Figure 18 Source Locations of High-Risk Inspections

```{r fig18_pie_chart_source_locations_HR_Insp}
#Remove Penticton Roving
fig18_dat = dat_hr %>% 
  filter(Year == my.year) %>% 
  group_by(Previous_Waterbody_1_Province_Or_State) %>% 
  summarise(BoatsFromPlace = n()) %>% 
  mutate(TotalBoats = sum(BoatsFromPlace)) %>% 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) %>% 
  arrange(desc(PercBoatsFromPlace)) %>% 
  mutate(Grouper = case_when(
    PercBoatsFromPlace >= 2 ~ "MainFig",
    PercBoatsFromPlace < 2 ~ "SecondFig")
  )

fig18_main_dat = fig18_dat %>% 
  filter(Grouper == "MainFig") %>% 
  #Add a row for "Other" (for which we have to add together the others)
  bind_rows(fig18_dat %>% 
              filter(Grouper == "SecondFig") %>% 
              group_by(TotalBoats) %>% 
              summarise(BoatsFromPlace = sum(BoatsFromPlace)) %>% 
              mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats,
                     Previous_Waterbody_1_Province_Or_State = "Other",
                     Grouper = "MainFig")) %>% 
  rename(prop = PercBoatsFromPlace) %>%
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  select(-BoatsFromPlace,-TotalBoats)

fig18_second_dat = fig18_dat %>% 
  filter(Grouper != "MainFig") %>% 
  rename(prop = PercBoatsFromPlace) %>%
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  select(-BoatsFromPlace,-TotalBoats)

p18 = ggarrange(ggplot(fig18_main_dat,
       aes(x = "", y = prop, 
           fill = Previous_Waterbody_1_Province_Or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")),
                   color = "black", nudge_x = 1.5) + 
  theme_void() + 
  # scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Source") + 
  ggtitle("Main Sources") +
  theme(legend.position = "none"),
ggplot(fig18_second_dat,
       aes(x = "", y = prop, 
           fill = Previous_Waterbody_1_Province_Or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")), color = "black",nudge_x = 0.7)+
  theme_void() + 
  labs(fill = "Source") + 
  ggtitle("Breakdown of `Other`") +
  theme(legend.position = "none"),
ncol = 2, nrow = 1)

p18 

ggsave("Fig18_Inspection_Source_Pie_Charts.jpg",p18)
```

### Figure 19 Destination Locations of High-Risk Inspections

```{r fig19_pie_chart_destination_locations_HR_Insp}
#Quick aside - Martina wants to know how many of the HR inspections that have "Unknown" recorded in the DestRegion field also have the Source_wb_prov_unknown field toggled as T.

# dat_hr %>%
#     filter(Year == my.year) %>%
#     filter(DestRegion %in% c("unknown","Unknown")) %>%
#     #filter(Destination_Major_City != "None") %>%
#     filter(Unknown_Destination_Waterbody_Ind == T) %>%
#     select(Destination_Waterbody_1_Name,
#            Destination_Waterbody_1_Closest_City,
#            Destination_Major_City,
#            Unknown_Destination_Waterbody_Ind,
#            General_Comment) %>%
#   View(.)
# 
# #Total number of HR 2021 records for which destination region is Unknown.
# dat_hr %>%
#   filter(Year == my.year) %>%
#   filter(DestRegion %in% c("unknown","Unknown")) %>%
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where destination major city is also unknown.
# dat_hr %>%
#     filter(Year == my.year) %>%
#     filter(DestRegion %in% c("unknown","Unknown")) %>%
#     filter(Destination_Major_City != "None") %>%
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where unknown destination waterbody indicator field is TRUE.
# dat_hr %>%
#   filter(Year == my.year) %>%
#   filter(DestRegion %in% c("unknown","Unknown")) %>%
#   filter(Unknown_Destination_Waterbody_Ind == T) %>%
#   summarise(n())

fig19_dat = dat_hr %>% 
  filter(Year == my.year) %>% 
#Clean up destination regions.
  mutate(DestRegion = case_when(
    str_detect(DestRegion, "Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "going to Vancouver") ~ "Lower Mainland",
    str_detect(General_Comment, "to Pacific Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "Kelowna") ~ "Okanagan",
    str_detect(General_Comment, "Alaska") ~ "Outside BC",
    str_detect(General_Comment, "Vancouver Island") ~ "Vancouver Island",
    str_detect(General_Comment, "risk of entering BC waters") ~ "Outside BC",
    T ~ DestRegion
  )) %>% 
  group_by(DestRegion) %>% 
  summarise(BoatsFromPlace = n()) %>% 
  mutate(TotalBoats = sum(BoatsFromPlace)) %>% 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) %>% 
  #Add the FLNRO regions...to do this, for each water body name in the FLNRO lookup table, I sort the FLNRO regions based on their
#number, low to high (e.g. 1, 2, 3 -> 7), remove the O and P from regions 7,
#and keep only the first match between a named water body and a region's water body.
  left_join(flnro_lookup %>% 
              rename(DestRegion = GNIS_NAME_) %>% 
              mutate(REGION_G = str_remove(REGION_G,"[A-Z]{1}")) %>% 
              arrange(DestRegion,REGION_G) %>% 
              group_by(DestRegion) %>% 
              slice(1)) %>% 
#Any holes in this lookup table (e.g. cities) should be filled with DestRegion values.
  mutate(REGION_N = case_when(
         is.na(REGION_N) ~ DestRegion,
         T ~ REGION_N)) %>% 
  group_by(REGION_N) %>% 
  summarise(prop = sum(PercBoatsFromPlace))

fig19_main_dat = fig19_dat %>% 
  filter(prop > 2) %>% 
  bind_rows(fig19_dat %>% 
              filter(prop <= 2) %>% 
              summarise(prop = sum(prop)) %>% 
              mutate(REGION_N = "Other")) %>% 
  arrange(desc(REGION_N)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

#Make colour palette that has 9 colours!
dark_pal_9 = brewer.pal(9, name = "Dark2") %>% str_replace("#666666","#d63735")

dark_pal_9 = c(
  `a` = "#1B9E77",
  `b` = "#D95F02",
  `c` = "#7570B3",
  `d` = "#E7298A",
  `e` = "#66A61E",
  `f` = "#E6AB02",
  `g` = "#A6761D",
  `h` = "#d63735",
  `i` = "#2999d2")

darkpal_9_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (dark_pal_9)
  dark_pal_9[cols]
}

darkpal_9_palette = list("main" = darkpal_9_cols("a","b","c","d","e","f","g","h","i"))

darkpal_9_function <- function(palette = "main", reverse = FALSE, ...) {
  pal <- darkpal_9_palette[[palette]]
  if (reverse) pal <- rev(pal)
  colorRampPalette(pal, ...)
}

scale_fill_darkpal9 <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- darkpal_9_function(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("darkpal_9_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

p19 = ggarrange(
  ggplot(fig19_main_dat,
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=0.7,force=20)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Main Destination Regions") +
  scale_fill_darkpal9() + 
  labs(fill = "Destination Region"),
  
  ggplot(fig19_dat %>% 
           filter(prop <= 2) %>% 
           arrange(desc(REGION_N)) %>% 
           mutate(lab.ypos = cumsum(prop) - 0.5*prop),
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=0.7)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Breakdown of `Other`") +
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region"),
  nrow = 1, ncol = 2)

p19

ggsave("Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19)
```

### Map 4. Home Residence Frequency of High-risk Inspections

```{r map_4_home_residence_freq_high_risk}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid %>% 
  mutate(map_label_colour = ifelse(is.na(HRInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HRInsp, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(HRInsp_b = case_when(
    HRInsp <= jenks_2 ~ 1,
    HRInsp <= jenks_3 ~ 2,
    HRInsp <= jenks_4 ~ 3,
    HRInsp <= jenks_5 ~ 4,
    HRInsp <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    HRInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    HRInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HRInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HRInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HRInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(HRInsp_b = factor(HRInsp_b, levels = c(1:5))) %>% 
  arrange(HRInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid %>% 
  filter(!(NAME_0 == 'Mexico' & is.na(HRInsp)))

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$HRInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

map_4 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>%
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(HRInsp_b),
    # Apply HTML to the labels.
    label = ~lapply(paste0("<p style = 'font-size: large;color:",map_label_colour,"'>",ABBR,"</p>"), htmltools::HTML),
    labelOptions = labelOptions(noHide = T, textOnly = T,
                                textsize = 20),
    radius = ~as.numeric(HRInsp_b)*5,
    data = sources_centroid
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~HRInsp_b,
    title = "2022 Source of High Risk Inspections",
    labFormat = function(type, cuts, p) paste0(labels),
    data = sources_centroid
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 50, lng = -100, zoom = 4)

map_4 %>% 
  mapview::mapshot(file = "Map4_Home_Residence_Frequency_HighRisk.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"),
                   vwidth = 1400, vheight = 1100)

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map4_Home_Residence_Frequency_HighRisk.jpg"))
```

### Map 5. Destination locations of High Risk Inspections

```{r dest_location_high_risk_inspections}
dest_wb = read_sf('W:/CMadsen/Projects/ZQMussels/2022 IMDP Final Report/data/spatial/Waterbodies_with_binned_and_original_values.shp') %>% 
  st_transform(crs = 4326)

dest_wb_hr = dest_wb %>% 
  mutate(HighRisk = HR_mot + HR_nnmt) %>% 
  filter(HighRisk > 0)

# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
dest_wb_hr = dest_wb_hr %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HighRisk, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(HighRisk_b = case_when(
    HighRisk <= jenks_2 ~ 1,
    HighRisk <= jenks_3 ~ 2,
    HighRisk <= jenks_4 ~ 3,
    HighRisk <= jenks_5 ~ 4,
    HighRisk <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    HighRisk_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    HighRisk_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HighRisk_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HighRisk_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HighRisk_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(HighRisk_b = factor(HighRisk_b, levels = c(1:5))) %>% 
  arrange(HighRisk_b)

my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = dest_wb_hr$HighRisk_b,
  reverse = T
)

labels = unique(dest_wb_hr$bin_label)

dest_wb_hr = st_set_geometry(dest_wb_hr, dest_wb_hr$geometry)

# Remove labels for all waterbodies below a 'yellow' level of HR inspections.
dest_wb_hr = dest_wb_hr %>% 
  mutate(GNIS_NA = ifelse(as.numeric(HighRisk_b) < 3, NA, GNIS_NA))

map_5 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolygons(
    color = 'purple',
    fillColor = 'transparent',
    weight = 2,
    data = bc_bound
  ) %>% 
  addPolygons(
    color = ~my_pal(HighRisk_b),
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(HighRisk_b),
    label = ~GNIS_NA,
    labelOptions = labelOptions(noHide = T, textOnly = T),
    data = dest_wb_hr
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~HighRisk_b,
    title = "2022 Inspections by Station",
    labFormat = function(type, cuts, p) paste0(labels),
    data = dest_wb_hr
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 53, lng = -122, zoom = 6)

map_5 %>% 
  mapview::mapshot(file = "Map5_Destination_locations_HighRisk.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"))

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map5_Destination_locations_HighRisk.jpg"))
```

### Figure 22 Pie Chart of Total Watercraft Types

```{r fig22_pie_chart_total_watercraft_types}
p22 = dat %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  mutate(TotalBoats = sum(NumberBoats)) %>% 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) %>% 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49,
                      label = paste0(name,"\n",round(PercBoats,0),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p22

ggsave("Fig22_Total_Watercraft_Type_Pie_Chart.jpg",p22)
```

### Figure 23 Pie Chart of High-Risk Watercraft Types

```{r fig23_pie_chart_HR_watercraft_types}
p23 = dat_hr %>% 
  filter(Year == my.year) %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  mutate(TotalBoats = sum(NumberBoats)) %>% 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) %>% 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x=1.49, label = paste0(name,"\n",round(PercBoats,0),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p23

ggsave("Fig23_Highrisk_Watercraft_Type_Pie_Chart.jpg",p23)
```


### Figure 24 Mussel-fouled By Month All Years
```{r fig24_musselfouled_by_month_all_years}
#If an excel sheet can be found in the Final Report > my.year > GIS Maps and Excel Figures folder, use that. We make this excel sheet automatically below, and it can be updated by hand after its creation.

if(file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
  mf_time_table = read_excel(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

#If that file does not yet exist...
if(!file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
#Read in the hand-cleaned excel sheet from 2020 report, and add more recent data to it.
mf_time_table = read_excel("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/2020/GIS Maps and Excel Figures/ExcelFigureData/2019_Fig24_MusselFouled_byMonth_2017-2020.xlsx",sheet = "dat_for_R")

#Add my.year (and any intervening years between 2020 and my.year, if there are any)'s mf data to the excel sheet.
mf_time_table = mf_time_table %>% 
  bind_rows(dat_mf %>% 
              mutate(Month = month(TimeOfInspection, label = T, abbr = F)) %>% 
              filter(Year %in% 2021:my.year) %>% 
              group_by(Year,Month) %>% 
              summarise(Number = n()) %>% 
              pivot_wider(names_from = Month, values_from = Number) %>% 
              mutate(Year = 2021:my.year)) %>% 
  mutate(across(c(April:November), ~ replace_na(.x, 0))) %>% 
  ungroup() %>% 
  mutate(Total = (April+May+June+July+August+September+October+November))

#Save the excel file in my.year's folder.
write.xlsx(mf_time_table, paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

p24 = mf_time_table %>% 
  pivot_longer(-Year) %>% 
  filter(name != "Total") %>% 
  rename(Month = name) %>% 
  mutate(NumberBoats = as.numeric(value),
         Month = factor(Month,levels = c("April","May","June","July","August","September","October","November"))) %>% 
  mutate(Year = factor(Year, levels = c(2015:my.year))) %>% 
  ggplot() + 
  geom_col(aes(x = Month, y=NumberBoats, fill=Year), col="black", position=position_dodge2(width = 0.5, preserve = "single")) + 
  scale_fill_brewer(palette = "Dark2") + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) + 
  labs(x = "", y = "Mussel Fouled Boats")

p24

ggsave("Fig24_Musselfouled_by_Month.jpg",p24)

```

### Figure 25 Source Provinces / States for Mussel-fouled Boats
```{r fig25_source_province_states_for_musselfouled}
p25 = dat_mf %>% 
  filter(Year == 2021) %>% 
  rename(prev = Previous_Waterbody_1_Province_Or_State) %>% 
  group_by(prev) %>% 
  summarise(NumberBoats = n()) %>% 
  left_join(abbrev %>% rename(prev = Abbrev)) %>% 
  arrange(desc(prev)) %>% 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) %>% 
  ggplot(aes(x = "", y = NumberBoats, 
           fill = Province_or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Province_or_State,", ",NumberBoats)), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p25

ggsave("Fig25_MusselFouled_Source_Regions_Pie_Charts.jpg",p25)

```

### Figure 26 Destination Regions of Mussel-fouled Inspections

```{r fig26_pie_chart_destination_locations_MF_Insp}
fig26dat = read_excel(MusselFouledTracker,
                      sheet = MF_tracker_sheet)

p26 = fig26dat %>% 
  group_by(Region) %>% 
  reframe(Number = sum(Number)) %>% 
  arrange(desc(Region)) %>% 
  mutate(lab.ypos = cumsum(Number) - 0.5*Number) %>% 
  ggplot(aes(x = "", y = Number, 
           fill = Region)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.2)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") +
  theme(legend.position = "none")

p26

ggsave("Fig26_MusselFouled_Destination_Regions_Pie_Charts.jpg",p26)
```

### Figure 27. Map 6. Source Location of Mussel-fouled Watercraft

```{r source_for_mussel_fouled}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid %>% 
  mutate(map_label_colour = ifelse(is.na(MFInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(MFInsp, k = 4))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(MFInsp_b = case_when(
    MFInsp <= jenks_2 ~ 1,
    MFInsp <= jenks_3 ~ 2,
    MFInsp <= jenks_4 ~ 3
  )) %>%
  mutate(bin_label = case_when(
    MFInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    MFInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    MFInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4)
  )) %>% 
  mutate(MFInsp_b = factor(MFInsp_b, levels = c(1:3))) %>% 
  arrange(MFInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid %>% 
  filter(!(NAME_0 == 'Mexico' & is.na(MFInsp))) %>% 
  # And remove the row for BC.
  filter(NAME_1 != 'British Columbia')

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$MFInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

map6 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>%
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(MFInsp_b),
    # Apply HTML to the labels.
    label = ~lapply(paste0("<p style = 'font-size: large;color:",map_label_colour,"'>",ABBR,"</p>"), htmltools::HTML),
    labelOptions = labelOptions(noHide = T, textOnly = T,
                                textsize = 20),
    radius = ~as.numeric(MFInsp_b)*5,
    data = sources_centroid
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~MFInsp_b,
    title = "2022 Mussel Fouled Inspections",
    labFormat = function(type, cuts, p) paste0(labels),
    data = sources_centroid
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 50, lng = -100, zoom = 4)

map6 %>% 
  mapview::mapshot(file = "map6_Source_of_MF_boats.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"))

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/map6_Source_of_MF_boats.jpg"))
```

### Figure 28 Pie Chart of Mussel-fouled Watercraft Types

```{r fig28_pie_chart_MF_watercraft_types}
p28 = dat_mf %>% 
  filter(Year == 2021) %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) %>% 
  ggplot(aes(x = "", y = NumberBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(name,"\n",NumberBoats)), 
            color = "black",nudge_x=0.4) +
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p28

ggsave("Fig28_Musselfouled_Watercraft_Type_Pie_Chart.jpg",p28)
```

### Figure 29 Commercially Hauled Boats

```{r fig29_commercially_hauled_boats}
p29 = dat %>% 
  filter(Commercially_Hauled_Ind == T,
         Station != "Hwy 97c") %>% 
  filter(!Station %in% c("Scheduled Inspection","Penticton Roving")) %>% 
  group_by(Station) %>% 
  summarise(NumberBoats = n()) %>% 
  arrange(desc(NumberBoats)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberBoats),fill = my.grey, width = 0.40) +
  geom_text(aes(x=Station,y=NumberBoats+0.05*max(NumberBoats),label=NumberBoats)) +
  labs(y = "Commercially Hauled Boats") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p29

ggsave("Fig29_Commerically_Hauled_by_Station.jpg",p29)

```

### Map 7. Commercially Hauled Boat Source Locations

```{r map7_commercially_hauled_boat_sources}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid %>% 
  mutate(map_label_colour = ifelse(is.na(CHInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid %>% 
  mutate(jenks = list(BAMMtools::getJenksBreaks(CHInsp, k = 6))) %>% 
  unnest_wider(jenks, names_sep = '_') %>% 
  mutate(CHInsp_b = case_when(
    CHInsp <= jenks_2 ~ 1,
    CHInsp <= jenks_3 ~ 2,
    CHInsp <= jenks_4 ~ 3,
    CHInsp <= jenks_5 ~ 4,
    CHInsp <= jenks_6 ~ 5,
  )) %>%
  mutate(bin_label = case_when(
    CHInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    CHInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    CHInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    CHInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    CHInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) %>% 
  mutate(CHInsp_b = factor(CHInsp_b, levels = c(1:5))) %>% 
  arrange(CHInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid %>% 
  filter(!(NAME_0 == 'Mexico' & is.na(CHInsp)))

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$CHInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

map7 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>%
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~my_pal(CHInsp_b),
    # Apply HTML to the labels.
    label = ~lapply(paste0("<p style = 'font-size: large;color:",map_label_colour,"'>",ABBR,"</p>"), htmltools::HTML),
    labelOptions = labelOptions(noHide = T, textOnly = T,
                                textsize = 20),
    radius = ~as.numeric(CHInsp_b)*5,
    data = sources_centroid
  ) %>% 
  addLegend(
    pal = my_pal,
    values = ~CHInsp_b,
    title = "2022 Commercially Hauled Inspections",
    labFormat = function(type, cuts, p) paste0(labels),
    data = sources_centroid
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 50, lng = -100, zoom = 4)

map7 %>% 
  mapview::mapshot(file = "Map7_Commercially_Hauled_Watercraft_Sources.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"),
                   vwidth = 1400, vheight = 1100)

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map7_Commercially_Hauled_Watercraft_Sources.jpg"))
```

### Map 8. Lake Monitoring Plankton Sample Tows

```{r map8_lake_monitoring_figure}
lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab Analysis/Final report and data/BC Veliger Sampling Inventory 2022_FinalReport.xlsx'))

lab_sf = lab_dat %>% 
  dplyr::rename(
    lat = `Lat (Decimal degrees)`,
    lng = `Long (Decimal degrees)`
  ) %>% 
  mutate(lat = as.numeric(lat),
         lng = as.numeric(lng)) %>% 
  st_as_sf(coords = c("lng","lat"),
           crs = 4326)

sampling_pal = leaflet::colorFactor(
  palette = 'Dark2',
  domain = lab_sf$`sampling group/agency`
)

map8 = leaflet() %>% 
  addProviderTiles(providers$CartoDB) %>% 
  addPolygons(
    color = 'purple',
    fillColor = 'transparent',
    weight = 2,
    data = bc_bound
  ) %>% 
  addCircleMarkers(
    color = 'black',
    weight = 1,
    fillOpacity = 0.8,
    fillColor = ~sampling_pal(`sampling group/agency`),
    data = lab_sf
  ) %>% 
  addLegend(
    pal = sampling_pal,
    values = ~`sampling group/agency`,
    title = "2022 Invasive Mussel Lake Monitoring",
    data = lab_sf
  ) %>% 
  addScaleBar('bottomleft',
              options = scaleBarOptions(maxWidth = 300)) %>% 
  setView(lat = 52.75, lng = -121.5, zoom = 6)

map8 %>% 
  mapview::mapshot(file = "Map8_Map_of_Lake_Sampling.jpg",
                   remove_controls = c("zoomControl","layersControl","homeButton"))

knitr::include_graphics(paste0(my_opts$zqm_figure_output_remote_folder,"/",my_opts$year,"/GIS Maps and Excel Figures/ExcelFigures/Map8_Map_of_Lake_Sampling.jpg"))
```

### Figure 30 
```{r fig30_CBSA_Notifications}
if(exists("cbsa_dat")){
cbsa_dat = cbsa_dat %>% 
  filter(!is.na(Categories)) %>% 
  mutate(Categories = str_to_upper(Categories)) %>% 
  mutate(Categories = str_remove_all(Categories, " -")) %>% 
  mutate(Subtype = str_extract(Categories, "(?<=CBSA ).*")) %>% 
  mutate(Categories = str_remove_all(Categories, "(?<=CBSA).*")) %>% 
  mutate(Year = my.year) %>% 
  mutate(Categories = case_when(
    Categories %in% c("NEW BOATS","NEW BOAT SHIPMENT") ~ "NEW BOATS",
    str_detect(Categories, "INVASIVE SPECIES") ~ "ISCBC",
    T ~ Categories
  )) %>% 
  mutate(Subtype = coalesce(Subtype, Categories)) %>% 
  mutate(Categories = case_when(
    Categories %in% c("USA","US","US STATE","ID","MT") ~ "USA",
    Categories %in% c("AB","SK","MB") ~ "PROVINCES",
    T ~ Categories
  )) %>% 
  count(Categories, Subtype, sort = T)

p30 = cbsa_dat %>% 
  group_by(Categories) %>% 
  summarise(group_n = sum(n)) %>%
  ungroup() %>% 
  arrange(group_n) %>% 
  mutate(Categories = fct_inorder(Categories)) %>% 
  ggplot() + 
  geom_col(aes(group_n, Categories, fill = Categories), col = "black") + 
  geom_text(aes(group_n/2, Categories, label = group_n), size = 5) +
  theme_light() +
  theme(text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(y = "", x = "Number of Notifications",
       title = "CBSA Notification Categories",
       subtitle = my.year)

p30

ggsave("Fig30_Percent_Previous_Knowledge.jpg",p30)
}
```

### Figure 32 Previous Knowledge

```{r fig32_previous_knowledge}
#Remove Penticton Roving
fig32_dat = dat %>% 
  filter(!Station %in% rovers_to_drop) %>% 
  group_by(Station, Previous_AIS_Knowledge_Ind) %>%
  summarise(Number = n()) %>% 
  mutate(TotalPerStation = sum(Number)) %>% 
  mutate(Diff = case_when(
    row_number() %% 2 != 0 ~ Number-lead(Number),
    row_number() %% 2 == 0 ~ -Number + lag(Number))) %>%
  mutate(Diff = 100*Diff/TotalPerStation) %>% 
  arrange(Diff) %>% 
  ungroup() %>% 
  filter(Previous_AIS_Knowledge_Ind == T) %>% 
  left_join(station_types) %>% 
  left_join(station_types) %>% 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) %>% 
  mutate(StationLabel = fct_inorder(StationLabel)) %>% 
  ungroup() %>% 
  mutate(prop = 100*Number/TotalPerStation) %>% 
  mutate(StationType_T = paste0(StationType, Previous_AIS_Knowledge_Ind))
  
#Add in dummys for FALSE of Previous_AIS_Knowledge_Ind to make backdrop of plot.
fig32_dat = fig32_dat %>% 
  mutate(prop_queda = 100-prop) %>% 
  pivot_longer(cols = c(prop, prop_queda), names_to = "Prop_type",values_to = "prop") %>% 
  mutate(Previous_AIS_Knowledge_Ind = replace(Previous_AIS_Knowledge_Ind, Prop_type == "prop_queda", "FALSE")) %>% arrange(desc(Previous_AIS_Knowledge_Ind), Station)

p32 = ggplot() + 
  geom_col(data = fig32_dat,
           aes(x=StationLabel,y=prop,fill = Previous_AIS_Knowledge_Ind),
           col = "black", width = 0.4) + 
  labs(y = "Percent Previous Knowledge",fill = "") + 
  theme_classic() +
  scale_fill_manual(breaks = c("TRUE","FALSE"),
                    values = c("TRUE" = my.grey,
                               "FALSE" = "grey"),
                    labels = c("Yes","No")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))
  
p32

ggsave("Fig32_Percent_Previous_Knowledge.jpg",p32)
```

### Figure 33 Primary Sources of Previous Knowledge

```{r fig33_primary_sources_previous_knowledge}
p33 = dat %>% 
  rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) %>% 
  #Join the lookup table for previous AIS knowledge
  left_join(ais_know %>% 
              rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) %>% 
              mutate(ais_know_id = as.character(ais_know_id)) %>% 
              select(Description, ais_know_id)) %>% 
  #Only keep records that have some kind of previous AIS knowledge.
  filter(!is.na(Description)) %>% 
  #Get the number of records for each knowledge source
  group_by(Description) %>% 
  summarise(Number = n()) %>% 
  #Calculate the percentage for each knowledge source
  mutate(Total = sum(Number)) %>% 
  mutate(prop = 100*Number/Total) %>% 
  #Put all knowledge sources below 1% into a single category called 'Other', label the groups for all knowledge sources >= 1% with their descriptions.
  mutate(Grouper = case_when(
    prop >= 1 ~ Description,
    T ~ "Other"
  )) %>% 
  #Add together proportions within each of these groups. This combines the "Other" group.
  group_by(Grouper) %>% 
  summarise(prop = sum(prop)) %>% 
  arrange(desc(Grouper)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  ggplot(aes(x = "", y = prop, 
           fill = Grouper)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text_repel(aes(y = lab.ypos, x = 1.15, label = paste0(round(prop,0), "%")),
                   size = 4.5, nudge_x = 1, force_pull = 0.5,force = 1000) +
  #geom_text(aes(y = lab.ypos, label = paste0(Grouper,", ",round(prop,0),"%")), 
#            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Knowledge Source") +
  scale_fill_brewer(palette = "Dark2")

p33

ggsave("Fig33_Primary_Sources_Previous_AIS_Knowledge.jpg",p33)
```