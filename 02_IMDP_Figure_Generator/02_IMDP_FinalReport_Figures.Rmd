---
title: "02_IMDP_FinalReport_Figures"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
fig_width: 8
---

```{r setup, include=FALSE}

# NOTE: this script uses tmap version 3.3. That is no longer the version available by default when you use install.packages(). The new version completely alters the plots produced.
# You may need to manually install tmap version 3.3.
# install.packages("C:/Users/CMADSEN/Downloads/tmap_3.3.tar.gz", repos = NULL, type = "source")
# This may require that you also install: {widgetframe}.

pacman::p_load(
readxl,
ggpubr,
ggrepel,
plotly,
ggExtra,
ggtext,
tidyverse,
leaflet,
sf,
RColorBrewer,
openxlsx,
scales,
lubridate,
plotrix,
basemaps,
ggplot2)

#=====================================================
#                       OPTIONS 
#=====================================================
# setwd("C:/Users/CMADSEN/Downloads/LocalR/long_term_projects/ZQMussels")
my_opts = read_csv(paste0(here::here(),"/Options.csv"))

#Which year should we focus on?
my.year = 2024
# my.year = 2025

#Update GIS maps? We probably want this turned on unless you are making fine adjustments to some figures.
update.gis = FALSE

# Are there any station names we want to change / correct?
stations.to.change = data.frame(
  Station = c('Fraser Valley Roving'),
  new_name = c('Lower Mainland Roving')
)

# Are there any station names we want to change / correct?
stations.to.change = data.frame(
  Station = c('Fraser Valley Roving'),
  new_name = c('Lower Mainland Roving')
)

#Are there any stations we would like to exclude from the excel-type figures?
#In 2021, we will exclude:
if(my.year == 2022){
  stations.to.include = c("Golden","Dawson Creek","Mt. Robson",
                          "Osoyoos","Olsen","Penticton Roving",
                          "Radium","Pacific","Fraser Valley Roving",
                          "Keremeos")
  
  stations.to.put.aside = c("Scheduled Inspection","Boat Launch - Okanagan",
                            "Okanagan",
                            "Penticton Roving - Hwy 33", 
                            "Penticton Roving - Inspection Event")
}
if(my.year == 2023){
  stations.to.include = c("Golden","Radium","Olsen","Yahk",
                          "Pacific","Osoyoos","Hwy 97c","Mt. Robson",
                          "Keremeos","Dawson Creek","Lower Mainland Roving",
                          "Sumas Border","Cutts (Hwy 93)","Penticton Roving")
  stations.to.put.aside = c("Scheduled Inspection","Boat Launch - Okanagan",
                            "Okanagan",
                            "Penticton Roving - Hwy 33", 
                            "Penticton Roving - Inspection Event")
}
if(my.year == 2024){
  stations.to.include = c("Golden","Radium","Olsen","Yahk",
                          "Pacific","Osoyoos","Hwy 97c","Mt. Robson",
                          "Keremeos (Hwy 3)","Dawson Creek","Lower Mainland Roving",
                          "Sumas Border","Cutts (Hwy 93)","Penticton Roving",
                          "Douglas Crossing")
  stations.to.put.aside = c("Scheduled Inspection","Boat Launch - Okanagan",
                            "Okanagan",
                            "Penticton Roving - Hwy 33", 
                            "Penticton Roving - Inspection Event")
}
permanent.stations = c("Golden","Olsen","Yahk",
                       "Osoyoos","Mt. Robson",
                       "Dawson Creek")

roving.stations = c("Penticton Roving","Lower Mainland Roving",
                    "Keremeos (Hwy 3)","Sumas Border","Pacific",
                    "Cutts (Hwy 93)","Douglas Crossing", "Hwy 97c")

part.time.stations = c("Sumas Border","Pacific","Cutts (Hwy 93)","Radium","Douglas Crossing")
# Just in case it's different, which stations do we want to show in the 
# leaflet maps?
if(my.year == 2022){
  leaflet.stations.to.include = c("Golden","Radium","Olsen","Dawson Creek",
                                  "Mt. Robson","Penticton Roving","Osoyoos","Fraser Valley Roving")
} 
if(my.year == 2023){
  leaflet.stations.to.include = c("Golden","Olsen","Dawson Creek","Mt. Robson",
                                  "Penticton Roving","Osoyoos","Lower Mainland Roving",
                                  "Yahk")
}
if(my.year == 2024){
  leaflet.stations.to.include = c(
    "Golden","Olsen","Dawson Creek","Mt. Robson",
    "Radium","Sumas Border",
    "Penticton Roving","Osoyoos","Lower Mainland Roving",
    "Yahk","Pacific",
    "Keremeos (Hwy 3)","Hwy 97c","Cutts (Hwy 93)","Douglas Crossing")
}

#Data folders
my.data.folder = paste0(my_opts$zqm_figure_local_folder,"data/")
my.external.data.folder = paste0(my_opts$remote_spatial_data,"Projects/ZQMussels/data/")

#Which folder should we put specific output files in?
my.output.folder = paste0(my_opts$zqm_figure_local_folder,"output/")
my.external.output.folder = paste0(my_opts$zqm_figure_output_remote_folder,my.year)
zqm.operations.folder = my_opts$zqm_operations_data_folder
this.years.report.folder = paste0(my_opts$remote_spatial_data,"Projects/ZQMussels/",my.year," IMDP Final Report/")

#Where is the mussel-fouled tracking sheet?
if(my.year == 2022){
MusselFouledTracker = paste0(my_opts$zqm_operations_data_folder,"Watercraft Inspection Data/", my.year," data/2022 mussel fouled boats tracking sheet.xlsx")
}
if(my.year == 2023){
  MusselFouledTracker = paste0(my_opts$zqm_operations_data_folder,"Watercraft Inspection Data/", my.year," data/2023_mussel_fouled_details.xlsx")
}
if(my.year == 2024){
  MusselFouledTracker = paste0(my_opts$zqm_operations_data_folder,"Watercraft Inspection Data/", my.year," data/mussel_fouled_summary.xlsx")
}
#What is the sheet name of the destination regions for the mussel fouled tracking sheet?
if(my.year != 2024){
  MF_tracker_sheet = "DestRegions"
}
if(my.year == 2024){
  MF_tracker_sheet = "Final List"
}

#Where can we find the CBSA notifications excel sheet for this year?
if(file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/",my.year," COS inbox notifications.xlsx"))){
  cbsa_dat = read_excel(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/",my.year," COS inbox notifications.xlsx"),
                 sheet = "Filtered list")
}

#These lines below set options for all of the code for the rest of this script. You probably don't need to change any of these.
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = F, fig.width = 8, fig.height = 4)
knitr::opts_knit$set(root.dir = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures"))

#Colour for some of the figures:
my.grey = "#5f6a6f"

#=====================================================
#                     END OF OPTIONS
#=====================================================

#If there is no folder for excel figures for the target year in the I: drive, make it now.
if(!dir.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures"))){
  dir.create(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/"),
             recursive = T)
}
```




```{r load in data}
if(!exists('dat')){
  dat = read.xlsx(paste0(my.data.folder,'figure_dat.xlsx')) |> 
    mutate(TimeOfInspection = convertToDateTime(TimeOfInspection)) |> 
    as_tibble()
}

if(!exists('dat_all')){
  dat_all = read.xlsx(paste0(my.data.folder,'figure_dat_all.xlsx')) |>
    mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) |> 
    as_tibble()
}

# In case the 'figure_dat.xlsx' file has been updated past the year we 
# are currently working on (e.g., I've run the imdp code for 2023 but now
# we're looking back at 2022 data... sigh)
if(dat[1,]$Year != my.year){
  dat = dat_all |> 
    dplyr::filter(Year == my.year)
}

if(!exists('dat_hr')){
  dat_hr = read.xlsx(paste0(my.data.folder,'figure_dat_hr.xlsx')) |> 
    mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) |> 
    as_tibble()
}

if(!exists('dat_mf')){
  dat_mf = read.xlsx(paste0(my.data.folder,'figure_dat_mf.xlsx')) |>
    mutate(TimeOfInspection = openxlsx::convertToDateTime(TimeOfInspection)) |> 
    as_tibble()
}

flnro_lookup = read_excel(paste0(my.external.data.folder,"waterbody_name_flrno_region_lookup_table.xlsx")) |> distinct()

abbrev = read_excel(paste0(my.external.data.folder,"Province_States_Abbreviation_Table.xlsx"))

#Lookup table for what the Previous Knowledge of AIS field's codes mean.
ais_know = read_excel(paste0(my.external.data.folder,"Previous_Knowledge_of_AIS_lookup_table.xlsx"))

# Outline of BC
bc_bound = bcmaps::bc_bound() |> st_transform(crs = 4326)
```

```{r optional_pulling_out_boat_launches_from_comments}
# Pull out different boat launches, scheduled inspections, etc. from,
# mostly, Penticton Roving and Fraser Valley Roving.
dat_all = dat_all |> 
  dplyr::mutate(Station = dplyr::case_when(
    # Pull out boat launches.
    # 1. Scheduled Inspections / Decons
    Station %in% c("Fraser Valley Roving","Penticton Roving") & str_detect(Shift_Start_Comment, '([iI]nspection|[dD]econ|[dD]eacon|Deco|[sS]cheduled)') ~ 'Scheduled Inspection/Decontamination',
    Station == 'Scheduled Inspection' & str_detect(Shift_Start_Comment,"([r,R]ichmond|[d,D]ockside)") ~ 'Lower Mainland Scheduled Inspection',
    Station == 'Scheduled Inspection' & str_detect(Shift_Start_Comment,"([l,L]ake [c,C]ountry|[l,L]akehouse|Martin|martin|MARTIN|[p,P]enticton|[k,K]elowna)") ~ 'Penticton Scheduled Inspection',
    # 2. Multiple boat launches visited...
    str_detect(Shift_Start_Comment,"([kK]ekuli|[kK]akuli).*([gG]elatley|[gG]ellatley)") ~ 'Multiple',
    str_detect(Shift_Start_Comment,"([gG]elatley|[gG]ellatley).*([kK]ekuli|[kK]akuli)") ~ 'Multiple',
    str_detect(Shift_Start_Comment,"Skaha") & str_detect(Shift_Start_Comment,"summerland")~ "Boat Launch - Multiple",
    # 3. Single boat launch visited.
    # Okanagan Boat Launch mentions Kelowna and then kabuki bay, Eldorado boat launch, etc.
    str_detect(Shift_Start_Comment,".*kabuki bay.*Eldorado") ~ 'Boat Launch - Okanagan Lake',
    str_detect(Shift_Start_Comment,"([kK]ekuli|[kK]akuli)") ~ 'Boat Launch - Kekuli Bay',
    str_detect(Shift_Start_Comment,"([gG]ellatly|[gG]ellatley)") ~ 'Boat Launch - Gellatly Bay',
    str_detect(Shift_Start_Comment,"([cC]ultus)") ~ 'Boat Launch - Cultus Lake',
    str_detect(Shift_Start_Comment,"([aA]l(l)?ouette)") ~ 'Boat Launch - Alouette Lake',
    str_detect(Shift_Start_Comment,"([sS]tave)") ~ 'Boat Launch - Stave Lake',
    str_detect(Shift_Start_Comment,"([kK]awkawa)") ~ 'Boat Launch - Kawkawa Lake',
    str_detect(Shift_Start_Comment,"[cC]hristina") ~ "Boat Launch - Christina Lake",
    Station == 'Christina Lake' ~ 'Boat Launch - Christina Lake',
    str_detect(Shift_Start_Comment,"[sS]kaha") ~ "Boat Launch - North Skaha",
    str_detect(Shift_Start_Comment,"[pP]each") ~ "Boat Launch - Peachland Yacht Club",
    str_detect(Shift_Start_Comment,"(Summerland|summer( )?land|Summer( )?[lL]and)") ~ "Boat Launch - Summerland",
    # No specific boat launch mentioned, but the words "boat launch" mentioned.
    stringr::str_detect(Shift_Start_Comment,"[bB]oat( )?[lL]aunch") ~ 'Boat Launch',
    # Pull out specific stations
    str_detect(Shift_Start_Comment, '(hwy|Hwy)?( )?97( )?[cC]') ~ 'Penticton 97C',
    str_detect(Shift_Start_Comment, '(hwy|Hwy)( )?3') ~ 'Hwy 3',
    str_detect(Shift_Start_Comment, '[kK]eremeos') ~ 'Keremeos (Hwy 3)',
    T ~ Station
  ))
```

```{r change_station_names_and_establish_list_of_rovers}
# Apply station name correction(s)
dat = dat |> 
  dplyr::left_join(stations.to.change) |> 
  dplyr::mutate(Station = ifelse(!is.na(new_name), new_name, Station))

dat_all = dat_all |> 
  dplyr::left_join(stations.to.change) |> 
  dplyr::mutate(Station = ifelse(!is.na(new_name), new_name, Station))

#Establish colour scheme for roving stations that we keep.
if(my.year == 2022){
rovers = data.frame(Station = c("Hwy 97c","Keremeos","Greenwood","Kaleden",
                                "Lower Mainland Roving","Pacific",
                                "Penticton Roving"),
                    StationType = "Roving")
}
if(my.year == 2023){
  rovers = data.frame(Station = c("Hwy 97c","Keremeos (Hwy 3)","Greenwood","Kaleden",
                                "Lower Mainland Roving","Pacific",
                                "Sumas Border",
                                "Penticton Roving","Cutts (Hwy 93)"),
                    StationType = "Roving")
}
if(my.year == 2024){
  rovers = data.frame(Station = c("Hwy 97c",
                                  "Keremeos (Hwy 3)","Greenwood","Kaleden",
                                  "Lower Mainland Roving","Pacific",
                                  "Sumas Border",
                                  "Penticton Roving",
                                  "Cutts (Hwy 93)",
                                  "Douglas Crossing"),
                    StationType = "Roving")
}
if(my.year == 2025){
  rovers = data.frame(Station = c("Hwy 97c","Keremeos (Hwy 3)","Greenwood","Kaleden",
                                "Lower Mainland Roving","Pacific",
                                "Sumas Border",
                                "Penticton Roving","Cutts (Hwy 93)"),
                    StationType = "Roving")
}

station_types = bind_rows(rovers,
          data.frame(Station = dat |> 
                       select(Station) |> 
                       filter(!Station %in% rovers$Station) |> 
                       distinct() |> 
                       pull(Station),
                     StationType = "Permanent"))
rm(rovers)
```

```{r establish_rovers_to_drop}
#Make one more vector of stations that we want to drop in the figures. These are roving stations.
if(my.year == 2022){
  rovers_to_drop = c("Scheduled Inspection","Other","Okanagan","Sumas Border")
} 
if(my.year == 2023){
  rovers_to_drop = c("Other","Okanagan",
                     "Scheduled Inspection (Other Notification)",
                     "Scheduled Inspection (Cbsa Notification)")
}
if(my.year == 2024){
  rovers_to_drop = c("Other","Okanagan",
                     "Scheduled Inspection (Other Notification)",
                     "Scheduled Inspection (Cbsa Notification)")
}
if(my.year == 2025){
  rovers_to_drop = c("Other","Okanagan",
                     "Scheduled Inspection (Other Notification)",
                     "Scheduled Inspection (Cbsa Notification)")
}
```

```{r not_sure_if_we_should_do_this_block}
# Apply corrections to some of the Lower Mainland or Penticton Roving station names, using information that was places in the shift start comment field.
dat = dat |>
  mutate(Station = case_when(
    str_detect(Shift_Start_Comment,"[s,S]cheduled") ~ 'Scheduled Inspection (Other Notification)',
    str_detect(Station, "Roving$") & str_detect(Shift_Start_Comment,'97') ~ 'Hwy 97c',
    T ~ Station
  ))
```

```{r numbers_for_exec_summary}
min_date = paste(lubridate::month(min(dat$TimeOfInspection),label = TRUE, abbr = F),
                  lubridate::day(min(dat$TimeOfInspection)))

max_date = paste(lubridate::month(max(dat$TimeOfInspection),label = TRUE, abbr = F),
                  lubridate::day(max(dat$TimeOfInspection)))

print(paste0("Stations active in ",my.year," from ",min_date," to ",max_date))

print(paste0('Inspections by Station in ',my.year))

dat |> 
  dplyr::count(Station, sort = T) |> 
  knitr::kable()

print(paste0('Inspections by Month in ',my.year))

dat |> 
  dplyr::mutate(the_month = lubridate::month(TimeOfInspection, label = T, abbr = F)) |> 
  dplyr::count(the_month) |> 
  knitr::kable()

# Number of stations, split by type.
print('Stations and Station Type')

station_types |> 
  dplyr::filter(!Station %in% rovers_to_drop) |> 
  dplyr::add_count(StationType) |> 
  knitr::kable()

print('Approximate number of inspections and person interactions')

data.frame(
  total_inspections = nrow(dat),
  total_interactions = sum(dat$Number_Of_People_In_Party,na.rm=T)
) |> 
  knitr::kable()

print("High Risk:")

#Turn to Metabase - just in case some filtering steps have dropped some of these
data.frame(
  number_highrisk = nrow(dat_hr |> dplyr::filter(Year == my.year)),
  decons_issued = sum(dat$Decontamination_order_issued_Ind,na.rm=T),
  deconts_performed = sum(dat$Decontamination_Performed_Ind,na.rm=T),
  quarantine_periods = sum(dat$Quarantine_Period_Issued_Ind,na.rm=T)
) |> 
  knitr::kable()

state_longnames = data.frame(abbr = state.abb, long = state.name)
prov_names = data.frame(abbr = c("AB","BC","MB","ON","QC","YT","SK","NS"),
                        long = c("Alberta","British Columbia",
                                 "Manitoba","Ontario","Quebec","Yukon","Saskatchewan","Nova Scotia"))
state_longnames = dplyr::bind_rows(
  state_longnames,
  prov_names
)

tracked_mf = read.xlsx(MusselFouledTracker, sheet = MF_tracker_sheet)

print('Mussel Fouled: Source Prov/State')

if(my.year == 2023){
  tracked_mf |> 
    dplyr::count(BIG.SOURCE.SUMMARY) |> 
    dplyr::rename(name = BIG.SOURCE.SUMMARY) |> 
    arrange(desc(n)) |> 
    knitr::kable()
}

print('Mussel Fouled: Destination Region')
if(my.year == 2023){
  data.frame(
    destination_region = c("Thompson-Okanagan","Lower Mainland","Northeast","Kootenay-Boundary"),
    number = c(8,4,1,1)
  ) |> 
    knitr::kable()
}


print("Previous Warning for MF Boat - not currently calculated in this code...")

print("For Compliance stats, please see below...")

print("Lake sampling numbers")

# ld = openxlsx::read.xlsx(paste0(my_opts$base_dir,"04_Extra_Figures_and_Scripts/CRB/output/2023_Provincial_PlanktonTow_LabResults_CRB_Format.xlsx"))
# 
# # Fill in data gaps for waterbody name with info in the sampling location column.
# # Note that these values do not always name the lake...
# ld = ld |> 
#   dplyr::mutate(wb_name_fill_na = ifelse(is.na(Water.Body.Name), Sampling.Location.Description, Water.Body.Name))
#   
# # Number of samples, unique wb names or sampling locatoins, and unique wb names
# data.frame(
#   number_of_samples = nrow(ld),
#   number_of_unique_wb_names_or_sampling_locations = length(unique(ld$wb_name_fill_na)),
#   number_of_unique_wb_names = length(unique(ld$Water.System.Name))
# ) |> 
#   knitr::kable()
```

### Map 1. Inspection Stations by Type

```{r inspection_stations_by_type, fig.width=800}



# See which stations we have data for in this year.
stations_active = dat |> 
    dplyr::mutate(Station = dplyr::case_when(
      str_detect(Station,"Lower Mainland") ~ "Lower Mainland Roving",
      T ~ Station
    )) |> 
    dplyr::count(Station) |> 
    dplyr::filter(n >= 2) |> 
    dplyr::pull(Station)

# Grab inspection stations shapefile.
stations = read_sf(paste0(
  my_opts$remote_spatial_data,
  'Projects/ZQMussels/data/inspection_stations.gpkg')
) |> 
  dplyr::mutate(
    map_label = ifelse(
      map_label == 'Fraser Valley Roving', 
      'Lower Mainland',
      map_label),
    station_name = ifelse(
      station_name == 'Fraser Valley Roving',
      'Lower Mainland Roving',
      station_name)
  ) |> 
  dplyr::mutate(map_label = ifelse(map_label == 'Penticton Roving','Penticton',map_label)) |> 
  dplyr::mutate(station_type = dplyr::case_when(
    station_name %in% permanent.stations ~ station_type,
    station_name %in% part.time.stations ~ "Part-time Inspection Station",
    station_name %in% roving.stations ~ "Roving Inspection Crew"
  )) |> 
  dplyr::mutate(station_type = factor(station_type, levels = c("Permanent Inspection Station","Part-time Inspection Station","Roving Inspection Crew")))

# adding stations that are not currently present in the data
new_stations<-data.frame(station_name = c("Douglas Crossing"), map_label = c("Douglas \nCrossing"), lat = c(49.0061439), lon =c(-122.75759020128658),
                         lat_sf = c(49.0061439), lon_sf =c(-122.75759020128658),hours_of_operation = c("Unknown"), station_type = c("Part-time Inspection Station")) |> 
  st_as_sf(coords = c("lon_sf", "lat_sf"), crs = 4326) %>%
  { if ("geometry" %in% names(.)) rename(., geom = geometry) else . } # if the name is geometry, change it to geom
  
stations = rbind(stations, new_stations)


#stations should be what we use as a base, at all times

```


```{r map1_plotting, fig.width=800}

# Drop stations from leaflet maps that we did not want to keep.
stations = stations |> 
  filter(station_name %in% leaflet.stations.to.include) |> 
  dplyr::filter(!station_name %in% rovers_to_drop)

stations_for_maps = stations |> 
  mutate(station_type = replace(station_type, station_type == 'Unknown', 'Roving')) |> 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium')) |> 
  dplyr::filter(station_name %in% stations_active)

# Ugh. Time to make some hand-drawn locations for the labels...
station_labels = stations_for_maps |> 
  # Correct Peace Arch to Douglas Crossing
  # dplyr::mutate(map_label = ifelse(map_label == "Peace Arch","Douglas \nCrossing",map_label)) |>
  # Correct Sumas Border to just "Sumas"
  dplyr::mutate(map_label = ifelse(map_label == "Sumas Border","Sumas",map_label)) |> 
  sf::st_drop_geometry() |> 
  dplyr::mutate(lat = lat + 0.25) |> 
  dplyr::mutate(lat = case_when(
    map_label == 'Lower Mainland' ~ lat + 0.1,
    map_label == 'Penticton' ~ lat - 0.1,
    map_label == "Sumas" ~ lat - 0.5,
    map_label == "Yahk" ~ lat - 0.5,
    map_label == "Douglas Crossing" ~ lat - 0.5,
    T ~ lat)) |> 
  dplyr::mutate(lon = case_when(
    map_label == 'Lower Mainland' ~ lon - 0.5,
    map_label == 'Penticton' ~ lon + 1,
    map_label == "Douglas Crossing" ~ lon - 1.2,
    map_label == "Sumas" ~ lon + 1,
    T ~ lon)) |> 
  sf::st_as_sf(coords = c("lon","lat"),crs=4326)


# Make a custom-sized viewing box around stations in BC.
bc_station_view = st_bbox(tibble(lon = c(-127.58, -112),
                         lat = c(48, 56)) |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326))

# Download maptiles for BC station map
# bc_stations_basemap_colour = maptiles::get_tiles(x = bc_station_view, provider = 'CartoDB.Positron', zoom = 6, crop = F)
# bc_stations_basemap_green = maptiles::get_tiles(x = bc_station_view, provider = 'OpenStreetMap', zoom = 6, crop = F)
bc_stations_basemap_colour<- basemaps::basemap_terra(ext = bc_station_view, map_service = 'esri', map_type = 'world_street_map')
#basemaps::get_maptypes()
bc_stations_basemap_white<- basemaps::basemap_terra(ext = bc_station_view, map_service = 'carto', map_type = 'light')

# ggplot()+
#   tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_white)

# Set plotting mode for tmap.
# tmap_mode('plot')

# map_1_tmap = tm_shape(bc_stations_basemap_green, bbox = bc_station_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Watercraft \nInspection Stations')) + 
#   tm_shape(bc_bound) + 
#     tm_borders(col = 'grey', lwd = 2) + 
#   tm_shape(stations_for_maps) + 
#     tm_symbols(col = "station_type", title.col = '') +
#   tm_shape(station_labels) +
#     tm_text("map_label", auto.placement = F, 
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_1_tmap



p1<-ggplot()+
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour)+
  geom_sf(data = st_buffer(stations_for_maps,20000), aes(fill = as.factor(station_type)))+
  geom_sf_text(data = station_labels, aes(label = map_label))+
  scale_fill_manual(name = "2024 Watercraft \n Inspection Stations", 
                    values = c(
                      "Permanent Inspection Station" = "lightblue", 
                      "Roving Inspection Crew" = "purple",
                      "Part-time Inspection Station" = '#E8DE51'))+
  ggspatial::annotation_scale()+
  ggthemes::theme_map()+
  theme(legend.position = c(0.68,0.72),
        legend.background = element_rect(colour = 'black')
        )
  
p1


if(!interactive()) {
  # tmap_save(tm = map_1_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), p1, width = 7.6, height = 6.4, dpi = 300)
}
```


```{r optional_map_of_inspection_stations_for_current_year_of_operations}
# Usually, we are drafting the IMDP report for the previous year's season while the current year's season is active. We might need a map of the current year's stations.
if((my_opts$year+1) %in% unique(dat_all$Year)){
  
  # Find which stations have inspections in this year's data.
  stations_active_this_year = dat_all |> 
    dplyr::mutate(Station = dplyr::case_when(
      str_detect(Station,"Lower Mainland") ~ "Lower Mainland Roving",
      T ~ Station
    )) |> 
    dplyr::filter(Year == 2025) |> 
    dplyr::count(Station) |> 
    dplyr::filter(n > 5) |> 
    dplyr::pull(Station)
  
  # If we're in 2024, Martina and co. also want Radium and Sumas as part-time stations.
  stations_active_this_year = c(stations_active_this_year, "Radium","Sumas Border")
  # Also, change Sumas Border from Roving to Part-time inspections, and
  #simplify its label to 'Sumas'
  stations[stations$station_name == 'Sumas Border',]$map_label = 'Sumas'
  stations[stations$station_name == 'Sumas Border',]$station_type = 'Part-time Inspection Station'
  
  # Drop stations from leaflet maps that we did not want to keep.
  stations_this_year = stations |> 
    # filter(station_name %in% leaflet.stations.to.include) |> 
    # dplyr::filter(!station_name %in% rovers_to_drop) |> 
    dplyr::filter(station_name %in% stations_active_this_year)
  
  stations_for_maps_this_year = stations_this_year |> 
    # mutate(station_type = replace(station_type, station_type == 'Unknown', 'Roving')) |> 
    mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))
  
  # Ugh. Time to make some hand-drawn locations for the labels...
  station_labels_this_year = stations_for_maps_this_year |> 
    sf::st_drop_geometry() |> 
    dplyr::mutate(lat = lat + 0.25) |> 
    dplyr::mutate(lat = case_when(
      map_label == 'Lower Mainland Roving' ~ lat + 0.1, 
      map_label == 'Penticton Roving' ~ lat - 0.1,
      map_label == 'Cutts (Hwy 93)' ~ lat - 0.1,
      map_label == 'Sumas' ~ lat - 0.5,
      T ~ lat)) |> 
    dplyr::mutate(lon = case_when(
      map_label == 'Lower Mainland Roving' ~ lon - 1,
      map_label == 'Penticton Roving' ~ lon + 1.5,
      map_label == 'Cutts (Hwy 93)' ~ lon + 1.25,
      map_label == 'Sumas' ~ lon + 0.5,
      T ~ lon)) |> 
    sf::st_as_sf(coords = c("lon","lat"),crs=4326)
  
  # Set plotting mode for tmap.
  # tmap_mode('plot')
  
  # station_map_this_year_tmap = tm_shape(bc_stations_basemap_green, bbox = bc_station_view) +
  #   tm_rgb() + 
  #   tm_add_legend(title = paste0(my.year+1,' Watercraft \nInspection Stations')) + 
  #   tm_shape(bc_bound) + 
  #   tm_borders(col = 'grey', lwd = 2) + 
  #   tm_shape(stations_for_maps_this_year) + 
  #   tm_symbols(col = "station_type", title.col = '') +
  #   tm_shape(station_labels_this_year) +
  #   tm_text("map_label", auto.placement = F, 
  #           size = 0.75) +
  #   tm_scale_bar() + 
  #   tm_layout(legend.frame = 'black', 
  #             legend.position = c('right','top'),
  #             scale = 1.25)
  # 
  # station_map_this_year_tmap
  p2<-ggplot()+
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour)+
  geom_sf(data = st_buffer(stations_for_maps_this_year,20000), aes(fill = as.factor(station_type)))+
  geom_sf_text(data = station_labels_this_year, aes(label = map_label))+
  scale_fill_manual(name = "2025 Watercraft \n Inspection Stations", values = c("Permanent Inspection Station" = "lightblue", "Roving Inspection Crew" = "purple", "Part-time Inspection Station" = "yellow"))+
  ggspatial::annotation_scale()+
  ggthemes::theme_map()+
  theme(legend.position = c(0.68,0.75),
        )
  
  p2
  next.years.external.output.folder = str_remove(my.external.output.folder,"[0-9]+$")
  
  if(!dir.exists(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/'))){
    dir.create(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/'), recursive = T)
  }
    
  # tmap_save(tm = station_map_this_year_tmap, filename = paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(next.years.external.output.folder,my_opts$year+1,'/GIS Maps and Excel Figures/ExcelFigures/Map1_Stations_by_Type.jpg'), p2, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2. Total Inspections by Station

```{r map2_total_inspections_by_station}
# Grab inspection stations shapefile.
# stations = read_sf(paste0(my_opts$remote_spatial_data,
#                           'Projects/ZQMussels/data/inspection_stations.gpkg'))

# Join number of inspections to stations.
st = stations_for_maps |> 
  dplyr::filter(!station_name %in% rovers_to_drop) |>
  # dplyr::filter(station_name %in% permanent.stations) |> 
  left_join(dat |> 
              count(Station, name = 'num_insp') |> 
              dplyr::rename(station_name = Station)) |> 
  filter(!is.na(num_insp))
  
# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st = st |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(num_insp_b) |> 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

stations_sf = st_as_sf(st, coords = c("lon","lat"), crs = 4326)

# Make a custom-sized viewing box around stations in BC.
bc_station_view = st_bbox(tibble(lon = c(-127.58, -112),
                         lat = c(48, 56)) |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326))

# tmap_mode('plot')
# 
my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = st$num_insp_b,
  reverse = T
)
# 
# map_2_tmap = tm_shape(bc_stations_basemap_green, bbox = bc_station_view) +
#     tm_rgb() +
#   tm_add_legend(title = paste0(my.year,' Inspections \nby Stations'),
#                 type = 'symbol',
#                 labels = unique(stations_sf$bin_label),
#                 col = my_pal(unique(stations_sf$num_insp_b)),
#                 size = log(unique(stations_sf$num_insp_b)+1)) + 
#   tm_shape(bc_bound) +
#     tm_borders(col = 'grey', lwd = 2) +
#   tm_shape(stations_sf) + 
#     tm_symbols(col = "num_insp_b", palette = '-Spectral',
#                size = 'num_insp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                perceptual = F,
#                scale = 1.5,
#                title.col = '') +
#   tm_shape(station_labels[station_labels$station_name %in% stations_sf$station_name,]) +
#     tm_text("map_label",
#             auto.placement = F, 
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_2_tmap


p3 <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(data = stations_sf, 
          aes(color = station_type, 
              size = num_insp_b)) +
  geom_sf_label(data = station_labels_this_year, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_color_brewer(palette = "Dark2", name = "Station Type") +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(1, 5),
    breaks = unique(stations_sf$num_insp_b),
    labels = unique(stations_sf$bin_label)
  ) +
  ggspatial::annotation_scale() +
  ggthemes::theme_map() +
  guides(
    color = guide_legend(order = 1),
    size = guide_legend(order = 2)
  ) +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )
p3



if(!interactive()) {
# tmap_save(tm = map_2_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2_Total_Inspections_by_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
    ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2_Total_Inspections_by_Station.jpg'), p3, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2.b Total Inspections by Permanent Station

```{r map2b_total_inspections_by_permanent_station}

# Join number of inspections to stations.
st_ps = st |> 
  dplyr::filter(station_type != 'Roving Inspection Station') |> 
  dplyr::filter(station_name %in% permanent.stations) |> 
  dplyr::select(!contains('jenks'))
  
# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st_ps = st_ps |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(num_insp_b) |> 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

first_level = as.character(st_ps$jenks_1[1])
second_level = as.character(st_ps$jenks_1[2])

if(first_level == second_level){
  st_ps = st_ps |> 
    mutate(bin_label = str_replace_all(bin_label,
                                       paste0(first_level, ' - ',second_level),
                                       first_level))
}

stations_ps_sf = st_as_sf(st_ps, coords = c("lon","lat"), crs = 4326)

# Make a custom-sized viewing box around stations in BC.
bc_station_view = st_bbox(tibble(lon = c(-127.58, -112),
                         lat = c(48, 56)) |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326))

# tmap_mode('plot')
# 
# my_pal_ps = leaflet::colorFactor(
#   palette = 'Spectral',
#   domain = st_ps$num_insp_b,
#   reverse = T
# )
# 
# map_2b_tmap = tm_shape(bc_stations_basemap_green, bbox = bc_station_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Inspections \nby Permanent Stations'),
#                 type = 'symbol',
#                 labels = unique(stations_ps_sf$bin_label),
#                 col = my_pal(unique(stations_ps_sf$num_insp_b)),
#                 size = log(unique(stations_ps_sf$num_insp_b)+1)) + 
#   tm_shape(bc_bound) +
#     tm_borders(col = 'grey', lwd = 2) +
#   tm_shape(stations_ps_sf) + 
#     tm_symbols(col = "num_insp_b", palette = '-Spectral',
#                size = 'num_insp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                perceptual = F,
#                scale = 1.5,
#                title.col = '') +
#   tm_shape(station_labels[station_labels$station_name %in% stations_ps_sf$station_name,]) +
#     tm_text("map_label", auto.placement = F, 
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_2b_tmap

station_labels_sf = station_labels |>
  dplyr::filter(station_name %in% stations_ps_sf$station_name) |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

p4 = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_ps_sf,
    aes(fill = factor(num_insp_b), size = log(num_insp_b)+1),
    shape = 21, color = "black"
  ) +
  geom_sf_label(data = station_labels_sf, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(
    name = paste0(my.year, ' Inspections \nby Permanent Stations'),
    values = my_colors,
    labels = unique(stations_ps_sf$bin_label),
    breaks = unique(stations_ps_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_ps_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(3,7),
    breaks = unique(stations_ps_sf$num_insp_b),
    labels = unique(stations_ps_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

p4


if(!interactive()) {
# tmap_save(tm = map_2b_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2b_Total_Inspections_by_Permanent_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2b_Total_Inspections_by_Permanent_Station.jpg'), p4, width = 7.6, height = 6.4, dpi = 300)
}
```

### Map 2.c Total Inspections by Roving Station

```{r map2c_total_inspections_by_roving_station}
# Grab inspection stations shapefile.
stations_roving = read_sf(paste0(my_opts$remote_spatial_data,
                          'Projects/ZQMussels/data/inspection_stations.gpkg'))

# Drop stations from leaflet maps that we did not want to keep.
stations_roving = stations_roving |> 
  filter(station_type != 'Permanent Inspection Station') |>
  # filter(station_name != 'Cutts (Hwy 93)') |> 
  dplyr::filter(!station_name %in% c('Scheduled Inspection')) |> 
  dplyr::filter(!stringr::str_detect(station_name, 'Notification')) |> 
  dplyr::mutate(station_name = ifelse(station_name == 'Keremeos', 'Keremeos (Hwy 3)', station_name))

if(my.year %in% c(2023,2024)){
  stations_roving = stations_roving |> 
    dplyr::mutate(map_label = ifelse(map_label == 'Fraser Valley Roving', 
                                     'Lower Mainland Roving',
                                     map_label),
                  station_name = ifelse(station_name == 'Fraser Valley Roving',
                                        'Lower Mainland Roving',
                                        station_name))
}

st_rs = stations_roving |> 
  left_join(dat |> 
              count(Station, name = 'num_insp') |> 
              dplyr::rename(station_name = Station)) |> 
  filter(!is.na(num_insp))
  
# Ugh. Time to make some hand-drawn locations for the labels...
station_labels_roving = stations_roving |> 
  sf::st_drop_geometry() |> 
  dplyr::mutate(lat = lat + 0.25) |> 
  dplyr::mutate(lat = case_when(
    map_label == 'Penticton Roving' ~ lat + 0.05,
    map_label == 'Sumas Border' ~ lat - 0.5,
    map_label == 'Keremeos' ~ lat - 0.5,
    #map_label == 'Pacific' ~ lat - 0.4,
    
    T ~ lat)) |> 
  dplyr::mutate(lon = case_when(
    map_label == 'Penticton Roving' ~ lon + 0.05,
    map_label == 'Sumas Border' ~ lon + 0.15,
    T ~ lon)) |> 
  sf::st_as_sf(coords = c("lon","lat"),crs=4326)

# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st_rs = st_rs |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(num_insp_b) |> 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

first_level = as.character(st_rs$jenks_1[1])
second_level = as.character(st_rs$jenks_1[2])

stations_rs_sf = st_as_sf(st_rs, coords = c("lon","lat"), crs = 4326)

# Make a custom-sized viewing box around stations in BC.
bc_station_view_roving = st_bbox(tibble(lon = c(-126, -114.5),
                         lat = c(48, 52)) |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326))

bc_stations_basemap_green_roving = maptiles::get_tiles(x = bc_station_view_roving, provider = 'OpenStreetMap', zoom = 7, crop = T)

station_labels_roving= station_labels_roving |> 
  filter(station_name %in% stations_rs_sf$station_name)

station_labels_sf = station_labels |>
  dplyr::filter(station_name %in% stations_rs_sf$station_name) |>
  st_as_sf(coords = c("lon", "lat"), crs = 4326)

my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

p5 = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_rs_sf,
    aes(fill = factor(num_insp_b), size = log(num_insp_b)+1),
    shape = 21, color = "black"
  ) +
  geom_sf_label(data = station_labels_roving, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(
    name = paste0(my.year, ' Inspections \nby Roving Crew'),
    values = my_colors,
    labels = unique(stations_rs_sf$bin_label),
    breaks = unique(stations_rs_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_rs_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(3,7),
    breaks = unique(stations_rs_sf$num_insp_b),
    labels = unique(stations_rs_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  coord_sf(xlim = c(-14201388, -12467185), ylim =c(6107624, 7058093)) +
  theme(
    legend.position = c(0.95, 0.99),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

p5

# tmap_mode('plot')
# 
# my_pal_rs = leaflet::colorFactor(
#   palette = 'Spectral',
#   domain = st_rs$num_insp_b,
#   reverse = T
# )
# 
# map_2c_tmap = tm_shape(bc_stations_basemap_green_roving, bbox = bc_station_view_roving) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Inspections \nby Roving Stations'),
#                 type = 'symbol',
#                 labels = unique(stations_rs_sf$bin_label),
#                 col = my_pal(unique(stations_rs_sf$num_insp_b)),
#                 size = log(unique(stations_rs_sf$num_insp_b)+1)) + 
#   tm_shape(bc_bound) +
#     tm_borders(col = 'grey', lwd = 2) +
#   tm_shape(stations_rs_sf) + 
#     tm_symbols(col = "num_insp_b", palette = '-Spectral',
#                size = 'num_insp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                perceptual = F,
#                scale = 1.5,
#                title.col = '') +
#   tm_shape(station_labels_roving[station_labels_roving$station_name %in% stations_rs_sf$station_name,]) +
#     tm_text("map_label", auto.placement = F, 
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('left','top'),
#             scale = 1.25)
# 
# map_2c_tmap

if(!interactive()) {
# tmap_save(tm = map_2c_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2c_Total_Inspections_by_Roving_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map2c_Total_Inspections_by_Roving_Station.jpg'), p5, width = 7.6, height = 6.4, dpi = 300)
}
```

### Aside: Number of Shifts by Station
```{r}
# Number of shifts
dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  dplyr::select(Station, Shift_ID) |> 
  dplyr::distinct() |> 
  dplyr::count(Station, sort = T) |> 
  knitr::kable()
```

### Figure 3 Encounter Frequency by Station

```{r fig3_total_boats_by_station}
fig3_data = dat |> 
  dplyr::filter(Station %in% stations.to.include) |> 
  filter(!Station %in% rovers_to_drop) |> 
  mutate(shift_start_time = openxlsx::convertToDateTime(Start_Time),
         shift_end_time = openxlsx::convertToDateTime(End_Time)) |> 
  group_by(Station,Shift_ID) |> 
  reframe(NumberInsp = n(),
          shift_hours = shift_end_time - shift_start_time) |>
  # If we get some negative values for shift hours, just make those 0...
  dplyr::mutate(shift_hours = ifelse(shift_hours < 0, 0, shift_hours)) |> 
  distinct() |> 
  group_by(Station) |> 
  reframe(NumberInsp = sum(NumberInsp),
          effort_hours = sum(shift_hours)) |> 
  mutate(effort_hours = as.numeric(effort_hours/3600)) |> 
  mutate(encounter_freq = NumberInsp / effort_hours) |> 
  left_join(dat_hr |> 
              filter(Year == my.year) |> 
              group_by(Station) |> 
              summarise(NumberHighRiskInsp = n())
  ) |> 
  #For any stations with 0 HR inspections, replace NA with 0.
  mutate(NumberHighRiskInsp = replace_na(NumberHighRiskInsp, 0)) |> 
  mutate(PercentHR = 100*NumberHighRiskInsp/NumberInsp) |> 
  arrange(desc(NumberInsp)) |> 
  mutate(Station = factor(Station)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving", paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  mutate(col.width = as.numeric(cut(log10(NumberInsp),3))) |> 
  mutate(col.width = replace(col.width, col.width == 3, 4))

# The below code creates a double-Y-axis figure with total inspections on the left Y axis.
# p3 = fig3_data |> 
#   ggplot() +
#   geom_col(aes(x=StationLabel, y=NumberInsp/1000), fill = my.grey, width = 0.40) +
#   geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",size=2) +
#    scale_y_continuous(breaks = seq(0,10,2),
#                       #labels = paste0("10^",seq(0,10,2)),
#      labels = number_format(suffix = "k"),
#                         sec.axis = sec_axis(~., name = "% High Risk",
#                                             breaks = seq(0,14,2))) +
#   theme_classic() +
#   labs(x = "", y = "Total Inspections") +
#   scale_fill_brewer(palette = "Dark2") +
#   theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
#         axis.text.y.right = element_text(colour = "red"),
#         axis.title.y.right = element_text(colour = "red"),
#         panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

# The code below creates a double-Y-axis figure with encounter frequency (watercraft encounters divided by effort)
# on the left Y axis.

p3 = fig3_data |>
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3

if(!interactive()) {
ggsave("Fig3_EncounterFrequency_HR.jpg",p3)
}
```

### Figure 3.b Encounter Frequency by Permanent Station

```{r fig3_total_boats_by_permanent_station}
fig3b_data = dat |> 
  dplyr::filter(Station %in% permanent.stations) |> 
  mutate(shift_start_time = openxlsx::convertToDateTime(Start_Time),
         shift_end_time = openxlsx::convertToDateTime(End_Time)) |> 
  group_by(Station,Shift_ID) |> 
  reframe(NumberInsp = n(),
            shift_hours = shift_end_time - shift_start_time) |>
  # If we get some negative values for shift hours, just make those 0...
  dplyr::mutate(shift_hours = ifelse(shift_hours < 0, 0, shift_hours)) |> 
  distinct() |> 
  group_by(Station) |> 
  reframe(NumberInsp = sum(NumberInsp),
          effort_hours = sum(shift_hours)) |> 
  mutate(effort_hours = as.numeric(effort_hours/3600)) |> 
  mutate(encounter_freq = NumberInsp / effort_hours) |> 
  left_join(dat_hr |> 
              filter(Year == my.year) |> 
              group_by(Station) |> 
              summarise(NumberHighRiskInsp = n())
  ) |> 
  #For any stations with 0 HR inspections, replace NA with 0.
  mutate(NumberHighRiskInsp = replace_na(NumberHighRiskInsp, 0)) |> 
  mutate(PercentHR = 100*NumberHighRiskInsp/NumberInsp) |> 
  arrange(desc(NumberInsp)) |> 
  mutate(Station = factor(Station)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving", paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  mutate(col.width = as.numeric(cut(log10(NumberInsp),3))) |> 
  mutate(col.width = replace(col.width, col.width == 3, 4))

# The code below creates a double-Y-axis figure with encounter frequency (watercraft encounters divided by effort)
# on the left Y axis.

p3_b = fig3b_data |>
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3_b

if(!interactive()) {
ggsave("Fig3b_EncounterFrequency_HR_PermanentStations.jpg",p3_b)
}
```

### Figure 3.c Encounter Frequency by Roving Station

```{r fig3_total_boats_by_roving_station}
fig3c_data = dat |> 
  dplyr::filter(Station %in% stations.to.include) |> 
  dplyr::filter(!Station %in% permanent.stations) |> 
  dplyr::filter(!Station %in% rovers_to_drop) |> 
  mutate(shift_start_time = openxlsx::convertToDateTime(Start_Time),
         shift_end_time = openxlsx::convertToDateTime(End_Time)) |> 
  group_by(Station,Shift_ID) |> 
  reframe(NumberInsp = n(),
            shift_hours = shift_end_time - shift_start_time) |>
  # If we get some negative values for shift hours, just make those 0...
  dplyr::mutate(shift_hours = ifelse(shift_hours < 0, 0, shift_hours)) |> 
  distinct() |> 
  group_by(Station) |> 
  reframe(NumberInsp = sum(NumberInsp),
          effort_hours = sum(shift_hours)) |> 
  mutate(effort_hours = as.numeric(effort_hours/3600)) |> 
  mutate(encounter_freq = NumberInsp / effort_hours) |> 
  left_join(dat_hr |> 
              filter(Year == my.year) |> 
              group_by(Station) |> 
              summarise(NumberHighRiskInsp = n())
  ) |> 
  #For any stations with 0 HR inspections, replace NA with 0.
  mutate(NumberHighRiskInsp = replace_na(NumberHighRiskInsp, 0)) |> 
  mutate(PercentHR = 100*NumberHighRiskInsp/NumberInsp) |> 
  arrange(desc(NumberInsp)) |> 
  mutate(Station = factor(Station)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving", paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  mutate(col.width = as.numeric(cut(log10(NumberInsp),3))) |> 
  mutate(col.width = replace(col.width, col.width == 3, 4))

# The code below creates a double-Y-axis figure with encounter frequency (watercraft encounters divided by effort)
# on the left Y axis.

p3_c = fig3c_data |>
  ggplot() +
  geom_col(aes(x=StationLabel, y=encounter_freq), fill = my.grey, width = 0.40) +
  geom_line(aes(x=StationLabel,y=PercentHR,group=1),col="red",linewidth=2) +
   scale_y_continuous(#breaks = seq(0,10,2),
                      #labels = paste0("10^",seq(0,10,2)),
     # labels = number_format(suffix = "k"),
                        sec.axis = sec_axis(~., name = "% High Risk",
                                            breaks = seq(0,14,2))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency \n(Inspections per Hour of Effort)") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1),
        axis.text.y.right = element_text(colour = "red"),
        axis.title.y.right = element_text(colour = "red"),
        panel.grid.major.y = element_line(linetype = 2, colour = "darkgrey"))

p3_c

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig3b_EncounterFrequency_HR_RovingStations.jpg"),
       p3_c,
       height = 4, width = 8)
}
```

### Figure 3.x Total Inspections by Station

```{r}
p3.x = dat_all |> 
  filter(Year %in% c((my.year-2):my.year)) |> 
  # filter(Station %in% c('Golden','Olsen',
  #                       'Yahk','Radium',
  #                       'Mt. Robson','Osoyoos',
  #                       'Dawson Creek','Pacific')) |>
  filter(Station %in% stations.to.include) |> 
  group_by(Year, Station) |> 
  summarise(NumberInsp = n()) |> 
  group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
  ungroup() |> 
  arrange(desc(TotalInsp),desc(NumberInsp)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  dplyr::mutate(Year = as.character(Year)) |> 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberInsp,fill=Year), width = 0.40,position=position_dodge(preserve = "single")) +
  scale_y_continuous(name = "Number of Inspections",
                     breaks = c(0,1000,2500,5000,7500,10000,15000)) +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

p3.x

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0("Fig3x_TotalInspections_",my.year-2,"_to_",my.year,"_All_Stations.jpg"),p3.x)
}
```

### Figure 3.x_b Total Inspections by Permanent Station

```{r}
p3.x_b = dat_all |> 
  filter(Year %in% c((my.year-2):my.year)) |> 
  filter(Station %in% permanent.stations) |> 
  group_by(Year, Station) |> 
  summarise(NumberInsp = n()) |> 
  group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
  ungroup() |> 
  arrange(desc(TotalInsp),desc(NumberInsp)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  dplyr::mutate(Year = as.character(Year)) |> 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberInsp,fill=Year), width = 0.40,position=position_dodge(preserve = "single")) +
  scale_y_continuous(name = "Number of Inspections",
                     breaks = c(0,1000,2500,5000,7500,10000,15000)) +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

p3.x_b

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0("Fig3x_b_TotalInspections_",my.year-2,"_to_",my.year,"_Permanent_Stations.jpg"),p3.x_b)
}
```

### Figure 3.x_c Total Inspections by Roving Station

```{r}
p3.x_c = dat_all |> 
  filter(Year %in% c((my.year-2):my.year)) |> 
  dplyr::filter(Station %in% roving.stations) |> 
  group_by(Year, Station) |> 
  summarise(NumberInsp = n()) |> 
  group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
  ungroup() |> 
  arrange(desc(TotalInsp),desc(NumberInsp)) |> 
  mutate(Station = fct_inorder(Station)) |> 
  dplyr::mutate(Year = as.character(Year)) |> 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberInsp,fill=Year), width = 0.40,position=position_dodge(preserve = "single")) +
  scale_y_continuous(name = "Number of Inspections",
                     breaks = c(0,1000,2500,5000,7500,10000,15000)) +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

p3.x_c

if(interactive()){
  dat |> 
    count(Station)
}

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig3x_c_TotalInspections_",my.year-2,"_to_",my.year,"_Roving_Stations.jpg"),p3.x_c)
}
```

### Figure 4 Total Number of Jurisdictions

```{r fig4_total_number_jurisdictions}
p4 = dat |>
  dplyr::filter(Station %in% stations.to.include) |> 
  filter(!Station %in% rovers_to_drop) |> 
  group_by(Station,Previous_Waterbody_1_Province_Or_State) |> 
  summarise(Different_Sources = n()) |> 
  summarise(TotalSources = n()) |> 
  arrange(desc(TotalSources)) |> 
  left_join(station_types) |> 
  mutate(Station = as.factor(Station)) |> 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) |> 
  mutate(StationLabel = fct_reorder(StationLabel, -TotalSources)) |> 
  ggplot() + 
  geom_col(aes(x=StationLabel,y=TotalSources), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,y=TotalSources+0.05*max(TotalSources),label=TotalSources)) +
  labs(x = '', y = "Number of Origin Jurisdictions") + 
  theme_classic() + 
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p4

if(!interactive()) {
ggsave("Fig4_Total_Jurisdictions_by_Station.jpg",p4)
}
```

### Figure 5 Number of Inspections and Total Effort by month

```{r fig5_total_inspections_and_total_effort_by_month}
p5 = ggarrange(
  dat |> 
    mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) |> 
    dplyr::filter(!(the.month %in% c("March","November") & Year == 2024)) |> 
  #Calculate the number of inspections for each month
  group_by(the.month) |> 
    summarise(Number_Insp = n()) |> 
    ggplot() + 
    geom_col(aes(x=the.month,y=Number_Insp),fill = my.grey,width = 0.40) +
    geom_text(aes(x=the.month,y=Number_Insp+max(Number_Insp)*0.05,
                  label=round(Number_Insp,0))) +
    theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  
  dat |> 
    filter(!Station %in% rovers_to_drop) |> 
    mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) |> 
    dplyr::filter(!(the.month %in% c("March","November") & Year == 2024)) |> 
    group_by(the.month) |> 
    select(the.month,Shift_ID,Shift_hours) |> 
    distinct() |> 
    #Some shifts report negative # of hours... remove those.
    filter(Shift_hours > 0) |> 
    summarise(TotalEffort = sum(Shift_hours)) |> 
    ggplot() + 
    geom_col(aes(x=the.month,y=TotalEffort),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.month,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p5

if(!interactive()) {
ggsave("Fig5_NumberInspections_and_TotalEffort_month.jpg",p5)
}
```

### Figure 6 Encounter Frequency by Month

```{r fig6_EncounterFrequency_by_month}
p6 = dat |> 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) |> 
  mutate(the.day = day(TimeOfInspection)) |> 
  filter(!the.month %in% c("January","February","December")) |> 
  #Calculate the number of inspections for each month
  group_by(the.month,the.day) |> 
  summarise(Number_Insp = n()) |> 
  dplyr::mutate(total_per_month = sum(Number_Insp)) |> 
  dplyr::filter(total_per_month > 10) |> 
  dplyr::select(-total_per_month) |> 
  left_join(
  dat |> 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) |> 
  mutate(the.day = day(TimeOfInspection)) |> 
  group_by(the.month,the.day) |> 
  select(the.month,the.day,Shift_ID,Shift_hours) |> 
  distinct() |> 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) |> 
  summarise(TotalEffort = sum(Shift_hours))
  ) |> 
  mutate(EncounterFreq = Number_Insp/TotalEffort) |>
  mutate(StandardError = plotrix::std.error(EncounterFreq)) |> 
  #Summarise for each month
  group_by(the.month,StandardError) |> 
  summarise(EncounterFreq = mean(EncounterFreq)) |> 
  #If the bottom half of the errorbar would be below 0, change to 0.
  mutate(StandardError = case_when(
    EncounterFreq - StandardError <= 0 ~ EncounterFreq,
    T ~ StandardError
  )) |> 
  ggplot() + 
  geom_col(aes(x=the.month,y=EncounterFreq),fill = my.grey,width = 0.40) +
  geom_errorbar(aes(x=the.month,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +

  geom_text(aes(x=the.month,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_y_continuous(breaks = seq(0,6.5,0.5))

p6

if(!interactive()) {
ggsave("Fig6_EncounterFrequency_by_month.jpg",p6)
}
```

### Figure 7 Total Inspections and Total Effort by Day of Week

```{r fig7_total_inspections_and_total_effort_by_day_of_week}
p7 = ggarrange(dat |> 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) |> 
  #Calculate the number of inspections for each month
  group_by(the.day) |> 
  summarise(Number_Insp = n()) |> 
  ggplot() + 
  geom_col(aes(x=the.day,y=Number_Insp),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.day,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
                dat |> 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) |> 
  group_by(the.day) |> 
  select(the.day,Shift_ID,Shift_hours) |> 
  distinct() |> 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) |> 
  summarise(TotalEffort = sum(Shift_hours)) |> 
  ggplot() + 
  geom_col(aes(x=the.day,y=TotalEffort),fill = my.grey,width = 0.40) +
  geom_text(aes(x=the.day,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p7

if(!interactive()) {
ggsave("Fig7_NumberInspections_and_TotalEffort_day.jpg",p7)
}
```

### Figure 8 Encounter Frequency by day of week

```{r fig8_Encounter_Frequency_by_day_of_week}
#This one requires grouping the data by the week number in the year (i.e. 1,2, 3 ... up to 54) and the day of the week to first calculate the standard error within each day of the week (which is the eventual grouping factor for the figure), then summarise by day of the week the calculate mean frequency.

p8 = dat |> 
  # Drop scheduled inspections?
  filter(!str_detect(Station,"Scheduled")) |> 
  # Replace anything less than 1 hour for shift duration with a 1
  mutate(Shift_hours = ifelse(Shift_hours < 1, 1, Shift_hours)) |> 
  mutate(the.day = wday(TimeOfInspection,
                        label=T,abbr=F,
                        week_start = getOption("lubridate.week.start", 1)),
         the.week = week(TimeOfInspection),
         the.month = month(TimeOfInspection)
         ) |>
  # Drop inspections in January and February
  dplyr::filter(the.month > 2) |> 
  # Only keep rows where shift hours was more than 1 hour.
  # filter(Shift_hours > 1) |> 
  #Calculate the number of inspections for each month
  group_by(the.day,
           Shift_ID) |> 
  reframe(Number_Insp = n(),
            Shift_hours
  ) |> 
  dplyr::distinct() |> 
  mutate(enc_freq = Number_Insp/Shift_hours) |> 
  group_by(the.day) |> 
  reframe(EncounterFreq = mean(enc_freq),
            StandardError = plotrix::std.error(enc_freq)) |> 
  ggplot() + 
  geom_col(aes(x=the.day,y=EncounterFreq),fill = my.grey,width = 0.40) +
  geom_errorbar(aes(x=the.day,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +
  geom_text(aes(x=the.day,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency")

p8

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig8_EncounterFrequency_day_of_week.jpg"),p8)
}
```

### Figure 9 Total Inspections by Time of Day

```{r fig9_total_inspections_by_time_of_day}
p9 = dat |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  # geom_text(
  #   size = 3.5,
  #   aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
  #       label=round(Number_Insp,0))#,
  #   # min.segment.length = 0.1,
  #   # force = 0.1,
  #   # force_pull = 100
  # ) +
   geom_text_repel(
    size = 3.5,
    aes(x=the.hour,y=Number_Insp,#+max(Number_Insp)*0.05,
        label=round(Number_Insp,0)),
    min.segment.length = 0.1,
    force = .01,
    force_pull = 100,
    nudge_y = 100
  ) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9

if(!interactive()) {
ggsave("Fig9_NumberInspections_hour_of_day.jpg",p9)
}
```

### Figure 9. Part 2 High-Risk Inspections by Time of Day

```{r fig9_HR_inspections_by_time_of_day}
p9.2 = dat |> 
  filter(High_Risk_AIS_Ind == T) |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.2

if(!interactive()) {
ggsave("Fig9_Part2_Number_Highrisk_Inspections_hour_of_day.jpg",p9.2)
}
```

### Figure 9. Part 3 Total Inspections by Time of Day for Golden Station

```{r fig9_Golden_inspections_by_time_of_day}
p9.3 = dat |> 
  filter(Station == "Golden") |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.3

cat("\nNumber of Golden inspections between 10 PM and 6 AM")

dat |> 
  filter(Station == "Golden") |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  dplyr::filter(the.hour >= 22 | the.hour <= 6) |> 
  dplyr::summarise(night_inspections = sum(Number_Insp))

if(!interactive()) {
ggsave("Fig9_Part3_Number_Inspections_Golden_hour_of_day.jpg",p9.3)
}
```

### Figure 9. Part 4 High-Risk Inspections by Time of Day for Golden Station

```{r fig9_HR_Golden_inspections_by_time_of_day}
p9.4 = dat |> 
  filter(High_Risk_AIS_Ind == T,
         Station == "Golden") |> 
  mutate(the.hour = hour(TimeOfInspection)) |>
  group_by(the.hour) |> 
  summarise(Number_Insp = n()) |> 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = my.grey,
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.4

if(!interactive()) {
ggsave("Fig9_Part4_Number_Highrisk_Inspections_Golden_hour_of_day.jpg",p9.4)
}
```

### Figure 11 Destination Waterbodies with Percent

```{r fig11_Destination_Waterbodies_with_percent}
p11 = dat |> 
  filter(!is.na(Destination_Waterbody_1_Name)) |> 
  group_by(Destination_Waterbody_1_Name) |> 
  summarise(NumberInsp = n()) |> 
  arrange(desc(NumberInsp)) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
  mutate(Percent = 100*NumberInsp/TotalInsp) |> 
  slice(1:15) |> 
  mutate(Destination_Waterbody_1_Name = as.factor(Destination_Waterbody_1_Name)) |>
  ggplot() + 
  geom_col(aes(x=reorder(Destination_Waterbody_1_Name,-Percent),
               y=Percent),fill = my.grey, width = 0.40) +
  geom_text(aes(x=Destination_Waterbody_1_Name,
                y=Percent+max(Percent)*0.05,
               label=paste0(round(Percent,1),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent of Total Inspections") + 
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1))

p11

if(!interactive()) {
ggsave("Fig11_DestinationWaterbody_Percent_Inspections.jpg",p11)
}
```

### Map 3: Home Residence of Boats

```{r map2_home_residence_of_boats}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(TotalInsp), 'transparent', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(TotalInsp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(TotalInsp_b = case_when(
    TotalInsp <= jenks_2 ~ 1,
    TotalInsp <= jenks_3 ~ 2,
    TotalInsp <= jenks_4 ~ 3,
    TotalInsp <= jenks_5 ~ 4,
    TotalInsp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    TotalInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    TotalInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    TotalInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    TotalInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    TotalInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(TotalInsp)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(TotalInsp)))

source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = unique(sources_centroid$TotalInsp_b),
  reverse = T
)

northamerica_view = tibble(lon = c(-174,-50),
                           lat = c(73,11.2)) |> 
  st_as_sf(coords = c("lon","lat"), crs = 4326)

# Download maptiles North America
# northamerica_basemap = maptiles::get_tiles(x = northamerica_view, provider = 'CartoDB.Positron', zoom = 4, crop = F)
north_america_stations_basemap_colour<- basemaps::basemap_terra(ext = northamerica_view, map_service = 'esri', map_type = 'world_street_map')

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(TotalInsp))
centr_without_dat = sources_centroid |> filter(is.na(TotalInsp))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(TotalInsp_b))

centr_offset = centr_with_dat |> 
  dplyr::mutate(lat = sf::st_coordinates(geom)[,2],
                lng = sf::st_coordinates(geom)[,1]) |> 
  dplyr::mutate(lat = lat - 2,
                lng = lng - 2) |> 
  sf::st_drop_geometry() |> 
  sf::st_as_sf(coords = c("lng","lat"), crs = 4326)

my_colors <- RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]
northamerica_view_bbox <- sf::st_bbox(northamerica_view)


legend_sizes <- centr_with_dat |>
  group_by(TotalInsp_b) |>
  summarise(size = log(mean(TotalInsp, na.rm = TRUE) + 1)) |>
  arrange(TotalInsp_b) |>
  pull(size)

home_res_plot<-ggplot() +
  tidyterra::geom_spatraster_rgb(data = north_america_stations_basemap_colour) +
  coord_sf(
    xlim = c(northamerica_view_bbox$xmin, northamerica_view_bbox$xmax),
    ylim = c(northamerica_view_bbox$ymin, northamerica_view_bbox$ymax),
    crs = st_crs(4326)
  ) +
  geom_sf_text(
    data = centr_without_dat,
    aes(label = ABBR),
    size = 2.5,
    color = "grey50",
    check_overlap = TRUE
  ) +
  geom_sf(
    data = centr_without_dat,
    shape = 21,
    size = 1,
    fill = "grey90",
    color = "grey70"
  ) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = factor(TotalInsp_b), size = TotalInsp),
    shape = 21,
    color = "black"
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR),
    size = 2.5,
    check_overlap = TRUE
  ) +

  scale_fill_manual(
    name = paste0(my.year, " Home Residence\nFrequency"),
    values = my_colors,
    labels = unique(centr_with_dat$bin_label),
    breaks = unique(centr_with_dat$TotalInsp_b),
    guide = guide_legend(
      order = 1,
      override.aes = list(size = legend_sizes)
    )
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +

  ggthemes::theme_map() +
  theme(
    legend.position = c(0.05, 0.05),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black",
      linetype = "solid"
    )
  )

home_res_plot



if(!interactive()) {
# tmap_save(tm = map_3_tmap, filename = 'Map3_Home_Residence_Frequency.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Map3_Home_Residence_Frequency.jpg"),
         plot = home_res_plot,
         width = 7.6, height = 6.4, dpi = 300)
}
```

### Optional Figure: Total and High-risk Inspections at Boat Launches

```{r}
boatlaunch_dat = dat |> 
  filter(Station %in% c("Penticton Roving","Lower Mainland Roving")) |> 
  filter(str_detect(Shift_Start_Comment,'(lake|Lake|boat l|Boat L)')) |> 
  mutate(likely_lake = str_extract(Shift_Start_Comment,"[a-zA-Z]+(?= ((l|L)ake|(b|B)ay))")) |> 
  # dplyr::select(Station,TimeOfInspection,High_Risk_AIS_Ind,Shift_Start_Comment,likely_lake) |> 
  mutate(likely_lake = str_to_title(likely_lake)) |> 
  mutate(likely_lake = case_when(
    str_detect(Shift_Start_Comment,"summer land") ~ "Summerland",
    str_detect(Shift_Start_Comment,"Island 22") ~ "Island 22",
    str_detect(likely_lake,"(Kekuli|Kakuli)") ~ "Kekuli Bay",
    T ~ likely_lake
  )) 

boatlaunch_dat_count = boatlaunch_dat |> 
  dplyr::select(Station,TimeOfInspection,High_Risk_AIS_Ind,Shift_Start_Comment,likely_lake) |> 
  count(Station,High_Risk_AIS_Ind,likely_lake) |> 
  mutate(likely_lake = replace_na(likely_lake, 'Unknown Location')) |> 
  arrange(desc(n)) |> 
  mutate(likely_lake = as.factor(likely_lake)) |> 
  mutate(likely_lake = forcats::fct_inorder(likely_lake))

ggplot(boatlaunch_dat_count) + 
  geom_col(aes(x = likely_lake, y = n, fill = Station, group = High_Risk_AIS_Ind, col = High_Risk_AIS_Ind), position = position_dodge()) + 
  scale_color_manual(values = c("FALSE" = "transparent", "TRUE" = "red")) +
  scale_fill_brewer(palette = 'Set2') +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
  labs(x = "Roving Inspection at Boat Launch", y = "Number of Inspections",
       fill = 'Roving Station',
       color = 'High Risk Inspection')
```

### Brief Aside: Roving Stations whose location is unknown (not boat launch nor scheduled inspection)
```{r}
boatlaunch_dat |> 
  dplyr::select(Station,TimeOfInspection,High_Risk_AIS_Ind,Shift_Start_Comment,likely_lake) |> 
  dplyr::filter(is.na(likely_lake)) |> 
  dplyr::select(Station,Shift_Start_Comment) |> 
  knitr::kable()
```

### Brief Aside: Breakdown of High-risk / Low-risk for Scheduled Inspections
```{r}
# Look at 'scheduled inspection' records
dat |> 
  filter(str_detect(Station,"^Scheduled")) |> 
  count(Station,High_Risk_AIS_Ind, name = 'Number of Inspections') |> 
  knitr::kable()


### ADJUST THIS TO ALSO LOOK IN THE COMMENT FIELD FOR 'SCHEDULED' ETC.
```

### Figure 12 Percent Compliance by station

```{r fig12_percent_compliance_by_station}
# Read in blowbys
blowb = vroom::vroom(paste0(zqm.operations.folder,"Watercraft Inspection Data/Raw inspection data for sharing (all years)/Clean files all years/metabase_blowby_table_2024_onwards.csv")) |> 
  purrr::set_names(snakecase::to_snake_case) |> 
  dplyr::rename(Workflow_ID = observer_workflow_id) |> 
  dplyr::mutate(Workflow_ID = as.character(Workflow_ID))

blowb = blowb |> 
  left_join(
    dat |> 
      dplyr::select(Workflow_ID,
                   Station) |> 
      dplyr::distinct()
  ) |> 
  dplyr::filter(!is.na(Station))

dat_w_blowbys = dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  filter(!Station %in% c("Lower Mainland Roving","Penticton Roving")) |> 
  dplyr::filter(Station %in% stations.to.include) |> 
  group_by(Station,Shift_ID,Workflow_ID) |> 
  summarise(NumberInsp = n()) |> 
  #Add number of non-motorized blow-bys per unique station / shift combo.
  left_join(
    blowb |> 
      dplyr::filter(watercraft_complexity == 'Non-motorized') |> 
      dplyr::count(Workflow_ID,sort = T, name = "Non_Motorized_Blow_Bys_Counter")
  ) |> 
    #Add number of motorized blow-bys per unique station / shift combo.
  left_join(
    blowb |> 
      dplyr::filter(watercraft_complexity != 'Non-motorized') |> 
      dplyr::count(Workflow_ID,sort = T, name = "Motorized_Blow_Bys_Counter")
  ) |> 
  dplyr::mutate(dplyr::across(c(Non_Motorized_Blow_Bys_Counter,Motorized_Blow_Bys_Counter), \(x) tidyr::replace_na(x,0))) |> 
  group_by(Station) |> 
  summarise(NumberInsp = sum(NumberInsp),
            Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
            Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) 

p12 = dat_w_blowbys |> 
  group_by(Station) |> 
  summarise(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter)) |> 
  arrange(desc(PercentCompliance)) |> 
  #Add station type...
  left_join(station_types) |> 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) |> 
  mutate(StationLabel = fct_reorder(StationLabel, -PercentCompliance)) |> 
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=PercentCompliance), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,
                y=PercentCompliance+max(PercentCompliance)*0.05,
               label=paste0(round(PercentCompliance,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Compliance") + 
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p12

if(!interactive()) {
ggsave("Fig12_PercentCompliance_Station.jpg",p12)
}
```

```{r total_compliance_not_by_station}
if(my_opts$year < 2024){
  dat |> 
    filter(!Station %in% rovers_to_drop) |> 
    group_by(Shift_ID) |> 
    summarise(NumberInsp = n()) |> 
    #Add number of non-motorized blow-bys per unique station / shift combo.
    left_join(dat |> 
                group_by(Shift_ID) |> 
                mutate(Non_Motorized_Blow_Bys_Counter = as.numeric(Non_Motorized_Blow_Bys_Counter)) |> 
                select(Shift_ID,Non_Motorized_Blow_Bys_Counter) |> 
                distinct()) |> 
    #Add number of motorized blow-bys per unique station / shift combo.
    left_join(dat |> 
                group_by(Shift_ID) |> 
                mutate(Motorized_Blow_Bys_Counter = as.numeric(Motorized_Blow_Bys_Counter)) |> 
                select(Shift_ID,Motorized_Blow_Bys_Counter) |> 
                distinct()) |> 
    # group_by(Station) |> 
    summarise(NumberInsp = sum(NumberInsp),
              Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
              Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) |> 
    # group_by(Station) |> 
    summarise(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter)) |> 
    arrange(desc(PercentCompliance)) |> 
    knitr::kable()
  
  print(paste0((my.year-1),"'s Compliance for comparison..."))
  
  dat_all |>
    filter(Year == my.year-1) |> 
    filter(!Station %in% rovers_to_drop) |> 
    group_by(Shift_ID) |> 
    summarise(NumberInsp = n()) |> 
    dplyr::ungroup() |> 
    dplyr::filter(!duplicated(Shift_ID)) |> 
    #Add number of non-motorized blow-bys per unique station / shift combo.
    left_join(dat_all |>
                filter(Year ==  my.year-1) |> 
                group_by(Shift_ID) |> 
                mutate(Non_Motorized_Blow_Bys_Counter = as.numeric(Non_Motorized_Blow_Bys_Counter)) |> 
                dplyr::ungroup() |> 
                select(Shift_ID,Non_Motorized_Blow_Bys_Counter) |> 
                distinct() |> 
                dplyr::filter(!duplicated(Shift_ID))
                ) |> 
    #Add number of motorized blow-bys per unique station / shift combo.
    left_join(dat_all |>
                filter(Year ==  my.year-1) |> 
                group_by(Shift_ID) |> 
                mutate(Motorized_Blow_Bys_Counter = as.numeric(Motorized_Blow_Bys_Counter)) |> 
                dplyr::ungroup() |> 
                select(Shift_ID,Motorized_Blow_Bys_Counter) |> 
                distinct() |> 
                dplyr::filter(!duplicated(Shift_ID))) |> 
    # group_by(Station) |> 
    summarise(NumberInsp = sum(NumberInsp),
              Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
              Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) |> 
    # group_by(Station) |> 
    summarise(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter))
  
  print('Of the non-compliant boats, the following percentage were non-motorized:')
  
  non_motorized_number = dat |> 
    group_by(Shift_ID) |> 
    mutate(Non_Motorized_Blow_Bys_Counter = as.numeric(Non_Motorized_Blow_Bys_Counter)) |> 
    dplyr::ungroup() |> 
    select(Shift_ID,Non_Motorized_Blow_Bys_Counter) |> 
    distinct() |> 
    dplyr::summarise(total = sum(Non_Motorized_Blow_Bys_Counter))
  
  number_motorized = dat |> 
    group_by(Shift_ID) |> 
    mutate(Motorized_Blow_Bys_Counter = as.numeric(Motorized_Blow_Bys_Counter)) |> 
    dplyr::ungroup() |> 
    select(Shift_ID,Motorized_Blow_Bys_Counter) |> 
    distinct() |> 
    dplyr::summarise(total = sum(Motorized_Blow_Bys_Counter))
  
  paste0(100*round(non_motorized_number / (non_motorized_number + number_motorized),4), "%")
} else {
  # From 2024 onwards, blowbys are now recorded in a table that is separate from the inspections.
  dat |> 
    filter(!Station %in% rovers_to_drop) |> 
    # filter(!Station %in% c("Lower Mainland Roving","Penticton Roving")) |> 
    dplyr::filter(Station %in% stations.to.include) |> 
    group_by(Station,Shift_ID,Workflow_ID) |> 
    summarise(NumberInsp = n()) |> 
    dplyr::ungroup() |> 
    #Add number of non-motorized blow-bys per unique station / shift combo.
    left_join(
      blowb |> 
        dplyr::filter(watercraft_complexity == 'Non-motorized') |> 
        dplyr::count(Workflow_ID,sort = T, name = "Non_Motorized_Blow_Bys_Counter")
    ) |> 
    #Add number of motorized blow-bys per unique station / shift combo.
    left_join(
      blowb |> 
        dplyr::filter(watercraft_complexity != 'Non-motorized') |> 
        dplyr::count(Workflow_ID,sort = T, name = "Motorized_Blow_Bys_Counter")
    ) |> 
  dplyr::mutate(dplyr::across(c(Non_Motorized_Blow_Bys_Counter,Motorized_Blow_Bys_Counter), \(x) tidyr::replace_na(x,0))) |> 
    dplyr::reframe(NumberInsp = sum(NumberInsp),
                   Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
                   Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) |> 
    dplyr::reframe(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter))
  
  # What percentage were non-motorized?
  number_blowb_nonmot = blowb |> 
    dplyr::filter(watercraft_complexity == 'Non-motorized') |> 
    dplyr::reframe(number_non_mot = n()) 
  
  number_blowb_total = blowb |> 
    dplyr::count(watercraft_complexity) |> 
    dplyr::reframe(total_blowbys = sum(n))
        
  print(paste0(round(100*number_blowb_nonmot / number_blowb_total,1), "% of blowbys were non-motorized"))
}
```

### Blowbys By Hour
```{r}

blowb_by_hour = blowb |> 
  dplyr::filter(lubridate::year(blow_by_time) == my_opts$year) |> 
  dplyr::mutate(the_hour = lubridate::hour(blow_by_time)) |> 
  dplyr::mutate(is_overnight = the_hour <= 5 | the_hour > 20) |> 
  dplyr::count(is_overnight,the_hour, name = 'Number of Blowbys')

blowb_by_hour |> 
  dplyr::group_by(is_overnight) |> 
  dplyr::reframe(total_blowbys = sum(`Number of Blowbys`))

blowby_by_hour_plot = ggplot() +
  geom_col(data = blowb_by_hour, aes(x = the_hour, y = `Number of Blowbys`, fill = is_overnight)) + 
  labs(fill = "Overnight\nInspection\n(21:00 to 5:59)", x = "Hour of Day") +
  theme_classic()


ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/blowbys_by_hour.jpg"),
       plot = blowby_by_hour_plot,
       height = 4, width = 8)
```

### Figure 13 Noncompliant Watercraft Breakdown
```{r fig13_noncompliant_breakdown}

p13 = dat_w_blowbys |> 
  dplyr::rename(m = Motorized_Blow_Bys_Counter,
                nonm = Non_Motorized_Blow_Bys_Counter) |> 
  mutate(Total_Blowbys = nonm + m) |> 
  group_by(Station) |> 
  reframe(`Non-Motorized` = 100*nonm/Total_Blowbys,
            Motorized = 100*m/Total_Blowbys) |> 
  arrange(desc(`Non-Motorized`)) |> 
  dplyr::filter(!is.nan(Motorized)) |> 
  #mutate(Station = factor(Station, levels = .$Station)) |> 
  pivot_longer(cols = -Station) |>
  arrange(desc(value),Station) |> 
  left_join(station_types) |> 
  mutate(StationLabel = paste0(Station,
                         ifelse(StationType == "Roving", "*", ""))) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |>
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=value,
               fill = name),
           col = "black",
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Blow-bys", fill = "") + 
  scale_fill_manual(values = c("Non-Motorized" = my.grey,
                               "Motorized" = "grey")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p13

if(!interactive()) {
ggsave("Fig13_Percent_Blowbys_Station.jpg",p13)
}
```

### Figure 14 Percent Watercraft Inspected with Previous Inspection

```{r fig14_percent_watercraft_insp_with_prev_insp}
p14_dat = dat |> 
  dplyr::filter(Station %in% stations.to.include) |>
  # filter(!Station %in% c("Scheduled Inspection",
  #                        "Okanagan",
  #                        "Other", "Penticton Roving")) |> 
  group_by(Station) |> 
  summarise(TotalInsp = n()) |> 
  left_join(dat |> 
              filter(!Station %in% c("Scheduled Inspection",
                         "Okanagan",
                         "Other")) |> 
              filter(Previous_Inspection_Ind == T) |> 
              group_by(Station) |> 
              summarise(PrevInspected = n())
            ) |> 
  # Drop rows where we have fewer than 5 inspections
  dplyr::filter(TotalInsp >= 5) |> 
  # dplyr::filter(Station != "Lower Mainland Roving") |> 
  mutate(PercPrevInsp = 100*PrevInspected/TotalInsp) |> 
  arrange(desc(PercPrevInsp)) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  dplyr::filter(!is.na(PercPrevInsp))
  
max_perc_plus_buffer = 10*ceiling(max(p14_dat$PercPrevInsp)*1.3 / 10)

p14 = p14_dat |> 
  ggplot() + 
  geom_col(aes(x=StationLabel,
               y=PercPrevInsp), fill = my.grey, width = 0.40) +
  geom_text(aes(x=StationLabel,
                y=PercPrevInsp+max(PercPrevInsp)*0.1,
               label=paste0(round(PercPrevInsp,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected") + 
  scale_y_continuous(breaks = seq(0,max_perc_plus_buffer,10), 
                     limits = c(0,max_perc_plus_buffer),
                     labels = paste0(seq(0,max_perc_plus_buffer,10),"%")) +  
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

if(interactive()){
  # For inspections that were previously inspected prior, calculate the % 
  # per each grouping of time (e.g. )
  dat |> 
  filter(!Station %in% c("Scheduled Inspection",
                         "Okanagan",
                         "Other", "Penticton Roving"))
}

p14

if(!interactive()) {
ggsave("Fig14_Percent_Intercepted_with_Prev_Insp.jpg",p14)
}
```

### Figure 15 Frequency of Previously Inspected Watercraft's Inspections

```{r fig15_prev_insp_watercraft_insp_time}
#Remove Penticton Roving
figure_15 = dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  dplyr::filter(Station %in% stations.to.include) |> 
  filter(Previous_Inspection_Ind == T) |> 
  filter(!is.na(Previous_Inspection_Days_Count)) |> 
  mutate(previnsp = case_when(
    Previous_Inspection_Days_Count %in% c('0','Same day') ~ 'Same Day',
    Previous_Inspection_Days_Count %in% c('30','60','180') ~ '> 30 Days',
    Previous_Inspection_Days_Count %in% c('< 30 days','<30 days') ~ '< 30 Days',
    Previous_Inspection_Days_Count == '> 30 days' ~ '> 30 Days',
    Previous_Inspection_Days_Count == '> 1 year' ~ '> 1 Year',
    T ~ NA
  )) |> 
  select(Station, previnsp) |> 
  count(Station, previnsp, name = 'NumberInsp') |>
  group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
  mutate(PercInsp = 100*NumberInsp/TotalInsp) |> 
  mutate(previnsp = factor(previnsp, 
                                  levels = c("Same Day",
                                             "< 30 Days",
                                             "> 30 Days",
                                             "> 1 Year"))) |> 
  arrange(Station,previnsp) |> 
  select(Station,previnsp,PercInsp) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel))

# station_order = figure_15 |> 
#   # filter(previnsp == '< 30 Days') |> 
#   # bind_rows(tibble(
#   #   Station = 'Keremeos',
#   #   StationLabel = 'Keremeos*', 
#   #   previnsp = '< 30 Days', PercInsp = 0)
#   #   )|> 
#   arrange(desc(PercInsp)) |> 
#   dplyr::filter()
#   dplyr::pull(StationLabel)

p15 = figure_15 |>
    # mutate(StationLabel = factor(StationLabel, levels = c(station_order))) |> 
  ggplot() +
  geom_col(aes(x=StationLabel,
               y=PercInsp,
               fill = previnsp),
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected", fill = "") + 
  scale_fill_manual(values = c("Same Day" = "#ab52c5",
                               "< 30 Days" = "#8b9f4a",
                               "> 30 Days" = "#cc0000",
                               "> 1 Year" = "#2986cc")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p15 

cat("\nDate Bins for all inspection data from this year:")

# Drop the station grouping level; get these stats across all stations.
dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  filter(Previous_Inspection_Ind == T) |> 
  filter(!is.na(Previous_Inspection_Days_Count)) |> 
  mutate(previnsp = case_when(
    Previous_Inspection_Days_Count %in% c('0','Same day') ~ 'Same Day',
    Previous_Inspection_Days_Count %in% c('30','60','180') ~ '> 30 Days',
    Previous_Inspection_Days_Count %in% c('< 30 days','<30 days') ~ '< 30 Days',
    Previous_Inspection_Days_Count == '> 30 days' ~ '> 30 Days',
    Previous_Inspection_Days_Count == '> 1 year' ~ '> 1 Year',
    T ~ NA
  )) |> 
  select(previnsp) |> 
  count(previnsp, name = 'NumberInsp') |>
  # group_by(Station) |> 
  mutate(TotalInsp = sum(NumberInsp)) |> 
    mutate(prop = 100*NumberInsp / TotalInsp) |> 
  knitr::kable()

if(!interactive()) {
ggsave("Fig15_Percent_PreviouslyInspected_Date_Bins.jpg",p15)
}
```

### Figure of Pull the Plug Compliance
```{r}
dat_w_plugs = dat |> 
  dplyr::filter(Watercraft_Has_Drainplugs_Ind)

pl_of_plugs = dat_w_plugs |> 
  dplyr::count(Drainplug_Removed_at_Inspection_Ind) |> 
  dplyr::mutate(prop = 100*(n / sum(n))) |> 
  dplyr::arrange(-Drainplug_Removed_at_Inspection_Ind) |> 
  dplyr::mutate(Drainplug_Removed_at_Inspection_Ind = ifelse(Drainplug_Removed_at_Inspection_Ind,"Drainplug Removed","Drainplug not Removed")) |> 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) |> 
  ggplot(aes(x = "", y = prop, 
             fill = Drainplug_Removed_at_Inspection_Ind)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0) +
    geom_text_repel(aes(y = lab.ypos, x = 1.00, label = paste0(Drainplug_Removed_at_Inspection_Ind,"\n",round(prop,1),"%")),
                    color = "black", nudge_x = 0.7) + 
    theme_void() + 
    # scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Source") + 
    ggtitle("Pull the Plug Compliance") +
    theme(legend.position = "none")

pl_of_plugs

if(!interactive()) {
  ggsave(filename = paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig_of_Pull_the_Plug_Compliance.jpg"),
         plot = pl_of_plugs,
         width = 8, height = 4)
}
```

### Figure 16 Total High-risk Inspections over 3 years

```{r fig16_total_HR_insp_3_years}
p16_dat = dat_hr |> 
  #Filter for our target year and the 2 years prior
  filter(Year %in% c(my.year-2, my.year-1, my.year)) |> 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=T)) |> 
  group_by(Year,the.month) |> 
  summarise(Number_HR = n()) |> 
  ungroup() |> 
  #Add in a row for year-month combos with no records: 2020 April.
  add_row(Year = 2020,the.month = month(4,abbr=T,label=T),Number_HR = 0) |> 
  group_by(Year) |> 
  filter(!is.na(the.month)) |> 
  dplyr::filter(Year %in% (my.year-2):my.year)
  
p16 = ggplot() + 
  geom_col(
    data = p16_dat,
    aes(x=the.month,
               y=Number_HR,
               fill = as.character(Year)), 
           width = 0.40,
           col = "black",
           position = "dodge") +
  geom_text(
    data = p16_dat |> filter(Year == my.year),
            aes(x=the.month,
                y=Number_HR+max(Number_HR)*0.2,
               label=round(Number_HR,0)),
               nudge_x = 0.20) +
  theme_classic() +
  scale_fill_brewer(palette = 'Dark2') +
  # scale_fill_manual(values = c("darkgrey","lightgrey","black")) +
  labs(x = "",y = "Number of High-Risk Inspections", fill = 'Year')

p16

if(!interactive()) {
ggsave("Fig16_Total_HR_Inspections_3_year_spread.jpg",p16)
}
```

### Map 4. High-risk Inspections by Station

```{r fig17_map4_high_risk_insp_by_station}
# Join number of inspections to stations.
st = stations |> 
  left_join(dat |> 
              filter(High_Risk_AIS_Ind == TRUE) |> 
              count(Station, name = 'num_insp') |> 
              dplyr::rename(station_name = Station)) |> 
  filter(!is.na(num_insp))

# Get 5 levels of natural breaks ('jenks'); station circle size on map varies with this variable.
st = st |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(num_insp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(num_insp_b = case_when(
    num_insp <= jenks_2 ~ 1,
    num_insp <= jenks_3 ~ 2,
    num_insp <= jenks_4 ~ 3,
    num_insp <= jenks_5 ~ 4,
    num_insp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    num_insp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    num_insp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    num_insp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    num_insp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    num_insp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  # mutate(num_insp_b = factor(num_insp_b, levels = c(1:5))) |> 
  arrange(num_insp_b) |> 
  mutate(my_text_size = ifelse(str_detect(map_label,"(Roving|Border)+$"), 'small', 'medium'))

stations_sf = st_as_sf(st, coords = c("lon","lat"), crs = 4326)

# If interactive, show number of high-risk inspections by station as table.
# if(interactive()){
print("High-risk inspections by Station")
  
stations_sf |> st_drop_geometry() |> dplyr::select(station_name, num_insp) |> 
  arrange(desc(num_insp)) |> 
  knitr::kable()
# }

station_labels = st |> 
  sf::st_drop_geometry() |> 
  dplyr::mutate(lat = lat + 0.25) |> 
  dplyr::mutate(lat = case_when(
    map_label == 'Lower Mainland Roving' ~ lat + 0.1, 
    map_label == 'Penticton Roving' ~ lat - 0.1,
    T ~ lat)) |> 
  dplyr::mutate(lon = case_when(
    map_label == 'Lower Mainland Roving' ~ lon - 1,
    map_label == 'Penticton Roving' ~ lon + 1,
    T ~ lon)) |> 
  sf::st_as_sf(coords = c("lon","lat"),crs=4326)

# Try to bump Sumas Border and Yahk name further south.
if('Sumas Border' %in% unique(station_labels$station_name) & 'Yahk' %in% unique(station_labels$station_name)){
  station_labels = station_labels |> 
    dplyr::filter(!station_name %in% c("Sumas Border","Yahk")) |> 
    dplyr::bind_rows(
      station_labels |> 
        dplyr::filter(station_name %in% c('Sumas Border','Yahk')) |> 
        dplyr::mutate(lat = sf::st_coordinates(geometry)[,2],
                      lng = sf::st_coordinates(geometry)[,1]) |> 
        dplyr::mutate(lat = lat - 0.5) |> 
        sf::st_drop_geometry() |> 
        sf::st_as_sf(coords = c("lng","lat"), crs = 4326)
    )
}

my_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = st$num_insp_b,
  reverse = T
)

# map_4_tmap = tm_shape(bc_stations_basemap_green, bbox = bc_station_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' High Risk \nInspections'),
#                 type = 'symbol',
#                 labels = unique(stations_sf$bin_label),
#                 col = my_pal(unique(stations_sf$num_insp_b)),
#                 size = log(unique(stations_sf$num_insp_b)+1)) + 
#   tm_shape(bc_bound) +
#     tm_borders(col = 'grey', lwd = 2) +
#   tm_shape(stations_sf) + 
#     tm_symbols(col = "num_insp_b", palette = '-Spectral',
#                size = 'num_insp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                title.col = '') +
#     tm_text("map_label", auto.placement = 4, 
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_4_tmap

my_colors = RColorBrewer::brewer.pal(n = 5, name = "Spectral")[5:1]

map_high_risk_ggplot = ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_colour) +
  geom_sf(
    data = stations_sf,
    aes(fill = factor(num_insp_b), size = num_insp_b),
    shape = 21,
    color = "black"
  ) +
  geom_sf_label(data = station_labels_this_year, aes(label = map_label),
              size = 3, fill = "white", color = "black", label.size = 0.1)+
  scale_fill_manual(
    name = paste0(my.year, ' High Risk \nInspections'),
    values = my_colors,
    labels = unique(stations_sf$bin_label),
    breaks = unique(stations_sf$num_insp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(stations_sf$num_insp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    breaks = unique(stations_sf$num_insp_b),
    labels = unique(stations_sf$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

map_high_risk_ggplot


if(!interactive()) {
# tmap_save(tm = map_4_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map4_HighRisk_Inspections_by_Station.jpg'), width = 7.6, height = 6.4, dpi = 300)
ggsave(filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map4_HighRisk_Inspections_by_Station.jpg'), 
       plot = map_high_risk_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

```{r high_risk_number_summaries}
# if(interactive()){
  # Get number of inspections coming from a high-risk area.
print("High-risk inspections from high-risk areas or not:")

dat_hr |> 
  filter(Year == my.year) |> 
  count(High_Risk_Area_Ind) |> 
  knitr::kable()

print("All inspections this year from high-risk areas or not:")
dat |> 
  dplyr::filter(High_Risk_Area_Ind == T,
                High_Risk_AIS_Ind == F) |> 
  count(Previous_Waterbody_1_Province_Or_State,
        High_Risk_AIS_Ind,
        High_Risk_Area_Ind) |> 
  knitr::kable()
# }
print(paste0("Besides Alberta, there were this many inspections that were not HR for mussels but were HR for whirling disease: ",(nrow(dat |> 
  dplyr::filter(High_Risk_Area_Ind == T,
                High_Risk_AIS_Ind == F,
                Previous_Waterbody_1_Province_Or_State != "AB"))))
)

# if(interactive()){
print('Number of high-risk inspections that had been previously inspected')

dat_hr |> 
  filter(Year == my.year) |> 
  count(Previous_Inspection_Ind) |> 
  mutate(prop = 100*n/sum(n)) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Decontamination_Performed_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Decontamination_order_issued_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Quarantine_Period_Issued_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(High_Risk_AIS_Ind) |> 
  knitr::kable()

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(High_Risk_Area_Ind) |> 
  knitr::kable()

dat |> 
  dplyr::filter(!Watercraft_Risk_Assessment_ID %in% dat_hr$Watercraft_Risk_Assessment_ID) |> 
  dplyr::count(High_Risk_Area_Ind)

dat |> 
  dplyr::filter(Watercraft_Risk_Assessment_ID %in% dat_hr$Watercraft_Risk_Assessment_ID) |> 
  dplyr::count(Previous_Inspection_Ind)
  
# }
```

### Figure 18 Source Locations of High-Risk Inspections

```{r fig18_pie_chart_source_locations_HR_Insp}

# If interactive, show number of high-risk inspections by station as table.
# if(interactive()){
print("HR inspections source state/prov")

dat_hr |> 
  filter(Year == my.year) |> 
  dplyr::count(Previous_Waterbody_1_Province_Or_State) |> 
  arrange(desc(n)) |> 
  dplyr::mutate(proportion = 100*(n / sum(n))) |> 
  as.data.frame() |> 
  left_join(state_longnames |> dplyr::rename(Previous_Waterbody_1_Province_Or_State = abbr)) |> 
  knitr::kable()
# }

#Remove Penticton Roving
fig18_dat = dat_hr |> 
  filter(Year == my.year) |> 
  group_by(Previous_Waterbody_1_Province_Or_State) |> 
  summarise(BoatsFromPlace = n()) |> 
  mutate(TotalBoats = sum(BoatsFromPlace)) |> 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) |> 
  arrange(desc(PercBoatsFromPlace)) |> 
  mutate(Grouper = case_when(
    PercBoatsFromPlace >= 2 ~ "MainFig",
    PercBoatsFromPlace < 2 ~ "SecondFig")
  )

fig18_main_dat = fig18_dat |> 
  filter(Grouper == "MainFig") |> 
  #Add a row for "Other" (for which we have to add together the others)
  bind_rows(fig18_dat |> 
              filter(Grouper == "SecondFig") |> 
              group_by(TotalBoats) |> 
              summarise(BoatsFromPlace = sum(BoatsFromPlace)) |> 
              mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats,
                     Previous_Waterbody_1_Province_Or_State = "Other",
                     Grouper = "MainFig")) |> 
  rename(prop = PercBoatsFromPlace) |>
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) |> 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) |> 
  select(-BoatsFromPlace,-TotalBoats)

fig18_second_dat = fig18_dat |> 
  filter(Grouper != "MainFig") |> 
  rename(prop = PercBoatsFromPlace) |>
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) |> 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) |> 
  select(-BoatsFromPlace,-TotalBoats)

p18 = ggarrange(
  ggplot(fig18_main_dat,
         aes(x = "", y = prop, 
             fill = Previous_Waterbody_1_Province_Or_State)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0) +
    geom_text_repel(aes(y = lab.ypos, x = 1.00, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")),
                    color = "black", nudge_x = 0.7) + 
    theme_void() + 
    # scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Source") + 
    ggtitle("Main Sources") +
    theme(legend.position = "none"),
  ggplot(fig18_second_dat,
         aes(x = "", y = prop, 
             fill = Previous_Waterbody_1_Province_Or_State)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.00, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")), color = "black",nudge_x = 0.7) +
  theme_void() + 
  labs(fill = "Source") + 
  ggtitle("Breakdown of `Other`") +
  theme(legend.position = "none"),
ncol = 2, nrow = 1)

p18 

if(!interactive()) {
ggsave("Fig18_Inspection_Source_Pie_Charts.jpg",p18)
}
```

### Figure 19 Destination Regions of High-Risk Inspections

```{r fig19_pie_chart_destination_locations_HR_Insp}
#Quick aside - Martina wants to know how many of the HR inspections that have "Unknown" recorded in the DestRegion field also have the Source_wb_prov_unknown field toggled as T.

# dat_hr |>
#     filter(Year == my.year) |>
#     filter(DestRegion %in% c("unknown","Unknown")) |>
#     #filter(Destination_Major_City != "None") |>
#     filter(Unknown_Destination_Waterbody_Ind == T) |>
#     select(Destination_Waterbody_1_Name,
#            Destination_Waterbody_1_Closest_City,
#            Destination_Major_City,
#            Unknown_Destination_Waterbody_Ind,
#            General_Comment) |>
#   View(.)
# 
# #Total number of HR 2021 records for which destination region is Unknown.
# dat_hr |>
#   filter(Year == my.year) |>
#   filter(DestRegion %in% c("unknown","Unknown")) |>
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where destination major city is also unknown.
# dat_hr |>
#     filter(Year == my.year) |>
#     filter(DestRegion %in% c("unknown","Unknown")) |>
#     filter(Destination_Major_City != "None") |>
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where unknown destination waterbody indicator field is TRUE.
# dat_hr |>
#   filter(Year == my.year) |>
#   filter(DestRegion %in% c("unknown","Unknown")) |>
#   filter(Unknown_Destination_Waterbody_Ind == T) |>
#   summarise(n())

fig19_dat = dat_hr |> 
  filter(Year == my.year) |> 
#Clean up destination regions.
  mutate(DestRegion = case_when(
    str_detect(DestRegion, "Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "going to Vancouver") ~ "Lower Mainland",
    str_detect(General_Comment, "to Pacific Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "Kelowna") ~ "Okanagan",
    str_detect(General_Comment, "Alaska") ~ "Outside BC",
    str_detect(General_Comment, "Vancouver Island") ~ "Vancouver Island",
    str_detect(General_Comment, "risk of entering BC waters") ~ "Outside BC",
    T ~ DestRegion
  )) |> 
  group_by(DestRegion) |> 
  summarise(BoatsFromPlace = n()) |> 
  mutate(TotalBoats = sum(BoatsFromPlace)) |> 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) |> 
  #Add the FLNRO regions...to do this, for each water body name in the FLNRO lookup table, I sort the FLNRO regions based on their
#number, low to high (e.g. 1, 2, 3 -> 7), remove the O and P from regions 7,
#and keep only the first match between a named water body and a region's water body.
  left_join(flnro_lookup |> 
              rename(DestRegion = GNIS_NAME_) |> 
              mutate(REGION_G = str_remove(REGION_G,"[A-Z]{1}")) |> 
              arrange(DestRegion,REGION_G) |> 
              group_by(DestRegion) |> 
              slice(1)) |> 
#Any holes in this lookup table (e.g. cities) should be filled with DestRegion values, unless
  # those values have the word 'Lake' or 'River' in them, which indicates an unsuccessful spatial
  # match to BC waterbodies (indicating a destination region outside of BC!).
  mutate(REGION_N = case_when(
         is.na(REGION_N) & !str_detect(DestRegion, "(Lake|River)") ~ DestRegion,
         is.na(REGION_N) & str_detect(DestRegion, '(Lake|River)') ~ 'Outside BC',
         T ~ REGION_N)) |> 
  group_by(REGION_N) |> 
  summarise(prop = sum(PercBoatsFromPlace)) |> 
  dplyr::mutate(REGION_N = ifelse(REGION_N == 'No Match', 'Unknown', REGION_N)) |> 
  dplyr::group_by(REGION_N) |> 
  dplyr::summarise(prop = sum(prop))

# Quick test - how many regions fall into the 'Other' category?
# If it's 2 or less, just keep a single figure.
count_for_other_pie = nrow(fig19_dat |> 
  filter(prop <= 2))

if(count_for_other_pie > 2){
  fig19_main_dat = fig19_dat |> 
    filter(prop > 2) |> 
    bind_rows(fig19_dat |> 
                filter(prop <= 2) |> 
                summarise(prop = sum(prop)) |> 
                mutate(REGION_N = "Other")) |> 
    arrange(desc(REGION_N)) |> 
    mutate(lab.ypos = cumsum(prop) - 0.5*prop)
} else {
  fig19_main_dat = fig19_dat |> 
    arrange(desc(REGION_N)) |> 
    mutate(lab.ypos = cumsum(prop) - 0.5*prop)
}

#Make colour palette that has 9 colours!
dark_pal_9 = brewer.pal(9, name = "Dark2") |> str_replace("#666666","#d63735")

dark_pal_9 = c(
  `a` = "#1B9E77",
  `b` = "#D95F02",
  `c` = "#7570B3",
  `d` = "#E7298A",
  `e` = "#66A61E",
  `f` = "#E6AB02",
  `g` = "#A6761D",
  `h` = "#d63735",
  `i` = "#2999d2")

darkpal_9_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (dark_pal_9)
  dark_pal_9[cols]
}

darkpal_9_palette = list("main" = darkpal_9_cols("a","b","c","d","e","f","g","h","i"))

darkpal_9_function <- function(palette = "main", reverse = FALSE, ...) {
  pal <- darkpal_9_palette[[palette]]
  if (reverse) pal <- rev(pal)
  colorRampPalette(pal, ...)
}

scale_fill_darkpal9 <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- darkpal_9_function(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("darkpal_9_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

if(count_for_other_pie > 2){
p19 = ggarrange(
  ggplot(fig19_main_dat,
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black", nudge_x= 1)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Main Destination Regions") +
  scale_fill_darkpal9() + 
  labs(fill = "Destination Region"),
  
  ggplot(fig19_dat |> 
           filter(prop <= 2) |> 
           arrange(desc(REGION_N)) |> 
           mutate(lab.ypos = cumsum(prop) - 0.5*prop),
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=0.7)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Breakdown of `Other`") +
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region"),
  nrow = 1, ncol = 2)
} else {
  p19 = ggplot(fig19_main_dat,
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=1,force=1)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Destination Regions") +
  scale_fill_darkpal9() + 
  labs(fill = "Destination Region")
}

p19

if(!interactive()) {
  ggsave("Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19,height=5)
}

# getwd()

# ggsave("02_IMDP_Figure_Generator/output/Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19)
```

### Map 5. Home Residence Frequency of High-risk Inspections

```{r map_5_home_residence_freq_high_risk}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(HRInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HRInsp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(HRInsp_b = case_when(
    HRInsp <= jenks_2 ~ 1,
    HRInsp <= jenks_3 ~ 2,
    HRInsp <= jenks_4 ~ 3,
    HRInsp <= jenks_5 ~ 4,
    HRInsp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    HRInsp_b == 1 ~ paste0('1 - ',jenks_2),
    HRInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HRInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HRInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HRInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  # mutate(HRInsp_b = factor(HRInsp_b, levels = c(1:5))) |> 
  arrange(HRInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(HRInsp)))

source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$HRInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(HRInsp))
centr_without_dat = sources_centroid |> filter(is.na(HRInsp))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(HRInsp_b))


# Make a version of centr_with_dat that is slightly offset;
# this might help to have text labels not on top of circles.
centr_offset = centr_with_dat |> 
  dplyr::mutate(lat = sf::st_coordinates(geom)[,2],
                lng = sf::st_coordinates(geom)[,1]) |> 
  dplyr::mutate(lat = lat - 2,
                lng = lng - 2) |> 
  sf::st_drop_geometry() |> 
  sf::st_as_sf(coords = c("lng","lat"), crs = 4326)

map_home_res_high_risk_ggplot = ggplot() +
  tidyterra::geom_spatraster_rgb(data = north_america_stations_basemap_colour) +
  coord_sf(
    xlim = c(northamerica_view$xmin, northamerica_view$xmax),
    ylim = c(northamerica_view$ymin, northamerica_view$ymax),
    crs = st_crs(4326)
  ) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = factor(HRInsp_b), size = HRInsp_b),
    shape = 21,
    color = "black"
  ) +
  geom_sf_text(
    data = centr_offset,
    aes(label = ABBR),
    size = 2.5,
    check_overlap = TRUE
  ) +
  scale_fill_manual(
    name = paste0(my.year, ' Source of \nHigh Risk Inspections'),
    values = unique(centr_with_dat$my_colors),
    labels = unique(centr_with_dat$bin_label),
    breaks = unique(centr_with_dat$HRInsp_b),
    guide = guide_legend(order = 1, override.aes = list(size = log(unique(centr_with_dat$HRInsp_b) + 1) * 3))
  ) +
  scale_size_continuous(
    name = "Inspection Volume",
    range = c(2, 6),
    breaks = unique(centr_with_dat$HRInsp_b),
    labels = unique(centr_with_dat$bin_label),
    guide = "none"
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c("left", "bottom"),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(fill = alpha("white", 0.7), color = "black",
                                     linetype = "solid")
  )

map_home_res_high_risk_ggplot


if(!interactive()) {
# tmap_save(tm = map_5_tmap, filename = paste0(my.external.output.folder, '/GIS Maps and Excel Figures/ExcelFigures/Map5_Home_Residence_Frequency_HighRisk_2.jpg'), width = 7.6, height = 6.4, dpi = 300)

  ggsave(filename = paste0(my.external.output.folder, '/GIS Maps and Excel Figures/ExcelFigures/Map5_Home_Residence_Frequency_HighRisk_2.jpg'), 
       plot = map_home_res_high_risk_ggplot, width = 7.6, height = 6.4, dpi = 300)
  
}
```

### Map 6. Destination locations of High Risk Inspections

```{r dest_location_high_risk_inspections}
dest_wb = read_sf(paste0('W:/CMadsen/Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Waterbodies_with_Inspection_Data_Summaries_',my.year,'.gpkg')) |> 
  st_transform(crs = 4326)

dest_wb_hr = dest_wb |> 
  mutate(HighRisk = HR_mot + HR_nonmot) |> 
  filter(HighRisk > 0)

# We're going to lose the geometry of this table in the next step.
# Save it to be reattached later!
# dest_wb_hr$geom

# Get 5 (or fewer, if data demands) levels of natural breaks ('jenks'); colour of waterbodies depends on these bins.
dest_wb_hr = dest_wb_hr |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(HighRisk, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(HighRisk_b = case_when(
    HighRisk <= jenks_2 ~ 1,
    HighRisk <= jenks_3 ~ 2,
    HighRisk <= jenks_4 ~ 3,
    HighRisk <= jenks_5 ~ 4,
    HighRisk <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    HighRisk_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    HighRisk_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    HighRisk_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    HighRisk_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    HighRisk_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  arrange(HighRisk_b) |> 
  dplyr::mutate(bin_label = str_replace(bin_label,"1 - 1","1"))

my_pal = leaflet::colorFactor(
  palette = 'RdYlGn',
  domain = dest_wb_hr$HighRisk_b,
  reverse = T
)

labels = unique(dest_wb_hr$bin_label)

dest_wb_hr = st_set_geometry(dest_wb_hr, dest_wb_hr$geom)

# Remove labels for all waterbodies below a 'yellow' level of HR inspections.
dest_wb_hr = dest_wb_hr |>
  mutate(GNIS_NA_label = ifelse(as.numeric(HighRisk_b) >= 3 | GNIS_NA %in% c("Elk River","Kootenay Lake"), GNIS_NA, NA))

# Buffer the destination waterbodies a bit.
dest_wb_hr = st_buffer(dest_wb_hr, 500)

# Add in counts for each of the bins.
# bin_label_w_count = dest_wb_hr |> 
#   sf::st_drop_geometry() |> 
#   dplyr::count(bin_label) |> 
#   dplyr::mutate(bin_label_w_count = paste0(bin_label, " (",n,")")) |> 
#   dplyr::select(-n)

# dest_wb_hr = dest_wb_hr |> 
#   dplyr::left_join(bin_label_w_count)

# Which bins are composed of a single lake?
single_member_bins = dest_wb_hr |> 
  sf::st_drop_geometry() |> 
  dplyr::count(bin_label) |> 
  dplyr::filter(n == 1) |> 
  dplyr::pull(bin_label)

# Add word 'watercraft' to bin labels

dest_wb_hr = dest_wb_hr |> 
  dplyr::mutate(bin_label_precise = case_when(
    bin_label %in% single_member_bins ~ as.character(highrisk_Counter),
    T ~ bin_label
  )) |> 
  dplyr::mutate(bin_label_precise = paste0(bin_label_precise,' watercraft'))

# Calculate the centroid for each waterbody, add a dot there.
dest_wb_hr_centr = sf::st_centroid(dest_wb_hr)

# Make palette
Breaks <- unique(c(dest_wb_hr$jenks_1,dest_wb_hr$jenks_2,dest_wb_hr$jenks_3,dest_wb_hr$jenks_4,dest_wb_hr$jenks_5))
Labels <- unique(dest_wb_hr$bin_label_precise)
MyPalette <- c("#4e92e6", "#26e0ce","gold","orange","darkred")

bc_station_view_pushed_north = bc_station_view
bc_station_view_pushed_north[4] = 57

# map_6_tmap = tm_shape(bc_stations_basemap_colour, 
#                       bbox = bc_station_view_pushed_north
#                       # bbox = st_bbox(dest_wb_hr)
#                       ) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' High Risk\nDestination Waterbodies')) +
#   tm_shape(bc_bound) + 
#     tm_borders(col = 'grey', lwd = 2) +
#   tm_shape(dest_wb_hr_centr) + 
#     tm_dots(col = "bin_label", 
#             palette = MyPalette,
#             legend.show = F,
#             size = 0.25) +
#   tm_shape(dest_wb_hr) +
#     tm_fill(col = "bin_label_precise", 
#             palette = MyPalette,
#             title = '',
#             legend.col.show = T,
#             title.col = '') +
#   tm_text("GNIS_NA_label", 
#           col = 'black',
#           auto.placement = F, 
#           overwrite.lines = T,
#           just = 'top',
#             size = 0.75) +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_6_tmap
raster_bbox <- terra::ext(bc_stations_basemap_colour)
raster_bbox_df <- data.frame(
  xmin = raster_bbox[1],
  xmax = raster_bbox[2],
  ymin = raster_bbox[3],
  ymax = raster_bbox[4]
)


map_6_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_white) +
  geom_sf(data = bc_bound, color = "grey", fill = NA, linewidth = 1) +
  geom_sf(data = dest_wb_hr, aes(fill = bin_label_precise), color = NA) +
  geom_sf(data = dest_wb_hr_centr,
          shape = 21, size = 3, color = "black", stroke = 0.2, aes(fill = bin_label_precise), show.legend = FALSE) +
  geom_sf_text(data = dest_wb_hr, aes(label = GNIS_NA_label),
               color = "black", size = 3, vjust = 1) +
  scale_fill_manual(name = paste0(my.year, " High Risk\nDestination Waterbodies"),
                    values = MyPalette) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black",
      linetype = "solid"
    ),
    legend.key = element_blank()
  ) +
  coord_sf(
    xlim = c(raster_bbox_df$xmin, raster_bbox_df$xmax),
    ylim = c(raster_bbox_df$ymin, raster_bbox_df$ymax),
    expand = FALSE
  )

map_6_ggplot

if(!interactive()) {
# tmap_save(tm = map_6_tmap, filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map6_Destination_locations_HighRisk.jpg'), width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = paste0(my.external.output.folder,'/GIS Maps and Excel Figures/ExcelFigures/Map6_Destination_locations_HighRisk.jpg'), map_6_ggplot,  width = 7.6, height = 6.4, dpi = 300)
}
# 
# tmap_save(tm = map_6_tmap, filename = 'Map6_Destination_locations_HighRisk.jpg', width = 7.6, height = 6.4, dpi = 300)
```

### Figure 22 Pie Chart of Total Watercraft Types

```{r fig22_pie_chart_total_watercraft_types}
p22 = dat |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  # mutate(value = replace(value, value > 1, 1)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  mutate(TotalBoats = sum(NumberBoats)) |>
  mutate(PercBoats = 100*NumberBoats/TotalBoats) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) |> 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49,
                      label = paste0(name,"\n",round(PercBoats,1),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p22

if(!interactive()) {
ggsave("Fig22_Total_Watercraft_Type_Pie_Chart.jpg",p22)
}
```

### Figure 23 Pie Chart of High-Risk Watercraft Types

```{r fig23_pie_chart_HR_watercraft_types}
p23 = dat_hr |> 
  filter(Year == my.year) |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  # mutate(value = replace(value, value > 1, 1)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  mutate(TotalBoats = sum(NumberBoats)) |> 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) |> 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x=1.49, label = paste0(name,"\n",round(PercBoats,1),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p23

if(!interactive()) {
ggsave("Fig23_Highrisk_Watercraft_Type_Pie_Chart.jpg",p23)
}
```


### Figure 24 Mussel-fouled By Month 5 Years
```{r fig24_musselfouled_by_month_all_years}
#If an excel sheet can be found in the Final Report > my.year > GIS Maps and Excel Figures folder, use that. We make this excel sheet automatically below, and it can be updated by hand after its creation.

if(file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
  mf_time_table = read_excel(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

#If that file does not yet exist...
if(!file.exists(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
#Read in the hand-cleaned excel sheet from 2020 report, and add more recent data to it.
mf_time_table = read_excel("J:/2 SCIENCE - Invasives/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/2020/GIS Maps and Excel Figures/ExcelFigureData/2019_Fig24_MusselFouled_byMonth_2017-2020.xlsx",sheet = "dat_for_R")

#Add my.year (and any intervening years between 2020 and my.year, if there are any)'s mf data to the excel sheet.
mf_time_table = mf_time_table |> 
  bind_rows(dat_mf |> 
              mutate(Month = month(TimeOfInspection, label = T, abbr = F)) |> 
              filter(Year %in% 2021:my.year) |> 
              group_by(Year,Month) |> 
              summarise(Number = n()) |> 
              pivot_wider(names_from = Month, values_from = Number)) |> 
  mutate(across(c(April:November), ~ replace_na(.x, 0))) |> 
  ungroup() |> 
  mutate(Total = (April+May+June+July+August+September+October+November))

#Save the excel file in my.year's folder.
write.xlsx(mf_time_table, paste0(my.external.output.folder,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

p24 = mf_time_table |> 
  pivot_longer(-Year) |> 
  filter(name != "Total") |> 
  dplyr::filter(name != "November") |> 
  filter(Year > my.year-5) |> 
  rename(Month = name) |> 
  mutate(NumberBoats = as.numeric(value),
         Month = factor(Month,levels = c("April","May","June","July","August","September","October","November"))) |> 
  mutate(Year = factor(Year, levels = c(2015:my.year))) |> 
  ggplot() + 
  geom_col(aes(x = Month, y=NumberBoats, fill=Year), col="black", position=position_dodge2(width = 0.5, preserve = "single")) + 
  scale_fill_brewer(palette = "Dark2") + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) + 
  labs(x = "", y = "Mussel Fouled Boats")

p24

if(!interactive()) {
ggsave("Fig24_Musselfouled_by_Month.jpg",p24)
}
```

### Figure 25 Source Provinces / States for Mussel-fouled Boats
```{r fig25_source_province_states_for_musselfouled}
# p25 = dat_mf |>
#   filter(Year == my.year) |>
#   rename(prev = Previous_Waterbody_1_Province_Or_State) |>
#   group_by(prev) |>
#   summarise(NumberBoats = n()) |>
#   left_join(abbrev |> rename(prev = Abbrev)) |>
#   arrange(desc(prev)) |>
#   mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |> 
#   ggplot(aes(x = "", y = NumberBoats, 
#            fill = Province_or_State)) +
#   geom_bar(width = 1, stat = "identity", color = "white") +
#   coord_polar("y", start = 0)+
#   geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Province_or_State,", ",NumberBoats)), 
#             color = "black",nudge_x=0.7)+
#   theme_void() + 
#   labs(fill = "Destination Region") + 
#   theme(legend.position = "none")

# Sadly, this piece must be updated by hand each year. Ultimately,
# the mussel-fouled data is too tricky to work in, since we 
# keep a hand-tracked excel sheet that changes frequently...
if(my.year == 2022){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Manitoba","Quebec")),
       NumberBoats = c(11,1,1))
}
if(my.year == 2023){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Nevada","Michigan","Manitoba","South Carolina")),
       NumberBoats = c(10,1,1,1,1))
}
if(my.year == 2024){
  p25_dat = tibble(Province_or_State = factor(c("Ontario","Utah","Arizona","Michigan","Manitoba","Quebec")),
       NumberBoats = c(4,1,2,2,2,1))
}
p25 = p25_dat |>
  arrange(desc(Province_or_State)) |> 
  # mutate(Province_or_State = forcats::fct_rev(Province_or_State)) |> 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |>
  ggplot(aes(x = "", y = NumberBoats,
           fill = Province_or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.65, label = paste0(Province_or_State,", ",NumberBoats)),
            color = "black",nudge_x=0)+
  theme_void() +
  labs(fill = "Destination Region") +
  theme(legend.position = "none")

p25

if(!interactive()) {
ggsave("Fig25_MusselFouled_Source_Regions_Pie_Charts.jpg",p25)
}
```

### Figure 26 Destination Regions of Mussel-fouled Inspections

```{r fig26_pie_chart_destination_locations_MF_Insp}
# As above, this one needs to be updated by hand each year...

# fig26dat = read_excel(MusselFouledTracker,
#                       sheet = MF_tracker_sheet)
# 
# p26 = fig26dat |> 
#   group_by(Region) |> 
#   reframe(Number = sum(Number)) |> 
#   arrange(desc(Region)) |> 
#   mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
#   ggplot(aes(x = "", y = Number, 
#            fill = Region)) +
#   geom_bar(width = 1, stat = "identity", color = "white") +
#   coord_polar("y", start = 0)+
#   geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.2)+
#   theme_void() + 
#   scale_fill_brewer(palette = "Dark2") + 
#   labs(fill = "Destination Region") +
#   theme(legend.position = "none")

if(my.year == 2022){
  p26 = tibble(Region = factor(c("Lower \nMainland","Okanagan","Vancouver \nIsland",'Thompson \nNicola')),
               Number = c(5,4,2,2)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
if(my.year == 2023){
    p26 = tibble(Region = factor(c("Lower \nMainland",
                                   "Thompson-Okanagan",
                                   "Peace",
                                   'Kootenay-Boundary')),
               Number = c(4,8,1,1)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
if(my.year == 2024){
    p26 = tibble(Region = factor(c("Thompson-Okanagan",
                                   "Lower Mainland",
                                   "Omineca",
                                   'Kootenay-Boundary')),
               Number = c(4,6,1,1)) |>
    arrange(desc(Region)) |> 
    mutate(lab.ypos = cumsum(Number) - 0.5*Number) |> 
    ggplot(aes(x = "", y = Number, 
               fill = Region)) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar("y", start = 0)+
    geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.4)+
    theme_void() + 
    scale_fill_brewer(palette = "Dark2") + 
    labs(fill = "Destination Region") +
    theme(legend.position = "none")
}
p26

if(!interactive()) {
ggsave("Fig26_MusselFouled_Destination_Regions_Pie_Charts.jpg",p26)
}
```

### Map 7. Source Location of Mussel-fouled Watercraft

```{r source_for_mussel_fouled}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(MFInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(MFInsp, k = 4))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(MFInsp_b = case_when(
    MFInsp <= jenks_2 ~ 1,
    MFInsp <= jenks_3 ~ 2,
    MFInsp <= jenks_4 ~ 3
  )) |>
  mutate(bin_label = case_when(
    MFInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    MFInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    MFInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4)
  )) |> 
  # mutate(MFInsp_b = factor(MFInsp_b, levels = c(1:3))) |> 
  arrange(MFInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(MFInsp))) |> 
  # And remove the row for BC.
  filter(NAME_1 != 'British Columbia')

source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$MFInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(MFInsp_b))
centr_without_dat = sources_centroid |> filter(is.na(MFInsp_b))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(MFInsp_b))

# map_7_tmap = tm_shape(northamerica_basemap, 
#                       bbox = northamerica_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Source of \nMussel Fouled Inspections'),
#                 type = 'symbol',
#                 # labels = c('1','11'),
#                 labels = unique(centr_with_dat$bin_label),
#                 col = unique(centr_with_dat$my_colors),
#                 size = log(unique(centr_with_dat$MFInsp_b)+1)) + 
#   tm_shape(centr_with_dat) + 
#     tm_symbols(col = "my_colors", 
#                palette = '-Spectral',
#                size = 'MFInsp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                title.col = '') +
#     tm_text("ABBR", auto.placement = 1, 
#             size = 0.75) +
#   # tm_shape(centr_without_dat) + 
#   #   tm_text("ABBR", col = 'grey', 
#   #           size = 0.8,
#   #           auto.placement = FALSE) +
#   #   tm_symbols(col = 'grey',
#   #              size = 0.1) + 
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('left','bottom'),
#             scale = 1.25)
# 
# map_7_tmap

legend_df <- centr_with_dat |>
  sf::st_drop_geometry() |>
  dplyr::select(bin_label, my_colors, MFInsp_b) |>
  distinct()

map_7_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = north_america_stations_basemap_colour) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = bin_label, size = MFInsp_b),
    shape = 21,
    color = "black",
    stroke = 0.2
  ) +
  geom_sf_text(
    data = centr_with_dat,
    aes(label = ABBR, color = map_label_colour),
    size = 3
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Source of\nMussel-Fouled Inspections"),
    values = setNames(legend_df$my_colors, legend_df$bin_label),
    guide = guide_legend(
      override.aes = list(
        shape = 21,
        fill = legend_df$my_colors,
        size = log(legend_df$MFInsp_b + 1)+1
      )
    )
  ) +
  scale_size_continuous(range = c(2, 6), guide = "none") +
  scale_color_identity() +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )

map_7_ggplot
if(!interactive()) {
# tmap_save(tm = map_7_tmap, filename = 'Map7_Home_Residence_Frequency_MusselFouled.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = 'Map7_Home_Residence_Frequency_MusselFouled.jpg', map_7_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

### Figure 28 Pie Chart of Mussel-fouled Watercraft Types

```{r fig28_pie_chart_MF_watercraft_types}
fig28_dat = dat_mf |> 
  filter(Year == my.year) |> 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) |> 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) |> 
  mutate(value = as.numeric(value)) |> 
  dplyr::mutate(value = ifelse(value > 0, 1, 0)) |> 
  group_by(name) |> 
  summarise(NumberBoats = sum(value)) |> 
  filter(NumberBoats > 0)

if(my.year == 2022){
  fig28_dat = fig28_dat |> 
    mutate(NumberBoats = ifelse(name == 'Very complex', 8, NumberBoats)) |> 
    add_row(name = 'Unknown', NumberBoats = 1)
}

fig28_dat |> 
  mutate(prop = 100*NumberBoats/sum(NumberBoats)) |> 
  knitr::kable()

p28 = fig28_dat |> 
  dplyr::mutate(name = ifelse(name == 'Non-motorized / Hand launched','Non-motorized / \nHand launched',name)) |> 
  arrange(desc(name)) |> 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) |> 

  ggplot(aes(x = "", y = NumberBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(name,"\n",NumberBoats)), 
            color = "black",nudge_x=0.4) +
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p28

if(!interactive()) {
ggsave("Fig28_Musselfouled_Watercraft_Type_Pie_Chart.jpg",p28)
}
```

### Figure 29 Commercially Hauled Boats

```{r fig29_commercially_hauled_boats}
print("Total count of commercially hauled boats:")

 dat |> 
  filter(Station != "Hwy 97c") |> 
   dplyr::count(Commercially_Hauled_Ind, name = 'Total_Inspection') |> 
   dplyr::left_join(
     dat |> 
       filter(Station != "Hwy 97c",
              High_Risk_AIS_Ind) |> 
       dplyr::count(Commercially_Hauled_Ind, name = 'HR_Inspection')) |> 
   dplyr::left_join(
     dat |> 
       filter(Station != "Hwy 97c",
              MusselsFound_Ind) |> 
       dplyr::count(Commercially_Hauled_Ind, name = 'Mussel_Fouled')
   )
 
 
 p29 = dat |> 
  filter(Commercially_Hauled_Ind == T,
         Station != "Hwy 97c") |> 
  # filter(Station %in% stations.to.include) |> 
  group_by(Station) |> 
  summarise(NumberBoats = n()) |> 
  arrange(desc(NumberBoats)) |> 
  left_join(station_types) |> 
  mutate(Station = as.factor(Station)) |> 
  ggplot() + 
  geom_col(aes(x=reorder(Station,-NumberBoats),y=NumberBoats),fill = my.grey, width = 0.40) +
  geom_text(aes(x=reorder(Station,-NumberBoats),y=NumberBoats+0.05*max(NumberBoats),label=NumberBoats)) +
  labs(y = "Commercially Hauled Boats",
       x = "Station") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p29

if(!interactive()) {
ggsave("Fig29_Commerically_Hauled_by_Station.jpg",p29)
}
```

### Map 8. Commercially Hauled Boat Source Locations

```{r map7_commercially_hauled_boat_sources}
sources_centroid = read_sf(paste0(my_opts$remote_spatial_data,'Projects/ZQMussels/',my.year,' IMDP Final Report/data/spatial/Inspections_by_source_centroid.gpkg'))

# Add some labelling logic:
# 1. If a given state/province/estado has no inspections, its name should be grey.
#    and it should have no dot.
sources_centroid = sources_centroid |> 
  mutate(map_label_colour = ifelse(is.na(CHInsp), 'grey', 'black'))

# TEST # 
sources_centroid = sources_centroid |> 
  mutate(jenks = list(BAMMtools::getJenksBreaks(CHInsp, k = 6))) |> 
  unnest_wider(jenks, names_sep = '_') |> 
  mutate(CHInsp_b = case_when(
    CHInsp <= jenks_2 ~ 1,
    CHInsp <= jenks_3 ~ 2,
    CHInsp <= jenks_4 ~ 3,
    CHInsp <= jenks_5 ~ 4,
    CHInsp <= jenks_6 ~ 5,
  )) |>
  mutate(bin_label = case_when(
    CHInsp_b == 1 ~ paste0(jenks_1, ' - ', jenks_2),
    CHInsp_b == 2 ~ paste0(jenks_2+1, ' - ', jenks_3),
    CHInsp_b == 3 ~ paste0(jenks_3+1, ' - ', jenks_4),
    CHInsp_b == 4 ~ paste0(jenks_4+1, ' - ', jenks_5),
    CHInsp_b == 5 ~ paste0(jenks_5+1, ' - ', jenks_6)
  )) |> 
  # mutate(CHInsp_b = factor(CHInsp_b, levels = c(1:5))) |> 
  arrange(CHInsp_b)

sources_centroid = st_set_geometry(sources_centroid, sources_centroid$geom)

# Remove rows for Mexican estados without inspections.
sources_centroid = sources_centroid |> 
  filter(!(NAME_0 == 'Mexico' & is.na(CHInsp)))

# TEST #
source_pal = leaflet::colorFactor(
  palette = 'Spectral',
  domain = sources_centroid$CHInsp_b,
  reverse = T
)

labels = unique(sources_centroid$bin_label)

# Split the centroid spatial object into 2: one with high risk inspections,
# and one without.
centr_with_dat = sources_centroid |> filter(!is.na(CHInsp_b))
centr_without_dat = sources_centroid |> filter(is.na(CHInsp_b))

# Add in colours as new column.
centr_with_dat = centr_with_dat |>
  mutate(my_colors = source_pal(CHInsp_b))

# map_8_tmap = tm_shape(northamerica_basemap, 
#                       bbox = northamerica_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Commercially \nHauled Inspections'),
#                 type = 'symbol',
#                 labels = unique(centr_with_dat$bin_label),
#                 col = unique(centr_with_dat$my_colors),
#                 size = log(unique(centr_with_dat$CHInsp_b)+1)) + 
#   tm_shape(centr_with_dat) + 
#     tm_symbols(col = "my_colors", 
#                palette = '-Spectral',
#                size = 'CHInsp_b',
#                legend.col.show = FALSE,
#                legend.size.show = FALSE,
#                title.col = '') +
#     tm_text("ABBR", auto.placement = 1, 
#             size = 0.75) +
#   # tm_shape(centr_without_dat) + 
#   #   tm_text("ABBR", col = 'grey', 
#   #           size = 0.8,
#   #           auto.placement = FALSE) +
#   #   tm_symbols(col = 'grey',
#   #              size = 0.1) + 
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('left','bottom'),
#             scale = 1.25)
# 
# map_8_tmap
legend_df_ch <- centr_with_dat |>
  sf::st_drop_geometry() |>
  dplyr::select(bin_label, my_colors, CHInsp_b) |>
  distinct()

map_8_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = north_america_stations_basemap_colour) +
  geom_sf(
    data = centr_with_dat,
    aes(fill = bin_label, size = CHInsp_b),
    shape = 21,
    color = "black",
    stroke = 0.2
  ) +
  geom_sf_text(
    data = centr_with_dat,
    aes(label = ABBR),
    size = 3,
    color = "black"
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Commercially\nHauled Inspections"),
    values = setNames(legend_df_ch$my_colors, legend_df_ch$bin_label),
    guide = guide_legend(
      override.aes = list(
        shape = 21,
        fill = legend_df_ch$my_colors,
        size = log(legend_df_ch$CHInsp_b + 1) + 1
      )
    )
  ) +
  scale_size_continuous(range = c(2, 6), guide = "none") +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.05, 0.05),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )

map_8_ggplot
if(!interactive()) {
# tmap_save(tm = map_8_tmap, filename = 'Map8_Commercially_Hauled_Watercraft_Sources.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = 'Map8_Commercially_Hauled_Watercraft_Sources.jpg',map_8_ggplot, width = 7.6, height = 6.4, dpi = 300)
}
```

```{r ais_passport_holder_summary}
dat |> 
  dplyr::count(Passport_Holder_Ind)
```

### Map 9. Lake Monitoring Plankton Sample Tows

```{r map8_lake_monitoring_figure}
if(my.year == 2022){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab Analysis/Final report and data/BC Veliger Sampling Inventory 2022_FinalReport.xlsx'))
}
if(my.year == 2023){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab results/BC Veliger Sampling Inventory 2023_11-20_Final Report.xlsx'))
}
if(my.year == 2024){
  lab_dat = read_excel(paste0(my_opts$zqm_operations_data_folder,'Lake Monitoring/',my.year,'/Lab results/Final report/BC Veliger Sampling Inventory 2024_FINAL REPORT.xlsx'))
}

lab_dat =  lab_dat |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, " \\(.*")) |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, "\\,.*")) |> 
  dplyr::mutate(Waterbody = stringr::str_remove_all(Waterbody, "\\'"))

lab_sf = lab_dat |> 
  dplyr::rename(
    lat = `Lat (Decimal degrees)`,
    lng = `Long (Decimal degrees)`
  ) |> 
  mutate(lat = as.numeric(lat),
         lng = as.numeric(lng)) |> 
  dplyr::filter(!is.na(lat)) |> 
  st_as_sf(coords = c("lng","lat"),
           crs = 4326)

# How many unique lakes were sampled?
paste0(length(lab_dat |> 
  dplyr::select(Waterbody) |> 
  st_drop_geometry() |> 
  mutate(Waterbody = str_squish(Waterbody)) |> 
  distinct() |> 
  pull(Waterbody)), " lakes sampled across the province.")

# And how many samples were taken?
print(paste0(nrow(lab_dat), " samples were taken."))

# hctf = read_excel(paste0(my_opts$base_dir,'04_Extra_Figures_and_Scripts/data/Appendix 1 for MoE report_2022 Draft.xlsx'))
# 
# hctf = hctf |> 
#   filter(!duplicated(Waterbody))

# # How many lakes were substrate sampled?
# paste0(length(hctf |> 
#                 filter(`# Substrate samplers` > 0,
#                        Waterbody != 'Total Samples') |> 
#                 dplyr::select(Waterbody) |> 
#                 mutate(Waterbody = str_squish(Waterbody)) |> 
#                 distinct() |> 
#                 pull(Waterbody)), " lakes substrate sampled across the province.")
# 
# hctf |> 
#   filter(`# Substrate samplers` > 0,
#          Waterbody != 'Total Samples') |> 
#   summarise(number_substrate_samplers = sum(`# Substrate samplers`))

if(my.year == 2024){
  lab_sf = lab_sf |> 
    dplyr::rename(`Type of plankton tow (Vertical or Horizontal)` = `Type of plankton tow (vertical or horizontal)`)
}
# Make excel sheet for updating final report appendix!
lab_sf |> 
  # Join the Natural Resource regions (n = 8) to the lakes.
  st_join(
    sf::read_sf(paste0(my_opts$remote_spatial_data,'shared_data_sets/FLNRO_Fishing_Boundaries.shp')) |>
      st_transform(crs = 4326) |> 
      dplyr::select(Region = REGION_N)
    ) |> 
  st_drop_geometry() |> 
  tidyr::separate_longer_delim(cols = `Type of plankton tow (Vertical or Horizontal)`, delim = ', ') |> 
  count(Waterbody,Region,`sampling group/agency`,`Type of plankton tow (Vertical or Horizontal)`,`Zebra/Quagga mussels veligers`) |> 
  dplyr::rename(`Sampling Group/Agency` = `sampling group/agency`) |> 
  dplyr::select(-n) |> 
  dplyr::select(-c(`Type of plankton tow (Vertical or Horizontal)`)) |> 
  mutate(Waterbody = str_squish(Waterbody)) |> 
  distinct() |> 
  filter(!is.na(Region)) |> 
  dplyr::group_by(Waterbody) |> 
  dplyr::summarise(Region = paste0(Region, collapse = ', '),
                   `Sampling Group/Agency` = paste0(`Sampling Group/Agency`, collapse = ', '),
                   `Zebra/Quagga mussels veligers` = paste0(`Zebra/Quagga mussels veligers`, collapse = ', ')) |> 
  openxlsx::write.xlsx(file = 'lake_monitoring_for_report_appendix.xlsx')

sampling_pal = leaflet::colorFactor(
  palette = 'Set3',
  domain = lab_sf$`sampling group/agency`
)

lab_sf = lab_sf |> 
  mutate(my_colors = sampling_pal(`sampling group/agency`))

# map_9_tmap = tm_shape(bc_stations_basemap_colour, bbox = bc_station_view) +
#     tm_rgb() + 
#   tm_add_legend(title = paste0(my.year,' Invasive \nMussel Lake Monitoring'),
#                 type = 'symbol',
#                 labels = unique(lab_sf$`sampling group/agency`),
#                 col = sampling_pal(unique(lab_sf$`sampling group/agency`))) + 
#   tm_shape(bc_bound) + 
#     tm_borders(col = 'grey', lwd = 2) + 
#   tm_shape(lab_sf) + 
#     tm_symbols(col = "my_colors",
#                title.col = '') +
#   tm_scale_bar() + 
#   tm_layout(legend.frame = 'black', 
#             legend.position = c('right','top'),
#             scale = 1.25)
# 
# map_9_tmap

legend_df_lab <- lab_sf |>
  sf::st_drop_geometry() |>
  dplyr::select(`sampling group/agency`, my_colors) |>
  distinct()

bc_stations_basemap_trimmed <- terra::trim(bc_stations_basemap_colour)
raster_bbox_df <- as.list(terra::ext(bc_stations_basemap_trimmed))

map_9_ggplot <- ggplot() +
  tidyterra::geom_spatraster_rgb(data = bc_stations_basemap_trimmed) +
  geom_sf(data = bc_bound, color = "grey", fill = NA, linewidth = 1) +
  geom_sf(
    data = lab_sf,
    aes(fill = `sampling group/agency`),
    shape = 21,
    color = "black",
    size = 3,
    stroke = 0.2
  ) +
  scale_fill_manual(
    name = paste0(my.year, " Invasive\nMussel Lake Monitoring"),
    values = setNames(legend_df_lab$my_colors, legend_df_lab$`sampling group/agency`)
  ) +
  coord_sf(
    xlim = c(raster_bbox_df$xmin, raster_bbox_df$xmax),
    ylim = c(raster_bbox_df$ymin, raster_bbox_df$ymax),
    expand = FALSE
  ) +
  ggspatial::annotation_scale(location = "bl") +
  ggthemes::theme_map() +
  theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"),
    legend.background = element_rect(
      fill = alpha("white", 0.7),
      color = "black"
    ),
    legend.key = element_blank()
  )
map_9_ggplot

if(!interactive()) {
  # tmap_save(tm = map_9_tmap, filename = 'Map9_Map_of_Lake_Sampling.jpg', width = 7.6, height = 6.4, dpi = 300)
  ggsave(filename = 'Map9_Map_of_Lake_Sampling.jpg',map_9_ggplot, width = 7.6, height = 6.4, dpi = 300)
} else {
  # tmap_save(tm = map_9_tmap, filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024.jpg", width = 7.6, height = 6.4, dpi = 300)
}

if(interactive()){
library(basemaps)

lab_sf_b = st_buffer(lab_sf,3000)

my_ext = lab_sf |> st_combine() |> st_bbox() |> st_as_sfc() |> 
  st_buffer(10000)

sat_basemap = basemap_terra(ext = my_ext, 'esri', 'world_ocean_base')

yellow_basemap = basemap_terra(ext = my_ext, 'esri', 'world_street_map')

inset_bc = ggplot() + 
  geom_sf(data = bc_bound |> 
            st_transform(3005)) + 
  geom_sf(data = my_ext, col = 'red', fill = 'transparent') +
  ggthemes::theme_map()

library(patchwork)

sat_plot = ggplot() + 
  tidyterra::geom_spatraster_rgb(data = sat_basemap) +
  geom_sf(data = lab_sf_b, aes(fill = `sampling group/agency`)) +
  scale_fill_brewer(palette = "Set3") + 
  ggspatial::annotation_scale() +
  labs(fill = "Sampling \nGroup/Agency",
       title = "2024 Invasive Mussel Lake Monitoring") +
  theme(plot.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.background = element_blank())

sat_plot = sat_plot + 
  inset_element(inset_bc, left = 0.8, top = 0.95, right = 0.95, bottom = 0.8)

# ggsave(filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024_Satellite_Background.jpg", width = 10, height = 8,
#        plot = sat_plot)

yellow_streets_plot = ggplot() + 
  tidyterra::geom_spatraster_rgb(data = yellow_basemap) +
  geom_sf(data = lab_sf_b, aes(fill = `sampling group/agency`)) +
  scale_fill_brewer(palette = "Set3") + 
  labs(fill = "Sampling \nGroup/Agency",
       title = "2024 Invasive Mussel Lake Monitoring") +
  ggspatial::annotation_scale() +
  theme(plot.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.background = element_blank())

yellow_streets_plot = yellow_streets_plot + 
  inset_element(inset_bc, left = 0.8, top = 0.95, right = 0.95, bottom = 0.8)

# ggsave(filename = "C:/Users/CMADSEN/Downloads/Map_of_Lake_Sampling_2024_Streets_Background.jpg", width = 10, height = 8,
#        plot = yellow_streets_plot)
}
```

### Figure 30 
```{r fig30_CBSA_Notifications}
if(exists("cbsa_dat")){
cbsa_dat = cbsa_dat |> 
  filter(!is.na(Categories)) |> 
  mutate(Categories = str_to_upper(Categories)) |> 
  mutate(Categories = str_remove_all(Categories, " -")) |> 
  mutate(Subtype = str_extract(Categories, "(?<=CBSA ).*")) |> 
  mutate(Categories = str_remove_all(Categories, "(?<=CBSA).*")) |> 
  mutate(Year = my.year) |> 
  mutate(Categories = case_when(
    Categories %in% c("NEW BOATS","NEW BOAT SHIPMENT") ~ "NEW BOATS",
    str_detect(Categories, "INVASIVE SPECIES") ~ "ISCBC",
    T ~ Categories
  )) |> 
  mutate(Subtype = coalesce(Subtype, Categories)) |> 
  mutate(Categories = case_when(
    Categories %in% c("USA","US","US STATE","ID","MT") ~ "USA",
    Categories %in% c("AB","SK","MB") ~ "PROVINCES",
    T ~ Categories
  )) |> 
  count(Categories, Subtype, sort = T)

p30 = cbsa_dat |> 
  group_by(Categories) |> 
  summarise(group_n = sum(n)) |>
  ungroup() |> 
  arrange(group_n) |> 
  mutate(Categories = fct_inorder(Categories)) |> 
  ggplot() + 
  geom_col(aes(group_n, Categories, fill = Categories), col = "black") + 
  geom_text(aes(group_n/2, Categories, label = group_n), size = 5) +
  theme_light() +
  theme(text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(y = "", x = "Number of Notifications",
       title = "CBSA Notification Categories",
       subtitle = my.year)

p30

if(!interactive()) {
ggsave("Fig30_Percent_Previous_Knowledge.jpg",p30)
}
}
```

### Figure 32 Previous Knowledge

```{r fig32_previous_knowledge}
#Remove Penticton Roving
fig32_dat = dat |> 
  filter(!Station %in% rovers_to_drop) |> 
  group_by(Station, Previous_AIS_Knowledge_Ind) |>
  summarise(Number = n()) |> 
  mutate(TotalPerStation = sum(Number)) |> 
  mutate(Diff = case_when(
    row_number() %% 2 != 0 ~ Number-lead(Number),
    row_number() %% 2 == 0 ~ -Number + lag(Number))) |>
  mutate(Diff = 100*Diff/TotalPerStation) |> 
  arrange(Diff) |> 
  ungroup() |> 
  filter(Previous_AIS_Knowledge_Ind == T) |> 
  left_join(station_types) |> 
  left_join(station_types) |> 
  mutate(StationLabel = ifelse(StationType == "Roving",paste0(Station,"*"),Station)) |> 
  mutate(StationLabel = fct_inorder(StationLabel)) |> 
  ungroup() |> 
  mutate(prop = 100*Number/TotalPerStation) |> 
  mutate(StationType_T = paste0(StationType, Previous_AIS_Knowledge_Ind))
  
fig32_dat |> 
  dplyr::reframe(TotalPerStation = sum(TotalPerStation),
                 Number = sum(Number)) |> 
  dplyr::mutate(perc_with_prev_AIS_knowledge = 100*Number / TotalPerStation) |> 
  knitr::kable()
#Add in dummys for FALSE of Previous_AIS_Knowledge_Ind to make backdrop of plot.
fig32_dat = fig32_dat |> 
  filter(Station %in% stations.to.include) |> 
  mutate(prop_queda = 100-prop) |> 
  pivot_longer(cols = c(prop, prop_queda), names_to = "Prop_type",values_to = "prop") |> 
  mutate(Previous_AIS_Knowledge_Ind = replace(Previous_AIS_Knowledge_Ind, Prop_type == "prop_queda", "FALSE")) |> arrange(desc(Previous_AIS_Knowledge_Ind), Station)

fig32_dat |> 
  dplyr::select(Station,Number,TotalPerStation,prop) |> 
  dplyr::arrange(desc(prop)) |> 
  knitr::kable()

p32 = ggplot() + 
  geom_col(data = fig32_dat,
           aes(x=StationLabel,y=prop,fill = Previous_AIS_Knowledge_Ind),
           col = "black", width = 0.4) + 
  labs(y = "Percent Previous Knowledge",fill = "",
       x = 'Station') + 
  theme_classic() +
  scale_fill_manual(breaks = c("TRUE","FALSE"),
                    values = c("TRUE" = my.grey,
                               "FALSE" = "grey"),
                    labels = c("Yes","No")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))
  
p32

if(!interactive()) {
ggsave(paste0(my.external.output.folder,"/GIS Maps and Excel Figures/ExcelFigures/Fig32_Percent_Previous_Knowledge.jpg"),p32,
       width = 8, height = 4, dpi = 300)
}
```

### Figure 33 Primary Sources of Previous Knowledge

```{r fig33_primary_sources_previous_knowledge}

# To see the proportions of each type:
dat |> 
    rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) |> 
    #Join the lookup table for previous AIS knowledge
    left_join(ais_know |> 
                  rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) |> 
                  mutate(ais_know_id = as.character(ais_know_id)) |> 
                  select(Description, ais_know_id)) |> 
    #Only keep records that have some kind of previous AIS knowledge.
    filter(!is.na(Description)) |> dplyr::count(Description) |> dplyr::mutate(prop = 100*n / sum(n)) |> 
  knitr::kable()

p33 = dat |> 
  rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) |> 
  #Join the lookup table for previous AIS knowledge
  left_join(ais_know |> 
              rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) |> 
              mutate(ais_know_id = as.character(ais_know_id)) |> 
              select(Description, ais_know_id)) |> 
  #Only keep records that have some kind of previous AIS knowledge.
  filter(!is.na(Description)) |> 
  # Amalgamate Previous Inspections outside BC into one group.
  mutate(Description = case_when(
    Description == 'Previous Inspection (other)' ~ Description,
    Description == 'Previous Inspection in AB' ~ 'Previous Inspection (other)',
    T ~ Description
  )) |> 
  #Get the number of records for each knowledge source
  group_by(Description) |> 
  summarise(Number = n()) |> 
  #Calculate the percentage for each knowledge source
  mutate(Total = sum(Number)) |> 
  mutate(prop = 100*Number/Total) |> 
  #Put all knowledge sources below 1% into a single category called 'Other', label the groups for all knowledge sources >= 1% with their descriptions.
  mutate(Grouper = case_when(
    prop >= 1 ~ Description,
    T ~ "Other"
  )) |> 
  #Add together proportions within each of these groups. This combines the "Other" group.
  group_by(Grouper) |> 
  summarise(prop = sum(prop)) |> 
  arrange(desc(Grouper)) |> 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) |> 
  ggplot(aes(x = "", y = prop, 
           fill = Grouper)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(round(prop,0), "%")),
                   size = 4.5, nudge_x = 0.2) +
  #geom_text(aes(y = lab.ypos, label = paste0(Grouper,", ",round(prop,0),"%")), 
#            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Knowledge Source") +
  scale_fill_brewer(palette = "Dark2")

p33

if(!interactive()) {
ggsave("Fig33_Primary_Sources_Previous_AIS_Knowledge.jpg",p33)
}
```

```{r number_nonmotorized_non_compliers}
print('Blowby Info')
dat |> filter(Year == my.year) |> 
  mutate(all_boats = n()) |> 
  dplyr::select(Shift_ID,
                all_boats,
                Motorized_Blow_Bys_Counter,
                Non_Motorized_Blow_Bys_Counter) |> 
  distinct() |> 
  group_by(all_boats) |> 
  summarise(total_motorized_blowbys = sum(as.numeric(Motorized_Blow_Bys_Counter)),
         total_non_motorized_blowbys = sum(as.numeric(Non_Motorized_Blow_Bys_Counter)))
```

```{r previous_CDD_AIS_knowledge_numbers}

print('What percentage of inspections had previous knowledge of AIS / CDD?')

( nrow(dat |> filter(Previous_AIS_Knowledge_Ind == T)) ) /
  ( nrow(dat) )

print('And which sources of knowledge were most salient?')
dat |> 
  count(Previous_AIS_Knowledge_Source_Code_ID, sort = T) |> 
  mutate(Previous_AIS_Knowledge_Source_Code_ID = as.numeric(Previous_AIS_Knowledge_Source_Code_ID, sort = T)) |> 
  left_join(ais_know |> select(Previous_AIS_Knowledge_Source_Code_ID = `Previous Ais Knowledge Source Code ID`,
                                Description)) |> 
  knitr::kable()
  
```

```{r calculation_of_boat_types}

print("Breakdown of boats by complexity")
dat |> summarise(across(ends_with('_Counter'), as.numeric)) |> summarise(across(ends_with('_Counter'), sum)) |> 
  pivot_longer(cols = everything()) |> 
  filter(!str_detect(name, '_Bys_')) |> 
  mutate(percentage = 100*value/sum(value)) |> 
  knitr::kable()

print("Of HR boats, how many were complex?")
dat |> 
  filter(High_Risk_AIS_Ind == T) |> 
  mutate(Complex_Counter = replace(Complex_Counter, Complex_Counter != '0', '1')) |> 
  count(Complex_Counter) |> 
  mutate(percentage = 100*n/sum(n))

print("Of HR boats, how many were very complex?")
dat |> 
  filter(High_Risk_AIS_Ind == T) |> 
  count(Very_Complex_Counter) |> 
  mutate(percentage = 100*n/sum(n))
```

